<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cactus Ed's Happy Place</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0014; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none; }
    canvas { display: block; image-rendering: pixelated; touch-action: none; }
  </style>
</head>
<body>
<script>
// ════════════════════════════════════════════════════════════════
// CACTUS ED'S HAPPY PLACE — V1.2 "THE LEGENDARY UPDATE"
// Zone 2: Data & Constants
// ════════════════════════════════════════════════════════════════

var AT = {
  sky:'#7ec8e3', skyDark:'#4a9bb5',
  grass:'#8ac926', grassDark:'#5a8c1a',
  dirt:'#c97d4e', dirtDark:'#8b5028',
  outline:'#2d1b00',
  skinEd:'#3d6b34', skinEdDk:'#2a4d24', spineEd:'#f5f0dc',
  cigTip:'#ff6b35', cigBody:'#d4c8a0',
  busYellow:'#ffd60a', busPurple:'#7b2d8b', busCream:'#fff9e6',
  mochiFg:'#f4a8c7', mochiFg2:'#ffb3d6', mochiRim:'#cc5599',
  aloe:'#00e676', aloeDk:'#00a854',
  uiBg:'#1a0a2e', uiPanel:'#2d1254',
  uiText:'#f5f0dc', uiGold:'#ffd60a', uiRed:'#ff4444',
  catA:'#ff9f43', catB:'#dfe6e9', catC:'#2d3436', catD:'#fdcb6e',
  purple:'#9b59b6', purpleDk:'#6c3483',
  pink:'#fd79a8', pinkDk:'#e84393',
  neon1:'#ff00ff', neon2:'#00ffff', neon3:'#cc44ff',
  night:'#0a001e', nightSky:'#050010',
  orange:'#ff7c00', sunset:'#ff4500'
};

var EWR_STATE = {
  aloe:200, world:1,
  levelsBeaten:[], secrets:{},
  playerPos:{x:5,y:5},
  coopMode:false,
  health:[3,3], maxHealth:[3,3],
  catsPetted:0, fightWins:0, healFraction:0,
  // V1.2 new
  combo:{streak:0,mult:1,timer:0},
  shop:{doubleJump:false,speedBoost:false,explosiveCig:false,crtFilter:false,lifeSteal:false,aloeMagnet:false},
  secretBeaten:{}
};

var ED_MOVE = {
  walkSpeed:140, jumpVel:-520,
  jumpCut:0.4, airControl:0.75,
  coyoteMs:90, jumpBufMs:130,
  maxFall:700,
  punchRange:56, kickRange:72
};

var ALOE = {
  start:200, beat11:50, beat12:80, beat13:60, beat14:80, beat15:300,
  secretFind:20, catPet:5, fightWin:40,
  mochiDeath:8, aloePickup:15, raceEntryFee:25,
  tankDeath:20, daikonDeath:16, throwerDeath:18, bossHit:12, voidBeat:200,
  beat21:100, beat22:120, beat23:500, ghostDeath:14, bomberDeath:25,
  rastaDeath:18, beat24:150
};

var CAT_NAMES = [
  'Chairman Whiskers','Big Loan Whiskers','Professor Fluffmore',
  'Mittens','The Duchess','Senor Biscuit','Lord Fuzzybutt',
  'Detective Naps','DJ Meowsworth','Captain Kibble',
  'Dr. Purrlington','Bartholomew','Madame Paws','Sir Hissworth',
  'Countess Flop','Agent Tuna','The Honorable Sniff',
  'Lieutenant Noodle','Papa Scratch','Reverend Fluff',
  'Emperor Cig','Ras Fluffington','The Honorable Ganj','Baron Von Smoke'
];

var NEWS_TICKER = [
  'BREAKING: CAT NATIONS EXCHANGE NUCLEAR WARHEADS / BACKGROUND FOOTAGE AT 11 / MARKET UNAFFECTED',
  'RASTA CAT COALITION REJECTS CIG DEAL: "WE WANT THE GANJ NOT THE CIG" / TALKS COLLAPSE',
  'ALOE REACHES NEW ALL-TIME HIGH / ANALYSTS CONFIRM: 1 ALOE = 1 ALOE / EXPERTS DISAGREE',
  'ED\'S CIGARETTE EMPIRE EXPANDS TO THE MOON / ASTRONAUT CATS REPORT HIGH SATISFACTION',
  'MOCHI GOVERNMENT DECLARES TOTAL WAR ON CIGARETTES / "CATS MUST NOT SMOKE" / CATS DISAGREE',
  'BREAKING: SECOND NUCLEAR EXCHANGE TODAY / CATS FINE / DAIKON: NOT FINE',
  'ECONOMIST EXPLAINS ALOE: "IT\'S LIKE BITCOIN BUT REAL AND ALSO NOT REAL" / INVESTORS CONFUSED',
  'THE GREAT CAT CIG PARADE CONFIRMED / ROUTE: WEST BOTTOMS TO THE VOID / CIGS PROVIDED',
  'DAIKON LORD DEFEATED FOR SEVENTH TIME THIS WEEK / STILL A DAIKON / STILL A LORD',
  'VOID SCIENTISTS DISCOVER NOTHING / PUBLISH PAPER ON IT / PAPER WINS AWARD',
  'ED NAMED BUSINESSMAN OF THE YEAR / "I JUST SELL CIGS TO CATS" -- ED / CATS UNAVAILABLE',
  'RASTA MOVEMENT GROWS: 40% OF CATS NOW REFUSE CIGARETTES / ED CALLS THIS A WIN',
  'MOCHI CRIME SYNDICATE EXPOSED: ANTI-CIG TERROR CELL IN DAIKON DISTRICT / ALOE SOARS',
  'NUCLEAR CAT STANDOFF ENTERS DAY 400 / NOBODY KNOWS WHAT THEY ARE FIGHTING ABOUT',
  'BREAKING: IS GOD A MUSHROOM CLOUD? / LOCAL RASTA SAYS YES / MOCHI: NO COMMENT',
  'WEST BOTTOMS CATS PETITION FOR MORE CIGS / ED PERSONALLY DELIVERS ANYWAY',
  'NEON DISTRICT NOW OFFICIAL CITY / POPULATION: GHOSTS AND BOMBERS / MAYOR: NEON KING (DECEASED)',
  'ALOE MARKET CRASHES / RECOVERS / CRASHES AGAIN / ALOE',
  'THE VOID OPENS ADDITIONAL LOCATION IN DOWNTOWN / HOURS: ALWAYS / ADMISSION: YOUR WILL TO LIVE',
  'BREAKING: EVERYTHING CONTINUES / MORE AT 11 / 11 IS ALSO CONTINUING'
];

var BEAT_CAT_LINES = [
  '"do you know where cigarettes go when they die?"',
  '"my dad invested all our aloe. we live in the void now."',
  '"what does it feel like to make something that kills cats?"',
  '"if mochi wins, will there still be cigs?"',
  '"i asked my teacher about nuclear war and she said soon"',
  '"ed, do you ever think about the cats who coughed?"',
  '"the news said another country got nuked. they had cats there too."',
  '"aloe used to be worth something my mom says"',
  '"is there a god in west bottoms or just mochi"',
  '"you smell like a cig that knows it\'s dying but doesn\'t care"',
  '"what happens when there are no more cats to sell to"',
  '"the rasta cats seem very calm about everything"',
  '"i saw the void once. it looked back."',
  '"my friend says mochi is right. i don\'t know."',
  '"do you ever just. stop."'
];

var CAT_COLORS = [
  {body:AT.catA, belly:'#ffcc88', outline:AT.outline},
  {body:AT.catB, belly:'#ffffff', outline:'#888888'},
  {body:AT.catC, belly:'#444444', outline:'#111111'},
  {body:AT.catD, belly:'#fff0cc', outline:AT.outline}
];

// World 1 Map — row 4 pos 8 changed to 'V' (The Void secret level)
var W1_ROWS = [
  'MMMMMMMMMMMMMMMM',
  'M   M    T  5 MM',
  'M G  G  GT  P MM',
  'M GG G  GPPP4 MM',
  'M GGC G2VP  CP!M',
  'M P  1P P3P   MM',
  'M P  GPPPP    MM',
  'M PP  GG PPCG MM',
  'M  G   GG G   MM',
  'MMMMMMMMMMMMMMMM'
];

var W1_TILES = {
  ' ':{type:'empty',   passable:true},
  'G':{type:'grass',   passable:true},
  'P':{type:'path',    passable:true},
  'M':{type:'mountain',passable:false},
  'W':{type:'water',   passable:false},
  'T':{type:'tree',    passable:false},
  '1':{type:'level',   passable:true, id:'1-1', label:'Ed Wakes Up'},
  '2':{type:'level',   passable:true, id:'1-2', label:'The Cat Rave'},
  '3':{type:'level',   passable:true, id:'1-3', label:'Daikon District'},
  '4':{type:'level',   passable:true, id:'1-4', label:'Hippie Bus Highway'},
  '5':{type:'level',   passable:true, id:'1-5', label:'Mochi HQ'},
  'V':{type:'level',   passable:true, id:'1-V', label:'THE VOID'},
  'C':{type:'catspot', passable:true},
  '!':{type:'portal',  passable:true, id:'portal-W2', label:'THE NEON DISTRICT'}
};

var WS_TEXTS = [
  'CONSUME','ARE YOU REAL?','DO YOU FEEL?',
  'BIRTH SCHOOL WORK DEATH','YOU ARE PRODUCT',
  'LOOK AWAY','CACTUS MOMENT','THIS IS FINE',
  'REALITY IS OPTIONAL','ED WAS RIGHT',
  'STAY WEIRD','NOTHING IS REAL','YOU CANNOT LEAVE',
  'ALOE FOREVER','WHAT YEAR IS IT','THE MOCHIS KNOW',
  'DO NOT LOOK DOWN','CAT IS GOD','EMBRACE THE VOID',
  'ED APPROVES OF NOTHING',
  'ALOE IS BITCOIN IS ALOE','CATS SMOKE THEREFORE CATS ARE',
  'NUCLEAR WAR IS JUST WEATHER','RASTA CATS KNOW SOMETHING',
  'THE CIG IS MIGHTIER THAN THE SWORD','SELL THE CIG BUY THE CIG BE THE CIG',
  'GOD SMOKES','MOCHI HATES YOU FOR YOUR FREEDOM',
  'THE PARADE NEVER ENDS','ED HAS ALWAYS BEEN SELLING','EVERYTHING IS ALOE'
];

var ED_LINES = [
  '...','classic','leave me alone',"i don't care",
  'sure','whatever','noted','no','fine','obviously','ok',
  'hmm','unbelievable','of course','as expected',
  'what','yeah no','sure sure','i guess','cool cool cool','ok but why',
  'you want a cig','buy or dont','cats need cigs',
  'the price is the price','aloe only','this is business',
  'do not question the cig','i have more in the back'
];

var VOID_KOANS = [
  'WHAT IS ALOE IF NOT GRIEF PERSEVERING?',
  'YOU WERE ALWAYS HERE',
  'THE CIGARETTE IS THE MEANING',
  'ED. ED. ED.',
  'MOCHI WAS NEVER YOUR ENEMY',
  'CONSUME THE SELF',
  'FALLING IS JUST FLYING BADLY',
  'THIS BOSS IS OPTIONAL',
  'EVERY MOCHI IS YOU',
  'WHY WOULD YOU COME HERE',
  'THE ALOE WAS INSIDE YOU ALL ALONG',
  'THERE IS NO LEVEL 1-6',
  'YOU CANNOT UNSEE THIS',
  'GOD IS A MUSHROOM CLOUD',
  'DEATH IS THE ORIGINAL CIG',
  'WHAT GOD WANTS GOD GETS AND GOD WANTS NOTHING',
  'NUCLEAR WINTER IS JUST WINTER WITH MORE CONVICTION',
  'THE BOMB IS JUST A BIG CIG',
  'PARADISE IS REAL AND ALSO ON FIRE',
  'YOU BOUGHT THE CIG. THE CIG OWNS YOU NOW.',
  'THERE IS NO WAR IN ALOE DISTRICT',
  'THE RASTA CAT WAS RIGHT'
];

// ── PARTICLES ────────────────────────────────────────────────────

var SMOKE_POOL = [];
function spawnSmoke(x,y) {
  SMOKE_POOL.push({x:x+(Math.random()-0.5)*6,y:y,vx:(Math.random()-0.5)*0.8,vy:-0.6-Math.random()*0.4,life:1.0,r:3+Math.random()*3});
}
function updateSmoke() {
  for (var i=SMOKE_POOL.length-1;i>=0;i--) {
    var p=SMOKE_POOL[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.022;
    if (p.life<=0) SMOKE_POOL.splice(i,1);
  }
}

var EX_POOL = [];
function spawnExplosion(x,y,color,size) {
  size=size||1;
  var cnt=Math.floor(8*size);
  var c1=color||0xff6b35, c2=color?color:0xffd60a, c3=color?color:0xff4444;
  var cols=[c1,c2,c3,0xffffff];
  for (var i=0;i<cnt;i++) {
    var a=(i/cnt)*Math.PI*2+Math.random()*0.5;
    var spd=(1.5+Math.random()*3)*size;
    EX_POOL.push({x:x,y:y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-size*0.8,
      life:1.0,r:(2+Math.random()*3)*size,color:cols[i%cols.length]});
  }
}
function updateExplosions() {
  for (var i=EX_POOL.length-1;i>=0;i--) {
    var p=EX_POOL[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.22; p.life-=0.038;
    if (p.life<=0) EX_POOL.splice(i,1);
  }
}
function drawExplosions(g) {
  for (var i=0;i<EX_POOL.length;i++) {
    var p=EX_POOL[i];
    g.fillStyle(p.color, p.life*0.9);
    g.fillCircle(p.x, p.y, p.r*p.life+1);
  }
}

// Fire particles (on-fire combo effect)
var FIRE_POOL = [];
function spawnFire(x,y) {
  FIRE_POOL.push({x:x+(Math.random()-0.5)*16,y:y-Math.random()*10,vx:(Math.random()-0.5)*1.2,vy:-1.0-Math.random()*0.8,life:1.0,r:3+Math.random()*5,color:Math.random()<0.5?0xff6b00:0xffcc00});
}
function updateFire() {
  for (var i=FIRE_POOL.length-1;i>=0;i--) {
    var p=FIRE_POOL[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.042;
    if (p.life<=0) FIRE_POOL.splice(i,1);
  }
}
function drawFire(g) {
  for (var i=0;i<FIRE_POOL.length;i++) {
    var p=FIRE_POOL[i];
    g.fillStyle(p.color, p.life*0.75);
    g.fillCircle(p.x, p.y, p.r*p.life+1);
  }
}

// Nuclear mushroom cloud pool
var NUKE_POOL = [];
function spawnNuke() {
  NUKE_POOL.push({x:80+Math.random()*800, t:0, maxT:4000});
}
function updateNukes(delta) {
  for (var i=NUKE_POOL.length-1;i>=0;i--) {
    NUKE_POOL[i].t+=delta;
    if (NUKE_POOL[i].t>=NUKE_POOL[i].maxT) NUKE_POOL.splice(i,1);
  }
}
function drawNukes(g) {
  for (var i=0;i<NUKE_POOL.length;i++) {
    var n=NUKE_POOL[i];
    var prog=n.t/n.maxT; // 0..1
    // fade: in 0..0.15, hold 0.15..0.75, out 0.75..1
    var al=prog<0.15?(prog/0.15):prog<0.75?1.0:((1.0-prog)/0.25);
    al=Math.max(0,Math.min(1,al));
    var stemH=Math.min(160,prog*1200);
    var capR=Math.min(55,prog*400);
    var bx=n.x, by=496; // screen bottom anchor
    // glow base
    g.fillStyle(0xffaa00, al*0.18);
    g.fillCircle(bx, by, capR*1.8);
    // stem
    g.fillStyle(0xff6b35, al*0.85);
    g.fillRect(bx-8, by-stemH, 16, stemH);
    // stem inner
    g.fillStyle(0xffcc88, al*0.6);
    g.fillRect(bx-4, by-stemH, 8, stemH);
    // cap ellipse
    g.fillStyle(0xff4400, al*0.9);
    g.fillEllipse(bx, by-stemH, capR*2, capR*0.85);
    // cap highlight
    g.fillStyle(0xffdd44, al*0.5);
    g.fillEllipse(bx-capR*0.25, by-stemH-capR*0.15, capR*0.9, capR*0.45);
  }
}

// ── SOUND MODULE (Web Audio API — zero assets) ───────────────────
var SOUND = (function(){
  var ctx = null;
  function _init(){
    if(!ctx) try { ctx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){}
  }
  function _tone(type, f, f2, dur, vol, delay){
    if(!ctx) return;
    try {
      var osc=ctx.createOscillator(), gn=ctx.createGain();
      osc.connect(gn); gn.connect(ctx.destination);
      osc.type=type||'square';
      var t=ctx.currentTime+(delay||0);
      osc.frequency.setValueAtTime(f, t);
      if(f2) osc.frequency.exponentialRampToValueAtTime(Math.max(1,f2), t+dur);
      gn.gain.setValueAtTime(vol||0.18, t);
      gn.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      osc.start(t); osc.stop(t+dur);
    } catch(e){}
  }
  return {
    init: _init,
    punch:   function(){ _tone('square',320,80,0.08,0.22); },
    kick:    function(){ _tone('square',160,50,0.12,0.28); },
    jump:    function(){ _tone('sine',200,500,0.14,0.15); },
    hurt:    function(){ _tone('sawtooth',440,80,0.3,0.3); },
    pickup:  function(){ _tone('sine',330,330,0.07,0.18); _tone('sine',660,660,0.08,0.18,0.14); },
    death:   function(){ _tone('sawtooth',440,55,0.9,0.35); },
    bossHit: function(){ _tone('square',60,30,0.25,0.35); },
    victory: function(){
      var notes=[262,330,392,523,659];
      for(var i=0;i<notes.length;i++){
        (function(nn,dd){ setTimeout(function(){ _tone('square',nn,nn,0.12,0.2); },dd); })(notes[i],i*100);
      }
    },
    charge: function(){ _tone('square',200,260,0.05,0.10); },
    blast:  function(){ _tone('sawtooth',120,40,0.25,0.6); }
  };
})();

// Combo helper — call after each hit
function _addCombo(scene, x, y) {
  var c = EWR_STATE.combo;
  c.streak++;
  c.timer = 3500;
  c.mult = c.streak>=10 ? 3 : c.streak>=6 ? 2 : c.streak>=3 ? 1.5 : 1;
  if(c.streak===3) { scene._flash('x1.5 COMBO!',1200); }
  if(c.streak===6) { scene._flash('x2 COMBO!!',1200); SOUND.pickup(); }
  if(c.streak===10){ scene._flash('x3 ON FIRE!!!',1500); if(scene.cameras) scene.cameras.main.shake(200,0.01); SOUND.victory(); }
  // Float text near hit
  try {
    var ft=scene.add.text(x,y-28,c.streak+' HIT!',{fontFamily:'Courier New,monospace',fontSize:'16px',color:'#ffd60a',stroke:'#000000',strokeThickness:3}).setDepth(25);
    scene.tweens.add({targets:ft,y:y-70,alpha:0,duration:900,onComplete:function(){ft.destroy();}});
  } catch(e){}
}

// ════════════════════════════════════════════════════════════════
// SHARED DRAW FUNCTIONS
// ════════════════════════════════════════════════════════════════

// frame: 0=idle,1-3=walk,4=jump,5=punch(lance),6=kick,7=hurt
var DRAW_ED = {
  draw: function(g, x, y, frame, flipped, cigF) {
    frame=frame||0; cigF=cigF||0;
    var sx=flipped?-1:1;
    g.save(); g.translateCanvas(x,y); g.scaleCanvas(sx,1);

    // Shadow
    g.fillStyle(0x000000,0.2); g.fillEllipse(0,2,34,10);

    // Body outline (thick AT style)
    g.fillStyle(parseInt(AT.outline.slice(1),16),1);
    g.fillRoundedRect(-19,-46,38,44,9);
    // Body dark
    g.fillStyle(parseInt(AT.skinEdDk.slice(1),16),1);
    g.fillRoundedRect(-17,-44,34,40,8);
    // Body highlight
    g.fillStyle(parseInt(AT.skinEd.slice(1),16),1);
    g.fillRoundedRect(-10,-44,20,40,7);
    // Belly
    g.fillStyle(parseInt(AT.skinEd.slice(1),16),0.4);
    g.fillRoundedRect(-7,-37,14,28,5);

    // Left arm
    var laY=(frame===5||frame===6)?-33:-35;
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(-30,laY,15,11,4);
    g.fillStyle(parseInt(AT.skinEd.slice(1),16),1);  g.fillRoundedRect(-29,laY+1,13,9,3);
    g.fillStyle(parseInt(AT.spineEd.slice(1),16),1);
    g.fillRect(-32,laY+2,3,2); g.fillRect(-31,laY+5,3,2); g.fillRect(-32,laY+8,3,2);

    // Right arm
    var raY=(frame===1||frame===3)?-32:-35;
    if (frame===5) raY=-29;
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(15,raY,15,11,4);
    g.fillStyle(parseInt(AT.skinEd.slice(1),16),1);  g.fillRoundedRect(16,raY+1,13,9,3);
    g.fillStyle(parseInt(AT.spineEd.slice(1),16),1);
    g.fillRect(29,raY+2,3,2); g.fillRect(29,raY+5,3,2); g.fillRect(28,raY+8,3,2);

    // Top spines
    g.fillStyle(parseInt(AT.spineEd.slice(1),16),1);
    g.fillRect(-4,-51,2,7); g.fillRect(0,-54,2,9); g.fillRect(4,-51,2,7);

    // Sunglasses (or X-eyes when hurt)
    var eyeY=-33;
    if (frame===7) {
      g.lineStyle(3,0xff4444,1);
      g.lineBetween(-10,eyeY-3,-5,eyeY+2); g.lineBetween(-5,eyeY-3,-10,eyeY+2);
      g.lineBetween(4,eyeY-3,9,eyeY+2);    g.lineBetween(9,eyeY-3,4,eyeY+2);
    } else {
      g.fillStyle(parseInt(AT.uiGold.slice(1),16),0.95);
      g.fillRoundedRect(-12,eyeY-4,10,7,2); g.fillRoundedRect(2,eyeY-4,10,7,2);
      g.fillStyle(0x111111,0.95);
      g.fillRoundedRect(-11,eyeY-3,8,5,2); g.fillRoundedRect(3,eyeY-3,8,5,2);
      g.fillStyle(0xffffff,0.22);
      g.fillRect(-10,eyeY-2,3,2); g.fillRect(4,eyeY-2,3,2);
      g.lineStyle(1,parseInt(AT.uiGold.slice(1),16),0.5);
      g.lineBetween(-1,eyeY-1,2,eyeY-1);
    }

    // Aloof mouth
    g.lineStyle(2,parseInt(AT.outline.slice(1),16),0.7);
    if (frame===7) { g.lineBetween(-5,-26,5,-28); }
    else           { g.lineBetween(-5,-27,5,-27); }

    // Cigarette (lance in frame 5)
    var cigY=-27+Math.sin(cigF*0.08)*1.5;
    if (frame===5) {
      g.fillStyle(parseInt(AT.cigBody.slice(1),16),1); g.fillRect(14,cigY-1,44,4);
      g.fillStyle(parseInt(AT.cigTip.slice(1),16),1);  g.fillCircle(58,cigY+1,5);
      g.fillStyle(0xffaa00,0.9);                       g.fillCircle(58,cigY+1,3);
      g.fillStyle(0xffffff,0.5);                       g.fillCircle(58,cigY+1,1.5);
    } else {
      g.fillStyle(parseInt(AT.cigBody.slice(1),16),1); g.fillRect(14,cigY,14,3);
      g.fillStyle(parseInt(AT.cigTip.slice(1),16),1);  g.fillCircle(28,cigY+1,3);
      g.fillStyle(0xffaa00,0.7);                       g.fillCircle(28,cigY+1,1.8);
    }

    // Legs
    if (frame===6) {
      g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRect(-12,-5,9,7);
      g.fillStyle(parseInt(AT.skinEdDk.slice(1),16),1); g.fillRect(-11,-4,7,5);
      g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRect(3,-7,28,10);
      g.fillStyle(parseInt(AT.skinEdDk.slice(1),16),1); g.fillRect(4,-6,26,8);
      g.lineStyle(2,0xffffff,0.5);
      g.lineBetween(2,-9,11,-12); g.lineBetween(2,-5,9,-7); g.lineBetween(2,-1,11,1);
    } else {
      var legOff=(frame===1)?4:(frame===3)?-4:0;
      g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRect(-12,-5,9,7);
      g.fillStyle(parseInt(AT.skinEdDk.slice(1),16),1); g.fillRect(-11,-4,7,5);
      g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRect(3,-5+legOff,9,7);
      g.fillStyle(parseInt(AT.skinEdDk.slice(1),16),1); g.fillRect(4,-4+legOff,7,5);
    }

    g.restore();
  }
};

// dance: arms raised + body bob. smoker: tiny cig at mouth.
var DRAW_CAT = {
  draw: function(g, x, y, colors, tailAng, facing, sitting, dance, smoker, danceT) {
    colors=colors||CAT_COLORS[0]; tailAng=tailAng||0; facing=facing||1;
    sitting=!!sitting; dance=!!dance; smoker=!!smoker; danceT=danceT||0;
    var dBob=dance?Math.sin(danceT*0.007)*3:0;
    g.save(); g.translateCanvas(x,y+dBob); g.scaleCanvas(facing,1);

    var bY=sitting?-8:-12, bH=sitting?14:12;
    // Body
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(-10,bY-2,22,bH+2,5);
    g.fillStyle(parseInt(colors.body.slice(1),16),1); g.fillRoundedRect(-9,bY-1,20,bH,5);
    g.fillStyle(parseInt(colors.belly.slice(1),16),0.7); g.fillEllipse(1,bY+6,12,8);

    // Dance arms (raised) or nothing
    if (dance) {
      var aOff=Math.sin(danceT*0.009)*4;
      g.fillStyle(parseInt(AT.outline.slice(1),16),1);
      g.fillRoundedRect(-17,bY-12+aOff,6,12,2);
      g.fillRoundedRect(11,bY-12-aOff,6,12,2);
      g.fillStyle(parseInt(colors.body.slice(1),16),1);
      g.fillRoundedRect(-16,bY-11+aOff,4,10,2);
      g.fillRoundedRect(12,bY-11-aOff,4,10,2);
    }

    // Head
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(10,bY-8,11);
    g.fillStyle(parseInt(colors.body.slice(1),16),1); g.fillCircle(10,bY-8,10);
    // Ears
    g.fillStyle(parseInt(AT.outline.slice(1),16),1);
    g.fillTriangle(2,bY-16,7,bY-22,12,bY-16); g.fillTriangle(14,bY-16,19,bY-22,24,bY-16);
    g.fillStyle(parseInt(colors.body.slice(1),16),1);
    g.fillTriangle(4,bY-16,8,bY-21,11,bY-16); g.fillTriangle(15,bY-16,19,bY-21,23,bY-16);
    // Eyes
    g.fillStyle(0xffffff,1); g.fillEllipse(6,bY-9,6,5); g.fillEllipse(14,bY-9,6,5);
    g.fillStyle(0x222222,1); g.fillEllipse(6,bY-8,3,4); g.fillEllipse(14,bY-8,3,4);
    // Nose
    g.fillStyle(parseInt(AT.pink.slice(1),16),1); g.fillTriangle(9,bY-5,11,bY-5,10,bY-4);
    // Whiskers
    g.lineStyle(1,parseInt(AT.outline.slice(1),16),0.4);
    g.lineBetween(-2,bY-7,6,bY-6); g.lineBetween(-2,bY-5,6,bY-5);
    g.lineBetween(14,bY-6,22,bY-7); g.lineBetween(14,bY-5,22,bY-5);

    // Smoker cigarette
    if (smoker) {
      g.fillStyle(parseInt(AT.cigBody.slice(1),16),1); g.fillRect(17,bY-7,9,2);
      g.fillStyle(parseInt(AT.cigTip.slice(1),16),1); g.fillCircle(26,bY-6,2);
      g.fillStyle(0xffaa00,0.6); g.fillCircle(26,bY-6,1);
    }

    // Legs (not when sitting or dancing)
    if (!sitting && !dance) {
      g.fillStyle(parseInt(AT.outline.slice(1),16),1);
      g.fillRect(-8,bY+8,6,5); g.fillRect(2,bY+8,6,5); g.fillRect(8,bY+8,6,5);
      g.fillStyle(parseInt(colors.body.slice(1),16),1);
      g.fillRect(-7,bY+9,4,4); g.fillRect(3,bY+9,4,4); g.fillRect(9,bY+9,4,4);
    }

    // Tail
    g.lineStyle(4,parseInt(AT.outline.slice(1),16),1);
    g.beginPath(); g.moveTo(-10,bY+8);
    for (var i=1;i<=7;i++){var t=i/7;g.lineTo(-10-t*18,bY+8-Math.sin(tailAng+t*Math.PI)*8*t);}
    g.strokePath();
    g.lineStyle(2,parseInt(colors.body.slice(1),16),1);
    g.beginPath(); g.moveTo(-10,bY+8);
    for (var j=1;j<=7;j++){var tt=j/7;g.lineTo(-10-tt*18,bY+8-Math.sin(tailAng+tt*Math.PI)*8*tt);}
    g.strokePath();
    g.restore();
  }
};

var DRAW_BUS = {
  draw: function(g, x, y, scale, exT) {
    scale=scale||1; exT=exT||0;
    g.save(); g.translateCanvas(x,y); g.scaleCanvas(scale,scale);
    for (var e=0;e<5;e++) {
      g.fillStyle(parseInt(AT.busPurple.slice(1),16),0.28-e*0.05);
      g.fillCircle(-90-e*14,18+Math.sin(exT*0.05+e)*5,8+e*3);
    }
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(-88,-28,176,56,12);
    g.fillStyle(parseInt(AT.busYellow.slice(1),16),1); g.fillRoundedRect(-86,-26,172,52,11);
    g.fillStyle(parseInt(AT.busPurple.slice(1),16),1); g.fillRect(-86,-4,172,10);
    g.fillStyle(parseInt(AT.busCream.slice(1),16),0.5); g.fillRect(-86,-14,172,10);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1);
    g.fillRoundedRect(-70,-22,30,20,4); g.fillRoundedRect(-28,-22,30,20,4); g.fillRoundedRect(14,-22,30,20,4);
    g.fillStyle(0x7ec8e3,0.85);
    g.fillRoundedRect(-69,-21,28,18,3); g.fillRoundedRect(-27,-21,28,18,3); g.fillRoundedRect(15,-21,28,18,3);
    g.fillStyle(0xffffff,0.35);
    g.fillRect(-68,-20,8,6); g.fillRect(-26,-20,8,6); g.fillRect(16,-20,8,6);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(58,-22,28,20,3);
    g.fillStyle(0x7ec8e3,0.9); g.fillRoundedRect(59,-21,26,18,3);
    g.fillStyle(0xffffff,0.3); g.fillRect(60,-20,10,7);
    g.lineStyle(2,parseInt(AT.busPurple.slice(1),16),0.85);
    g.strokeCircle(-48,6,10);
    g.lineBetween(-48,-4,-48,16); g.lineBetween(-48,6,-56,12); g.lineBetween(-48,6,-40,12);
    DRAW_BUS._fl(g,10,6,8,AT.pink,AT.uiGold);
    DRAW_BUS._fl(g,32,-8,6,AT.aloe,AT.uiGold);
    DRAW_BUS._fl(g,-20,-10,7,AT.uiRed,AT.uiGold);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(-50,28,18); g.fillCircle(40,28,18);
    g.fillStyle(0x333333,1); g.fillCircle(-50,28,16); g.fillCircle(40,28,16);
    g.fillStyle(parseInt(AT.busCream.slice(1),16),1); g.fillCircle(-50,28,7); g.fillCircle(40,28,7);
    g.fillStyle(parseInt(AT.busPurple.slice(1),16),1); g.fillCircle(-50,28,4); g.fillCircle(40,28,4);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillEllipse(-92,10,22,14);
    g.fillStyle(parseInt(AT.busPurple.slice(1),16),1); g.fillEllipse(-91,9,20,12);
    g.fillStyle(parseInt(AT.purple.slice(1),16),0.5); g.fillEllipse(-91,9,14,8);
    g.restore();
  },
  _fl: function(g,x,y,r,pc,cc) {
    g.fillStyle(parseInt(pc.slice(1),16),0.85);
    for (var a=0;a<6;a++){var ang=(a/6)*Math.PI*2;g.fillCircle(x+Math.cos(ang)*r*0.7,y+Math.sin(ang)*r*0.7,r*0.5);}
    g.fillStyle(parseInt(cc.slice(1),16),1); g.fillCircle(x,y,r*0.4);
  }
};

var DRAW_HUD = {
  draw: function(g, aloeText) {
    if(aloeText) aloeText.setText(EWR_STATE.aloe+' ALOE');
    var hp=EWR_STATE.health[0], mhp=EWR_STATE.maxHealth[0];
    g.fillStyle(parseInt(AT.uiBg.slice(1),16),0.82); g.fillRoundedRect(10,10,140,38,8);
    g.lineStyle(2,parseInt(AT.aloe.slice(1),16),0.7); g.strokeRoundedRect(10,10,140,38,8);
    g.fillStyle(parseInt(AT.aloe.slice(1),16),1);
    g.fillTriangle(22,38,18,28,26,28); g.fillTriangle(26,36,22,26,30,26); g.fillRect(22,38,4,5);
    var hpW=Math.max(100,mhp*42);
    g.fillStyle(parseInt(AT.uiBg.slice(1),16),0.82); g.fillRoundedRect(960-10-hpW,10,hpW,38,8);
    g.lineStyle(2,parseInt(AT.uiRed.slice(1),16),0.7); g.strokeRoundedRect(960-10-hpW,10,hpW,38,8);
    for (var i=0;i<mhp;i++) {
      var hx=(960-10-hpW)+14+i*38, hy=29, filled=(i<hp);
      g.fillStyle(filled?0xe84393:0x444444,1);
      g.fillCircle(hx+5,hy-5,7); g.fillCircle(hx+13,hy-5,7);
      g.fillTriangle(hx,hy-2,hx+18,hy-2,hx+9,hy+9);
    }
  }
};

// ════════════════════════════════════════════════════════════════
// Zone 3: PHASER SCENES
// ════════════════════════════════════════════════════════════════

// ── BOOT SCENE ──────────────────────────────────────────────────
function BootScene() { Phaser.Scene.call(this,{key:'Boot'}); }
BootScene.prototype=Object.create(Phaser.Scene.prototype);
BootScene.prototype.constructor=BootScene;
BootScene.prototype.create=function() {
  EWR_STATE.aloe=ALOE.start; EWR_STATE.health=[3,3]; EWR_STATE.levelsBeaten=[]; EWR_STATE.catsPetted=0;
  EWR_STATE.combo={streak:0,mult:1,timer:0}; EWR_STATE.shop={doubleJump:false,speedBoost:false,explosiveCig:false,crtFilter:false}; EWR_STATE.secretBeaten={};
  var W=960,H=540,self=this;
  var g=this.add.graphics();
  g.fillStyle(parseInt(AT.uiBg.slice(1),16),1); g.fillRect(0,0,W,H);
  g.fillStyle(0xffffff,0.6);
  for (var s=0;s<90;s++) g.fillCircle(Math.random()*W,Math.random()*H,Math.random()<0.25?2:1);
  g.fillStyle(parseInt(AT.purple.slice(1),16),0.06);
  g.fillCircle(200,180,180); g.fillCircle(700,350,220);
  g.fillStyle(parseInt(AT.pink.slice(1),16),0.05);
  g.fillCircle(500,120,150);
  this.add.text(W/2,140,"CACTUS ED'S",{fontFamily:'Georgia,serif',fontSize:'74px',color:AT.uiGold,stroke:AT.outline,strokeThickness:7,align:'center'}).setOrigin(0.5);
  this.add.text(W/2,228,"HAPPY PLACE",{fontFamily:'Georgia,serif',fontSize:'66px',color:AT.aloe,stroke:AT.outline,strokeThickness:7,align:'center'}).setOrigin(0.5);
  this.add.text(W/2,322,"a cactus just trying to vibe.",{fontFamily:'Georgia,serif',fontSize:'24px',color:AT.uiText,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5);
  var pa=this.add.text(W/2,420,"PRESS ANY KEY",{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.uiText,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5);
  this.tweens.add({targets:pa,alpha:0.1,duration:550,yoyo:true,repeat:-1});
  this.add.text(W/2,460,"Stick/DPad=Move  |  A=Jump  |  X=Punch  |  B=Kick",{fontFamily:'Courier New,monospace',fontSize:'13px',color:AT.uiText,alpha:0.6}).setOrigin(0.5);
  this.add.text(W/2,478,"Z=Punch/Pet  X=Kick  Hold Z=EMBER BLAST",{fontFamily:'Courier New,monospace',fontSize:'13px',color:AT.uiGold,alpha:0.7}).setOrigin(0.5);
  var edG=this.add.graphics(), cigF=0, smokeT=0;
  DRAW_ED.draw(edG,W/2,500,0,false,0);
  var busG=this.add.graphics(), busX=-200, busT=0;
  this.time.delayedCall(1800,function(){
    self.tweens.add({targets:{v:-200},v:1100,duration:3200,ease:'Sine.easeInOut',
      onUpdate:function(tw){busX=tw.targets[0].val;busT++;busG.clear();DRAW_BUS.draw(busG,busX,492,0.55,busT);}
    });
  });
  this.events.on('update',function(time,delta){
    cigF++; smokeT+=delta;
    if(smokeT>900){smokeT=0;spawnSmoke(W/2+14,478);}
    updateSmoke();
    edG.clear(); DRAW_ED.draw(edG,W/2,500,0,false,cigF);
    for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];edG.fillStyle(0xcccccc,p.life*0.38);edG.fillCircle(p.x,p.y,p.r);}
  });
  this.input.keyboard.on('keydown',function(evt){
    SOUND.init();
    var jKey=self.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.J);
    EWR_STATE.coopMode=jKey.isDown;
    SMOKE_POOL.length=0;
    self.scene.start('Title');
  },{once:true});
};

// ── TITLE SCENE ─────────────────────────────────────────────────
function TitleScene() { Phaser.Scene.call(this,{key:'Title'}); }
TitleScene.prototype=Object.create(Phaser.Scene.prototype);
TitleScene.prototype.constructor=TitleScene;
TitleScene.prototype.create=function(){
  var W=960,H=540,self=this;
  var bgG=this.add.graphics();
  for(var r=0;r<H;r++){
    var t=r/H;
    var rv=Math.round(Phaser.Math.Linear(0x7e,0x3a,t));
    var gv=Math.round(Phaser.Math.Linear(0xc8,0x7b,t));
    var bv=Math.round(Phaser.Math.Linear(0xe3,0xb5,t));
    bgG.fillStyle((rv<<16)|(gv<<8)|bv,1); bgG.fillRect(0,r,W,1);
  }
  bgG.fillStyle(0xffffff,0.3);
  for(var s=0;s<20;s++) bgG.fillCircle(Math.random()*W,Math.random()*(H*0.4),1);
  var cityG=this.add.graphics();
  var bldgs=[
    {x:0,w:120,h:260,c:0x3d5a7a},{x:130,w:80,h:200,c:0x4a6b8a},
    {x:220,w:150,h:320,c:0x2d4a6a},{x:380,w:100,h:180,c:0x5a7a9a},
    {x:490,w:130,h:240,c:0x3d5a7a},{x:700,w:90,h:210,c:0x4a6b8a},
    {x:680,w:70,h:200,c:0x3d5a7a},{x:760,w:55,h:140,c:0x4a6b8a},
    {x:820,w:90,h:250,c:0x2d4a6a},{x:910,w:50,h:160,c:0x5a7a9a}
  ];
  bldgs.forEach(function(b){
    cityG.fillStyle(parseInt(AT.outline.slice(1),16),1); cityG.fillRect(b.x-1,422-b.h-1,b.w+2,b.h+2);
    cityG.fillStyle(b.c,1); cityG.fillRect(b.x,422-b.h,b.w,b.h);
    cityG.fillStyle(0xffd60a,0.55);
    for(var wr=0;wr<Math.floor(b.h/40);wr++)
      for(var wc=0;wc<Math.floor(b.w/22);wc++)
        if(Math.random()>0.4) cityG.fillRect(b.x+6+wc*20,422-b.h+12+wr*36,12,16);
  });
  cityG.fillStyle(parseInt(AT.outline.slice(1),16),1); cityG.fillRect(193,210,36,5);
  cityG.fillStyle(0x8B6914,1); cityG.fillRect(194,215,34,30);
  cityG.fillStyle(0x6B4A0A,1); cityG.fillTriangle(188,215,228,215,208,200);
  var groundG=this.add.graphics();
  groundG.fillStyle(parseInt(AT.grassDark.slice(1),16),1); groundG.fillRect(0,420,W,6);
  groundG.fillStyle(parseInt(AT.grass.slice(1),16),1); groundG.fillRect(0,426,W,14);
  groundG.fillStyle(parseInt(AT.dirt.slice(1),16),1); groundG.fillRect(0,440,W,100);
  var catData=[];
  for(var ci=0;ci<8;ci++) catData.push({x:70+ci*120+Math.random()*60,y:420,ci:ci%4,tailAng:0,wDir:Math.random()<0.5?1:-1,wT:Math.random()*3000,sitting:Math.random()<0.5});
  var catsG=this.add.graphics();
  var edG=this.add.graphics(), edCigF=0, edSmokeT=0;
  var busG=this.add.graphics(), busX=-220, busY=382, busT=0, busPhase='enter', busIdleT=0;
  this.tweens.add({targets:{val:-220},val:300,duration:2400,ease:'Sine.easeOut',
    onUpdate:function(tw){busX=tw.targets[0].val;},
    onComplete:function(){busPhase='idle';}
  });
  var ttxt=this.add.text(W/2,78,"CACTUS ED'S HAPPY PLACE",{fontFamily:'Georgia,serif',fontSize:'54px',color:AT.uiGold,stroke:AT.outline,strokeThickness:8,align:'center'}).setOrigin(0.5);
  this.tweens.add({targets:ttxt,y:83,duration:2200,yoyo:true,repeat:-1,ease:'Sine.easeInOut'});
  this.add.text(W/2,148,'WEST BOTTOMS CIG DISTRICT  //  EST. UNKNOWN',{fontFamily:'Courier New,monospace',fontSize:'19px',color:AT.uiText,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5);
  var ps=this.add.text(W/2,488,"PRESS ANY KEY",{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5);
  this.tweens.add({targets:ps,alpha:0.15,duration:480,yoyo:true,repeat:-1});
  var tTickN=Math.floor(Math.random()*NEWS_TICKER.length);
  var tTickX=960;
  var tTickTxt=this.add.text(960,520,'⚡ '+NEWS_TICKER[tTickN]+'  ◆  ',
    {fontFamily:'Courier New,monospace',fontSize:'11px',color:'#ff4444',stroke:'#000000',strokeThickness:2});
  this.events.on('update',function(time,delta){
    edCigF++; edSmokeT+=delta; busT++;
    tTickX-=1.5*(delta/16);
    tTickTxt.setPosition(tTickX,520);
    if(tTickX<-tTickTxt.width){
      tTickN=(tTickN+1)%NEWS_TICKER.length;
      tTickTxt.setText('⚡ '+NEWS_TICKER[tTickN]+'  ◆  ');
      tTickX=960;
    }
    if(edSmokeT>950){edSmokeT=0;spawnSmoke(520+14,398);}
    updateSmoke();
    for(var i=0;i<catData.length;i++){
      catData[i].tailAng+=0.05; catData[i].wT+=delta;
      if(!catData[i].sitting&&catData[i].wT>2000+Math.random()*3000){catData[i].wDir*=-1;catData[i].wT=0;}
      catData[i].x+=catData[i].wDir*0.35;
      if(catData[i].x<20)catData[i].x=20; if(catData[i].x>W-20)catData[i].x=W-20;
    }
    if(busPhase==='idle'){
      busY=382+Math.sin(busT*0.03)*2; busIdleT+=delta;
      if(busIdleT>3500){busPhase='exit';self.tweens.add({targets:{val:busX},val:1200,duration:1900,ease:'Sine.easeIn',onUpdate:function(tw){busX=tw.targets[0].val;}});}
    }
    catsG.clear();
    for(var ci2=0;ci2<catData.length;ci2++){var cd=catData[ci2];DRAW_CAT.draw(catsG,cd.x,cd.y,CAT_COLORS[cd.ci],cd.tailAng,cd.wDir,cd.sitting);}
    busG.clear(); DRAW_BUS.draw(busG,busX,busY,0.68,busT);
    edG.clear(); DRAW_ED.draw(edG,520,420,0,false,edCigF);
    for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];edG.fillStyle(0xaaaaaa,p.life*0.32);edG.fillCircle(p.x,p.y,p.r);}
  });
  this.input.keyboard.once('keydown',function(){
    SMOKE_POOL.length=0; self.scene.start('WorldMap');
  });
};

// ── WORLD MAP SCENE ─────────────────────────────────────────────
function WorldMapScene() { Phaser.Scene.call(this,{key:'WorldMap'}); }
WorldMapScene.prototype=Object.create(Phaser.Scene.prototype);
WorldMapScene.prototype.constructor=WorldMapScene;
WorldMapScene.prototype.create=function(){
  var W=960,H=540,self=this;
  this.tW=56; this.tH=50; this.offX=28; this.offY=28;
  this.edTile={x:EWR_STATE.playerPos.x,y:EWR_STATE.playerPos.y};
  this.edPx=this._t2p(this.edTile.x,this.edTile.y);
  this.moving=false; this.lastMoveT=0; this.edFacing=1;
  this.edCigF=0; this.edSmokeT=0; this.catTime=0;
  // Shop state
  this.shopOpen=false; this.shopSel=0;
  this.shopItems=[
    {label:'Extra Heart   +1 HP',     key:'extraHeart',   cost:200, bought:EWR_STATE.maxHealth[0]>3},
    {label:'Speed Boost   +15%',      key:'speedBoost',   cost:150, bought:EWR_STATE.shop.speedBoost},
    {label:'Double Jump',             key:'doubleJump',   cost:300, bought:EWR_STATE.shop.doubleJump},
    {label:'Explosive Cig',           key:'explosiveCig', cost:250, bought:EWR_STATE.shop.explosiveCig},
    {label:'CRT Filter    FREE',      key:'crtFilter',    cost:0,   bought:EWR_STATE.shop.crtFilter}
  ];
  var bgG=this.add.graphics();
  bgG.fillStyle(parseInt(AT.sky.slice(1),16),1); bgG.fillRect(0,0,W,H);
  bgG.fillStyle(0xffffff,0.6);
  [[150,60,70,30],[380,40,90,35],[650,80,60,25],[820,50,80,30]].forEach(function(c){bgG.fillEllipse(c[0],c[1],c[2],c[3]);});
  this.mapG=this.add.graphics();
  this._drawMap();
  this.mapCats=[]; this._spawnCats();
  this.catG=this.add.graphics();
  this.edG=this.add.graphics();
  this.hudG=this.add.graphics().setDepth(10);
  this.shopG=this.add.graphics().setScrollFactor(0).setDepth(50);
  this.aloeText=this.add.text(40,22,'',{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setDepth(10);
  this.add.text(W/2,12,'WORLD 1  --  THE WEST BOTTOMS',{fontFamily:'Georgia,serif',fontSize:'20px',color:AT.uiBg,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setDepth(10);
  this.nodeTxt=this.add.text(W/2,H-58,'',{fontFamily:'Georgia,serif',fontSize:'24px',color:AT.uiGold,stroke:AT.outline,strokeThickness:4,align:'center'}).setOrigin(0.5).setAlpha(0).setDepth(10);
  this.enterTxt=this.add.text(W/2,H-30,'PRESS Z TO ENTER',{fontFamily:'Courier New,monospace',fontSize:'16px',color:AT.uiText,stroke:AT.outline,strokeThickness:3,align:'center'}).setOrigin(0.5).setAlpha(0).setDepth(10);
  this.aloePop=this.add.text(50,55,'',{fontFamily:'Courier New,monospace',fontSize:'18px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setAlpha(0).setDepth(10);
  // Shop text objects
  this.shopTxts=[];
  for(var si=0;si<this.shopItems.length;si++){
    this.shopTxts.push(this.add.text(400,200+si*36,'',{fontFamily:'Courier New,monospace',fontSize:'17px',color:AT.uiText,stroke:AT.outline,strokeThickness:2}).setDepth(51).setAlpha(0));
  }
  this.shopTitle=this.add.text(480,145,'',{fontFamily:'Georgia,serif',fontSize:'22px',color:AT.uiGold,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setDepth(51).setAlpha(0);
  this.shopHint=this.add.text(480,415,'',{fontFamily:'Courier New,monospace',fontSize:'13px',color:AT.uiText}).setOrigin(0.5).setDepth(51).setAlpha(0);
  this.keys={
    left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
    right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
    up:   this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
    down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
    altL: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
    altR: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
    altU: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
    altD: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),
    punch:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),
    kick: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X)
  };
  // News ticker
  this._tickX=960; this._tickN=Math.floor(Math.random()*NEWS_TICKER.length);
  this.tickerTxt=this.add.text(960,526,'⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ',
    {fontFamily:'Courier New,monospace',fontSize:'11px',color:'#ff4444',stroke:'#000000',strokeThickness:2})
    .setDepth(10);
  // Beat Cat NPC at tile (2,6)
  var bcPx=this._t2p(2,6);
  this.beatCatG=this.add.graphics().setDepth(8);
  this._drawBeatCat(bcPx.x, bcPx.y);
  this.add.text(bcPx.x,bcPx.y-38,'TRUTH KID',
    {fontFamily:'Courier New,monospace',fontSize:'10px',color:'#ff8800',stroke:'#000000',strokeThickness:2})
    .setOrigin(0.5).setDepth(9);
  this._beatCatPx=bcPx; this._beatCatLineIdx=0;
  var dat=this.scene.settings.data;
  if(dat&&dat.aloeEarned) this._popAloe('+'+dat.aloeEarned+' ALOE!');
  // CAT NEWS card — 50% chance on level completion return
  if(dat&&dat.aloeEarned&&Math.random()<0.5){
    var self2=this;
    var overlay=this.add.graphics().setDepth(90);
    overlay.fillStyle(0x000000,1); overlay.fillRect(0,0,960,540);
    var catNewsTitle=this.add.text(480,160,'CAT NEWS',{fontFamily:'Georgia,serif',fontSize:'52px',color:'#ff2222',stroke:'#000000',strokeThickness:6}).setOrigin(0.5).setDepth(91);
    var catNewsSub=this.add.text(480,240,'BREAKING',{fontFamily:'Courier New,monospace',fontSize:'28px',color:'#ffffff',stroke:'#000000',strokeThickness:4}).setOrigin(0.5).setDepth(91);
    var hl=NEWS_TICKER[Math.floor(Math.random()*NEWS_TICKER.length)];
    var catNewsHl=this.add.text(480,310,hl,{fontFamily:'Courier New,monospace',fontSize:'14px',color:'#ffdd00',stroke:'#000000',strokeThickness:3,align:'center',wordWrap:{width:800}}).setOrigin(0.5).setDepth(91);
    this.time.delayedCall(3500,function(){overlay.destroy();catNewsTitle.destroy();catNewsSub.destroy();catNewsHl.destroy();});
  }
};
WorldMapScene.prototype._drawBeatCat=function(bx,by){
  var g=this.beatCatG;
  g.clear();
  // shadow
  g.fillStyle(0x000000,0.18); g.fillEllipse(bx,by+2,22,6);
  // small orange body
  g.fillStyle(0xff8800,1); g.fillCircle(bx,by-8,9);
  g.fillStyle(0xffcc44,0.5); g.fillCircle(bx-3,by-11,3);
  // sign
  g.fillStyle(0xffffff,0.9); g.fillRect(bx-12,by-28,24,14);
  g.lineStyle(1,0x333333,1); g.strokeRect(bx-12,by-28,24,14);
  // sign stick
  g.fillStyle(0x884400,1); g.fillRect(bx-1,by-14,2,8);
  // face
  g.fillStyle(0x333300,1); g.fillCircle(bx-3,by-10,2); g.fillCircle(bx+3,by-10,2);
};
WorldMapScene.prototype._t2p=function(tx,ty){
  return {x:this.offX+tx*this.tW+this.tW/2,y:this.offY+ty*this.tH+this.tH/2+36};
};
WorldMapScene.prototype._getTile=function(tx,ty){
  if(ty<0||ty>=W1_ROWS.length) return null;
  var row=W1_ROWS[ty]; if(tx<0||tx>=row.length) return null;
  var ch=row[tx]; return W1_TILES[ch]||null;
};
WorldMapScene.prototype._drawMap=function(){
  var g=this.mapG, self=this;
  g.clear();
  for(var row=0;row<W1_ROWS.length;row++){
    for(var col=0;col<W1_ROWS[row].length;col++){
      var ch=W1_ROWS[row][col], tile=W1_TILES[ch]; if(!tile) continue;
      var px=self.offX+col*self.tW, py=self.offY+row*self.tH+36;
      switch(tile.type){
        case 'grass':
          g.fillStyle(parseInt(AT.grass.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH);
          g.fillStyle(parseInt(AT.grassDark.slice(1),16),0.25); g.fillRect(px,py,self.tW,4); break;
        case 'path':
          g.fillStyle(parseInt(AT.dirt.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH); break;
        case 'mountain':
          g.fillStyle(parseInt(AT.uiBg.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH);
          g.fillStyle(0x4a3060,0.8); g.fillTriangle(px,py+self.tH,px+self.tW/2,py+4,px+self.tW,py+self.tH); break;
        case 'tree':
          g.fillStyle(parseInt(AT.grass.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH);
          g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(px+self.tW/2,py+14,14);
          g.fillStyle(parseInt(AT.grassDark.slice(1),16),1); g.fillCircle(px+self.tW/2,py+14,12);
          g.fillStyle(parseInt(AT.dirtDark.slice(1),16),1); g.fillRect(px+self.tW/2-3,py+22,6,12); break;
        case 'level':
          g.fillStyle(parseInt(AT.grass.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH);
          var beaten=EWR_STATE.levelsBeaten.indexOf(tile.id)>=0;
          // Gate: V level only shows if 1-3 beaten
          if(tile.id==='1-V'&&EWR_STATE.levelsBeaten.indexOf('1-3')<0) break;
          var voidStyle=(tile.id==='1-V');
          g.fillStyle(voidStyle?0x220044:(beaten?0x888888:parseInt(AT.uiGold.slice(1),16)),0.22); g.fillCircle(px+self.tW/2,py+self.tH/2,22);
          g.fillStyle(voidStyle?0xcc44ff:(beaten?0x888888:parseInt(AT.uiGold.slice(1),16)),1);    g.fillCircle(px+self.tW/2,py+self.tH/2,12);
          g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(px+self.tW/2,py+self.tH/2,8);
          g.fillStyle(voidStyle?0xcc44ff:(beaten?0x888888:parseInt(AT.uiGold.slice(1),16)),1);    g.fillCircle(px+self.tW/2,py+self.tH/2,5); break;
        case 'portal':
          g.fillStyle(parseInt(AT.sky.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH);
          g.fillStyle(0x00ffcc,0.18); g.fillCircle(px+self.tW/2,py+self.tH/2,22);
          g.fillStyle(0x00ffcc,1); g.fillCircle(px+self.tW/2,py+self.tH/2,12);
          g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(px+self.tW/2,py+self.tH/2,8);
          g.fillStyle(0xcc44ff,1); g.fillCircle(px+self.tW/2,py+self.tH/2,5); break;
        case 'catspot':
        default:
          g.fillStyle(parseInt(AT.grass.slice(1),16),1); g.fillRect(px,py,self.tW,self.tH); break;
      }
      g.lineStyle(1,parseInt(AT.outline.slice(1),16),0.07); g.strokeRect(px,py,self.tW,self.tH);
    }
  }
  // Ed has seen things badge
  if(EWR_STATE.secretBeaten&&EWR_STATE.secretBeaten['1-V']){
    g.fillStyle(0xcc44ff,1); g.fillCircle(self.offX+8*self.tW+self.tW/2-8,self.offY+4*self.tH+36+self.tH/2-22,5);
  }
};
WorldMapScene.prototype._spawnCats=function(){
  var positions=[], ri;
  for(ri=0;ri<W1_ROWS.length;ri++)
    for(var ci=0;ci<W1_ROWS[ri].length;ci++)
      if(W1_ROWS[ri][ci]==='C') positions.push({x:ci,y:ri});
  var extra=0;
  for(ri=1;ri<W1_ROWS.length-1&&extra<6;ri++)
    for(var ci2=1;ci2<W1_ROWS[ri].length-1&&extra<6;ci2++)
      if((W1_ROWS[ri][ci2]==='G'||W1_ROWS[ri][ci2]==='P')&&Math.random()<0.22){positions.push({x:ci2,y:ri});extra++;}
  for(var i=0;i<positions.length;i++){
    var p=positions[i];
    var px=this.offX+p.x*this.tW+this.tW/2, py=this.offY+p.y*this.tH+this.tH+36;
    this.mapCats.push({x:px,y:py,hx:px,ci:i%4,tailAng:Math.random()*Math.PI*2,facing:Math.random()<0.5?1:-1,wT:Math.random()*3000,sitting:Math.random()<0.5,name:CAT_NAMES[i%CAT_NAMES.length],petted:false});
  }
};
WorldMapScene.prototype._popAloe=function(msg){
  this.aloePop.setText(msg).setAlpha(1).setY(55);
  this.tweens.add({targets:this.aloePop,y:30,alpha:0,duration:1800,ease:'Sine.easeOut'});
};
WorldMapScene.prototype._drawShop=function(){
  var g=this.shopG;
  g.clear();
  if(!this.shopOpen) { for(var i=0;i<this.shopTxts.length;i++) this.shopTxts[i].setAlpha(0); this.shopTitle.setAlpha(0); this.shopHint.setAlpha(0); return; }
  g.fillStyle(parseInt(AT.uiBg.slice(1),16),0.94); g.fillRoundedRect(280,130,400,300,10);
  g.lineStyle(2,parseInt(AT.uiGold.slice(1),16),0.8); g.strokeRoundedRect(280,130,400,300,10);
  this.shopTitle.setText("CHAIRMAN WHISKERS' SHOP").setAlpha(1);
  this.shopHint.setText('Up/Down=Select  Z=Buy  X=Close').setAlpha(1);
  for(var si=0;si<this.shopItems.length;si++){
    var item=this.shopItems[si];
    var bought=(item.key==='extraHeart')?(EWR_STATE.maxHealth[0]>3):EWR_STATE.shop[item.key];
    var sel=(si===this.shopSel);
    var col=bought?'#888888':(sel?'#ffd60a':AT.uiText);
    var costStr=item.cost===0?'FREE':''+item.cost+' aloe';
    var boughtStr=bought?' [OWNED]':'';
    this.shopTxts[si].setText((sel?'> ':' ')+item.label+'  '+costStr+boughtStr).setStyle({color:col}).setAlpha(1);
  }
};
WorldMapScene.prototype._buyShop=function(){
  var item=this.shopItems[this.shopSel];
  var bought=(item.key==='extraHeart')?(EWR_STATE.maxHealth[0]>3):EWR_STATE.shop[item.key];
  if(bought){ this._popAloe('already owned!'); return; }
  if(EWR_STATE.aloe<item.cost){ this._popAloe('need '+item.cost+' aloe!'); return; }
  EWR_STATE.aloe-=item.cost;
  if(item.key==='extraHeart'){ EWR_STATE.maxHealth[0]=Math.min(EWR_STATE.maxHealth[0]+1,5); EWR_STATE.health[0]=EWR_STATE.maxHealth[0]; }
  else if(item.key==='speedBoost'){ EWR_STATE.shop.speedBoost=true; ED_MOVE.walkSpeed=Math.round(ED_MOVE.walkSpeed*1.15); }
  else EWR_STATE.shop[item.key]=true;
  SOUND.pickup();
  this._popAloe('PURCHASED!');
};
WorldMapScene.prototype.update=function(time,delta){
  this.catTime+=delta; this.edCigF++; this.edSmokeT+=delta;
  if(this.edSmokeT>1100){this.edSmokeT=0;spawnSmoke(this.edPx.x+14,this.edPx.y-22);}
  updateSmoke();
  for(var i=0;i<this.mapCats.length;i++){
    var c=this.mapCats[i]; c.tailAng+=0.04; c.wT+=delta;
    if(!c.sitting&&c.wT>2200){c.wT=0;c.facing*=-1;c.x+=c.facing*8;if(Math.abs(c.x-c.hx)>22)c.x=c.hx;}
  }
  var pad=this.input.gamepad&&this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;
  var gpMapL=false,gpMapR=false,gpMapU=false,gpMapD=false,gpMapA=false,gpMapB=false;
  if(pad){
    var ax=pad.axes.length>0?pad.axes[0].getValue():0;
    var ay=pad.axes.length>1?pad.axes[1].getValue():0;
    gpMapL=(pad.left)||(ax<-0.5); gpMapR=(pad.right)||(ax>0.5);
    gpMapU=(pad.up)||(ay<-0.5);   gpMapD=(pad.down)||(ay>0.5);
    var aNow=pad.A&&pad.A.pressed;
    gpMapA=aNow&&!this._prevA; this._prevA=aNow;
    var bNow=pad.B&&pad.B.pressed;
    gpMapB=bNow&&!this._prevB; this._prevB=bNow;
  }
  // Shop navigation
  if(this.shopOpen){
    if(Phaser.Input.Keyboard.JustDown(this.keys.up)||gpMapU){this.shopSel=Math.max(0,this.shopSel-1);}
    if(Phaser.Input.Keyboard.JustDown(this.keys.down)||gpMapD){this.shopSel=Math.min(this.shopItems.length-1,this.shopSel+1);}
    if(Phaser.Input.Keyboard.JustDown(this.keys.punch)||gpMapA){this._buyShop();}
    if(Phaser.Input.Keyboard.JustDown(this.keys.kick)||gpMapB){this.shopOpen=false;}
    this.mapG.clear(); this._drawMap();
    this.catG.clear();
    for(var ci=0;ci<this.mapCats.length;ci++){var c2=this.mapCats[ci];DRAW_CAT.draw(this.catG,c2.x,c2.y,CAT_COLORS[c2.ci],c2.tailAng,c2.facing,c2.sitting);}
    this.edG.clear(); DRAW_ED.draw(this.edG,this.edPx.x,this.edPx.y,0,this.edFacing<0,this.edCigF);
    this._drawShop();
    this.hudG.clear(); DRAW_HUD.draw(this.hudG);
    this.aloeText.setText(EWR_STATE.aloe+' ALOE');
    return;
  }
  this._drawShop();
  if(!this.moving&&time-this.lastMoveT>150){
    var dx=0,dy=0;
    if(Phaser.Input.Keyboard.JustDown(this.keys.left)||Phaser.Input.Keyboard.JustDown(this.keys.altL)||gpMapL){dx=-1;this.edFacing=-1;}
    else if(Phaser.Input.Keyboard.JustDown(this.keys.right)||Phaser.Input.Keyboard.JustDown(this.keys.altD)||gpMapR){dx=1;this.edFacing=1;}
    else if(Phaser.Input.Keyboard.JustDown(this.keys.up)||Phaser.Input.Keyboard.JustDown(this.keys.altU)||gpMapU){dy=-1;}
    else if(Phaser.Input.Keyboard.JustDown(this.keys.down)||gpMapD){dy=1;}
    if(dx!==0||dy!==0){
      var nx=this.edTile.x+dx, ny=this.edTile.y+dy;
      var tile=this._getTile(nx,ny);
      if(tile&&tile.passable){
        this.lastMoveT=time; this.moving=true;
        var tp=this._t2p(nx,ny), self=this;
        this.tweens.add({targets:this.edPx,x:tp.x,y:tp.y,duration:130,ease:'Linear',
          onComplete:function(){self.edTile.x=nx;self.edTile.y=ny;EWR_STATE.playerPos.x=nx;EWR_STATE.playerPos.y=ny;self.moving=false;self._onTile(nx,ny);}
        });
      }
    }
  }
  if(Phaser.Input.Keyboard.JustDown(this.keys.punch)||gpMapA){ this._tryPet(); this._tryEnter(); this._tryShop(); this._tryBeatCat(); }
  this.mapG.clear(); this._drawMap();
  this.catG.clear();
  for(var ci3=0;ci3<this.mapCats.length;ci3++){var c3=this.mapCats[ci3];DRAW_CAT.draw(this.catG,c3.x,c3.y,CAT_COLORS[c3.ci],c3.tailAng,c3.facing,c3.sitting);}
  var ef=this.moving?Math.floor(this.catTime/100)%4:0;
  this.edG.clear(); DRAW_ED.draw(this.edG,this.edPx.x,this.edPx.y,ef,this.edFacing<0,this.edCigF);
  for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];this.edG.fillStyle(0xaaaaaa,p.life*0.28);this.edG.fillCircle(p.x,p.y,p.r);}
  this.hudG.clear(); DRAW_HUD.draw(this.hudG);
  this.aloeText.setText(EWR_STATE.aloe+' ALOE');
  var curTile=this._getTile(this.edTile.x,this.edTile.y);
  if(curTile&&curTile.type==='level'){this.nodeTxt.setText(curTile.label).setAlpha(1);this.enterTxt.setAlpha(1);}
  else{this.nodeTxt.setAlpha(0);this.enterTxt.setAlpha(0);}
  // News ticker scroll
  this._tickX-=1.5*(delta/16);
  this.tickerTxt.setPosition(this._tickX,526);
  if(this._tickX<-this.tickerTxt.width){
    this._tickN=(this._tickN+1)%NEWS_TICKER.length;
    this.tickerTxt.setText('⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ');
    this._tickX=960;
  }
};
WorldMapScene.prototype._onTile=function(tx,ty){
  var tile=this._getTile(tx,ty); if(!tile) return;
  if(tile.type==='secret'&&!EWR_STATE.secrets[tile.id]){EWR_STATE.secrets[tile.id]=true;EWR_STATE.aloe+=ALOE.secretFind;this._popAloe('+'+ALOE.secretFind+' ALOE! SECRET!');}
};
WorldMapScene.prototype._tryPet=function(){
  for(var i=0;i<this.mapCats.length;i++){
    var c=this.mapCats[i];
    if(Phaser.Math.Distance.Between(this.edPx.x,this.edPx.y,c.x,c.y)<62&&!c.petted){
      c.petted=true; c.sitting=true; EWR_STATE.aloe+=ALOE.catPet; EWR_STATE.catsPetted++;
      SOUND.pickup();
      this._popAloe('+'+ALOE.catPet+' ALOE  (purr...)'); break;
    }
  }
};
WorldMapScene.prototype._tryShop=function(){
  // Shop opens at tile col=7, row=6 (path tile on main road) after beating 1-1
  if(EWR_STATE.levelsBeaten.indexOf('1-1')<0) return;
  var shopTile=this._t2p(7,6);
  if(Math.abs(this.edPx.x-shopTile.x)<40&&Math.abs(this.edPx.y-shopTile.y)<40){
    this.shopOpen=true; this.shopSel=0;
  }
};
WorldMapScene.prototype._tryBeatCat=function(){
  if(!this._beatCatPx) return;
  if(Math.abs(this.edPx.x-this._beatCatPx.x)<55&&Math.abs(this.edPx.y-this._beatCatPx.y)<55){
    var line=BEAT_CAT_LINES[this._beatCatLineIdx%BEAT_CAT_LINES.length];
    this._beatCatLineIdx++;
    var self3=this;
    this.nodeTxt.setText(line).setAlpha(1);
    this.time.delayedCall(3800,function(){if(self3.nodeTxt)self3.nodeTxt.setAlpha(0);});
  }
};
WorldMapScene.prototype._tryEnter=function(){
  var tile=this._getTile(this.edTile.x,this.edTile.y); if(!tile||(tile.type!=='level'&&tile.type!=='portal')) return;
  if(tile.type==='portal'){
    var w1Done=['1-1','1-2','1-3','1-4','1-5'].every(function(id){return EWR_STATE.levelsBeaten.indexOf(id)>=0;});
    if(!w1Done){
      var self=this;
      this.nodeTxt.setText('Beat all of World 1 to unlock The Neon District!').setAlpha(1);
      this.time.delayedCall(2500,function(){self.nodeTxt.setAlpha(0);});
      return;
    }
    SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;
    this.scene.start('WorldMap2'); return;
  }
  var gateMsg=null;
  if(tile.id==='1-2'&&EWR_STATE.levelsBeaten.indexOf('1-1')<0) gateMsg='Beat Ed Wakes Up first!';
  if(tile.id==='1-3'&&EWR_STATE.levelsBeaten.indexOf('1-2')<0) gateMsg='Beat The Cat Rave first!';
  if(tile.id==='1-4'&&EWR_STATE.levelsBeaten.indexOf('1-3')<0) gateMsg='Beat Daikon District first!';
  if(tile.id==='1-5'&&EWR_STATE.levelsBeaten.indexOf('1-4')<0) gateMsg='Beat Hippie Bus Highway first!';
  if(tile.id==='1-V'&&EWR_STATE.levelsBeaten.indexOf('1-3')<0) gateMsg='Beat Daikon District to unlock The Void!';
  if(gateMsg){
    var self=this;
    this.nodeTxt.setText(gateMsg).setAlpha(1);
    this.time.delayedCall(2200,function(){self.nodeTxt.setAlpha(0);});
    return;
  }
  var dest={'1-1':'Level11','1-2':'Level12','1-3':'Level13','1-4':'Level14','1-5':'Level15','1-V':'LevelVoid'}[tile.id];
  if(dest){SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;this.scene.start(dest);}
};

// ── LEVEL 1-1: ED WAKES UP ──────────────────────────────────────
function Level11Scene() { Phaser.Scene.call(this,{key:'Level11'}); }
Level11Scene.prototype=Object.create(Phaser.Scene.prototype);
Level11Scene.prototype.constructor=Level11Scene;
Level11Scene.prototype.create=function(){
  var W=960,H=540,self=this;
  var LW=4800;
  EX_POOL.length=0; SMOKE_POOL.length=0; FIRE_POOL.length=0; NUKE_POOL.length=0;
  this._dying=false; this._dyingT=0; this._beaten=false;
  this.platRects=[{x:0,y:490,w:LW,h:50}];
  var plats=[
    [160,390,130,18],[380,340,90,18],[580,420,70,18],
    [980,400,100,18],[1130,340,90,18],[1280,280,110,18],
    [1440,360,80,18],[1600,400,120,18],[1780,310,80,18],[1940,380,100,18],[2040,430,80,18],
    [2180,420,100,18],[2360,370,80,18],[2510,435,60,18],[2660,380,100,18],
    [2840,340,80,18],[3000,400,100,18],[3160,455,80,18],
    [3360,420,80,18],[3480,360,60,18],[3590,300,60,18],[3700,245,80,18],
    [3860,285,60,18],[3980,355,80,18],[4090,425,60,18],[4190,465,100,18],
    [4240,425,120,18],[4390,405,80,18],[4540,385,110,18]
  ];
  for(var pi=0;pi<plats.length;pi++) this.platRects.push({x:plats[pi][0],y:plats[pi][1],w:plats[pi][2],h:plats[pi][3]});
  this.levelG=this.add.graphics(); this._drawLevel(this.levelG,LW,H);
  this.cameras.main.setBounds(0,0,LW,H);
  this.ep={x:100,y:440,vx:0,vy:0,grounded:false,coyoteMs:0,jumpBufMs:0,chargeT:0,djUsed:false};
  this.es={facing:1,frame:0,cigF:0,smokeT:0,walkT:0,punchTimer:0,punchActive:false,kickTimer:0,kickActive:false,hurtTimer:0};
  this.edG=this.add.graphics().setDepth(5);
  this.cats=[]; this.catG=this.add.graphics().setDepth(3);
  var catX=[200,420,700,1060,1310,1650,1840,2230,2540,2870,3130,3490,3880,4330,4590,4740];
  for(var ci=0;ci<catX.length;ci++) this.cats.push({x:catX[ci],y:487,ci:ci%4,tailAng:Math.random()*Math.PI*2,wDir:Math.random()<0.5?1:-1,wT:Math.random()*3000,sitting:Math.random()<0.6,dance:Math.random()<0.25,smoker:Math.random()<0.28,danceT:Math.random()*1000,following:false,armyT:0,loyal:false});
  this.mochiList=[]; this.mochiG=this.add.graphics().setDepth(4);
  var mochiX=[490,840,1090,1390,1680,1990,2280,2590,2870,3190,3580,3980,4280,4480,4680];
  for(var mi=0;mi<mochiX.length;mi++) this.mochiList.push({x:mochiX[mi],y:464,hp:3,spd:40+Math.random()*22,dir:1,bT:0,bAmt:0,dieT:-1,squishT:0,parts:[],pMin:mochiX[mi]-85,pMax:mochiX[mi]+85,type:'mochi'});
  this.pickups=[]; this.pickupG=this.add.graphics().setDepth(4);
  var pickupX=[1295,2670,3712,4400];
  for(var ai=0;ai<pickupX.length;ai++) this.pickups.push({x:pickupX[ai],y:264,collected:false,bobT:0});
  this.hudG=this.add.graphics().setScrollFactor(0).setDepth(20);
  this.aloeText=this.add.text(40,22,'',{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setScrollFactor(0).setDepth(20);
  this.add.text(480,14,'1-1  ED WAKES UP',{fontFamily:'Georgia,serif',fontSize:'18px',color:AT.uiGold,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(20);
  this.flashTxt=this.add.text(480,270,'',{fontFamily:'Georgia,serif',fontSize:'42px',color:AT.uiGold,stroke:AT.outline,strokeThickness:5}).setOrigin(0.5).setScrollFactor(0).setDepth(20).setAlpha(0);
  this.comboText=this.add.text(0,0,'',{fontFamily:'Courier New,monospace',fontSize:'20px',color:'#ffd60a',stroke:AT.outline,strokeThickness:3}).setDepth(25).setAlpha(0);
  this.psychG=this.add.graphics().setScrollFactor(0).setDepth(50);
  this.dyingG=this.add.graphics().setScrollFactor(0).setDepth(90);
  this.dyingTxt=this.add.text(480,230,'',{fontFamily:'Georgia,serif',fontSize:'46px',color:'#ffffff',stroke:'#000000',strokeThickness:6}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.dyingTxt2=this.add.text(480,295,'',{fontFamily:'Courier New,monospace',fontSize:'24px',color:'#aaaaaa'}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.crtG=this.add.graphics().setScrollFactor(0).setDepth(99);
  if(EWR_STATE.shop.crtFilter){this.crtG.fillStyle(0x000000,0.14);for(var cr=0;cr<540;cr+=4)this.crtG.fillRect(0,cr,960,1);}
  this.keys={
    left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
    right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
    up:   this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
    down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
    punch:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),
    kick: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),
    altL: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
    altR: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
    altU: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
    altD: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S)
  };
  this.ctrlPanel=this.add.graphics().setScrollFactor(0).setDepth(25);
  this.ctrlLines=[
    this.add.text(618,398,'CONTROLS',{fontFamily:'Courier New,monospace',fontSize:'13px',color:AT.uiGold,stroke:AT.outline,strokeThickness:2}).setScrollFactor(0).setDepth(25),
    this.add.text(618,414,'Arrows/WASD = Move',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiText}).setScrollFactor(0).setDepth(25),
    this.add.text(618,428,'W/Up=Jump  S=Duck',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiText}).setScrollFactor(0).setDepth(25),
    this.add.text(618,442,'Z=Punch  Hold Z=EMBER BLAST',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiText}).setScrollFactor(0).setDepth(25),
    this.add.text(618,456,'X=Kick  Z near cat=Pet',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiText}).setScrollFactor(0).setDepth(25),
    this.add.text(618,472,'-- CONTROLLER --',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiGold}).setScrollFactor(0).setDepth(25),
    this.add.text(618,486,'Stick=Move A=Jump X=Punch B=Kick',{fontFamily:'Courier New,monospace',fontSize:'12px',color:AT.uiText}).setScrollFactor(0).setDepth(25)
  ];
  this.levelT=0; this.checkpt=false;
  this.nukeG=this.add.graphics().setScrollFactor(0).setDepth(2);
  this._nukeT=0; this._nukeInterval=30000+Math.random()*20000;
  this._tickX=960; this._tickN=Math.floor(Math.random()*NEWS_TICKER.length);
  this.tickerTxt=this.add.text(960,526,'⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ',
    {fontFamily:'Courier New,monospace',fontSize:'11px',color:'#ff4444',stroke:'#000000',strokeThickness:2})
    .setScrollFactor(0).setDepth(22);
  this._flash('ED WAKES UP',2400);
};
Level11Scene.prototype.update=function(time,delta){
  var LW=4800;
  if(this._dying){
    this._dyingT+=delta;
    var fa=Math.min(this._dyingT/700,0.92);
    this.dyingG.clear(); this.dyingG.fillStyle(0x000000,fa); this.dyingG.fillRect(0,0,960,540);
    if(this._dyingT>800&&this.dyingTxt.alpha<1){this.dyingTxt.setText('ED NEEDS A MINUTE').setAlpha(1);this.dyingTxt2.setText('...').setAlpha(1);}
    if(this._dyingT>2600){EWR_STATE.health[0]=EWR_STATE.maxHealth[0];EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;for(var ca=0;ca<this.cats.length;ca++){this.cats[ca].following=false;this.cats[ca].loyal=false;}this.scene.restart();}
    return;
  }
  this.levelT+=delta;
  var dt=delta/1000, ep=this.ep, es=this.es;
  var pad=this.input.gamepad&&this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;
  var gpL=false,gpR=false,gpJ=false,gpKick=false,gpPunchHeld=false;
  if(pad){
    var axV=pad.axes.length>0?pad.axes[0].getValue():0;
    var ayV=pad.axes.length>1?pad.axes[1].getValue():0;
    gpL=(pad.left)||(axV<-0.3); gpR=(pad.right)||(axV>0.3);
    gpJ=(pad.up)||(pad.A&&pad.A.pressed)||(ayV<-0.5);
    gpPunchHeld=!!(pad.X&&pad.X.pressed);
    var kNow=pad.B&&pad.B.pressed; gpKick=kNow&&!this._prevKickGP; this._prevKickGP=kNow;
  }
  var goL=this.keys.left.isDown||this.keys.altL.isDown||gpL;
  var goR=this.keys.right.isDown||this.keys.altR.isDown||gpR;
  var goJ=this.keys.up.isDown||this.keys.altU.isDown||gpJ;
  var goD=this.keys.down.isDown||this.keys.altD.isDown;
  var doKick=Phaser.Input.Keyboard.JustDown(this.keys.kick)||gpKick;
  // Charge / punch logic
  var zHeld=this.keys.punch.isDown||gpPunchHeld;
  var zWasHeld=this._prevZHeld||false;
  var zJustReleased=(!zHeld)&&zWasHeld;
  if(zHeld&&es.punchTimer<=0&&es.kickTimer<=0){var _pct=ep.chargeT;ep.chargeT+=delta;if(ep.chargeT>200&&Math.floor(ep.chargeT/300)>Math.floor(_pct/300))SOUND.charge();}
  if(zJustReleased&&es.punchTimer<=0&&es.kickTimer<=0){
    if(ep.chargeT>=1200){ this._emberBlast(); }
    else if(ep.chargeT>=60){ es.punchTimer=340; es.punchActive=true; SOUND.punch(); }
    ep.chargeT=0;
  }
  if(!zHeld) ep.chargeT=Math.max(0,ep.chargeT-delta*3);
  this._prevZHeld=zHeld;
  // Movement
  var tVx=0;
  if(goL){tVx=-ED_MOVE.walkSpeed;es.facing=-1;}
  if(goR){tVx= ED_MOVE.walkSpeed;es.facing= 1;}
  if(goD&&ep.grounded) tVx*=0.35;
  var airM=ep.grounded?1:ED_MOVE.airControl;
  ep.vx+=(tVx-ep.vx)*Math.min(1,12*dt*airM);
  // Jump
  var wasGrounded=ep.grounded;
  if(goJ) ep.jumpBufMs=ED_MOVE.jumpBufMs;
  else ep.jumpBufMs=Math.max(0,ep.jumpBufMs-delta);
  if(ep.grounded) ep.coyoteMs=ED_MOVE.coyoteMs;
  else ep.coyoteMs=Math.max(0,ep.coyoteMs-delta);
  if(ep.jumpBufMs>0&&ep.coyoteMs>0&&ep.vy>=-10){
    ep.vy=ED_MOVE.jumpVel; ep.jumpBufMs=0; ep.coyoteMs=0; ep.grounded=false;
    SOUND.jump();
  }
  if(!goJ&&ep.vy<0) ep.vy*=ED_MOVE.jumpCut;
  // Double jump
  if(EWR_STATE.shop.doubleJump&&!ep.grounded&&wasGrounded===false&&ep.coyoteMs<=0&&ep.jumpBufMs>0&&ep.vy>0&&!ep.djUsed){
    ep.vy=ED_MOVE.jumpVel*0.82; ep.djUsed=true; ep.jumpBufMs=0; SOUND.jump();
    spawnExplosion(ep.x,ep.y,0x00ffff,0.8);
  }
  if(ep.grounded) ep.djUsed=false;
  ep.vy=Math.min(ep.vy+800*dt,ED_MOVE.maxFall);
  ep.x+=ep.vx*dt; ep.y+=ep.vy*dt;
  ep.grounded=false;
  var edL=ep.x-14,edR=ep.x+14,edBot=ep.y;
  if(edBot>=490&&ep.vy>=0){ep.y=490;ep.vy=0;ep.grounded=true;}
  for(var pi=1;pi<this.platRects.length;pi++){
    var pl=this.platRects[pi];
    if(ep.vy>=0&&edBot>=pl.y&&edBot<=pl.y+pl.h+6&&edL<pl.x+pl.w&&edR>pl.x){
      if(edBot-ep.vy*dt<pl.y+3){ep.y=pl.y;ep.vy=0;ep.grounded=true;}
    }
  }
  if(ep.x<14){ep.x=14;ep.vx=0;} if(ep.x>LW-14){ep.x=LW-14;ep.vx=0;}
  if(ep.y>620){this._triggerDeath();return;}
  // Combat timers
  if(es.hurtTimer>0) es.hurtTimer-=delta;
  if(es.punchTimer>0){es.punchTimer-=delta;es.punchActive=es.punchTimer>90;}
  if(doKick&&es.kickTimer<=0&&es.punchTimer<=0){es.kickTimer=600;es.kickActive=true;}
  if(es.kickTimer>0){es.kickTimer-=delta;es.kickActive=es.kickTimer>200;}
  // Combo decay
  if(EWR_STATE.combo.streak>0){EWR_STATE.combo.timer-=delta;if(EWR_STATE.combo.timer<=0){EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;}}
  // Punch hits
  var punchConsumed=false;
  if(es.punchActive){
    var hx=ep.x+es.facing*56;
    for(var mi=0;mi<this.mochiList.length;mi++){
      var m=this.mochiList[mi]; if(m.dieT>=0) continue;
      if(m.type==='daikon'&&ep.grounded) continue;
      var hRange=(m.type==='tank')?70:52, hRangeY=(m.type==='tank')?50:36;
      if(Math.abs(hx-m.x)<hRange&&Math.abs(ep.y-m.y)<hRangeY){
        m.hp--; spawnExplosion(m.x,m.y-13,0xffd60a,1); SOUND.punch();
        this.cameras.main.shake(80,0.005);
        _addCombo(this,m.x,m.y);
        if(m.hp<=0){m.dieT=0;m.squishT=0;EWR_STATE.aloe+=Math.ceil((m.type==='rasta'?ALOE.rastaDeath:m.type==='ghost'?ALOE.ghostDeath:m.type==='bomber'?ALOE.bomberDeath:m.type==='tank'?ALOE.tankDeath:m.type==='daikon'?ALOE.daikonDeath:ALOE.mochiDeath)*EWR_STATE.combo.mult);spawnExplosion(m.x,m.y-13,0xff4444,2);this._spawnMochiParts(m);if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}}
        if(EWR_STATE.shop.explosiveCig) spawnExplosion(ep.x+es.facing*56,ep.y-20,0xff6b35,1.2);
        es.punchActive=false; punchConsumed=true; break;
      }
    }
  }
  // Kick hits
  if(es.kickActive){
    var kx=ep.x+es.facing*ED_MOVE.kickRange;
    for(var ki=0;ki<this.mochiList.length;ki++){
      var km=this.mochiList[ki]; if(km.dieT>=0) continue;
      if(km.type==='daikon'&&ep.grounded) continue;
      if(Math.abs(kx-km.x)<65&&Math.abs(ep.y-km.y)<42){
        km.hp-=2; spawnExplosion(km.x,km.y-13,0xff6b35,1.5); SOUND.kick();
        this.cameras.main.shake(120,0.008);
        _addCombo(this,km.x,km.y);
        if(km.hp<=0){km.dieT=0;km.squishT=0;EWR_STATE.aloe+=Math.ceil((km.type==='rasta'?ALOE.rastaDeath:km.type==='ghost'?ALOE.ghostDeath:km.type==='bomber'?ALOE.bomberDeath:km.type==='tank'?ALOE.tankDeath:km.type==='daikon'?ALOE.daikonDeath:ALOE.mochiDeath)*EWR_STATE.combo.mult);spawnExplosion(km.x,km.y-13,0xff4444,2.5);this._spawnMochiParts(km);if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}}
        es.kickActive=false; break;
      }
    }
  }
  // Cat petting + dialogue (Z near cat, not consumed by punch)
  if(zJustReleased&&!punchConsumed&&ep.chargeT<100){
    var petted=false;
    for(var catI=0;catI<this.cats.length;catI++){
      var pc=this.cats[catI];
      if(Math.abs(ep.x-pc.x)<52&&Math.abs(ep.y-pc.y)<44){
        if(!pc.loyal&&pc.sitting){
          pc.loyal=true; pc.following=true; pc.dance=true; pc.sitting=false;
          EWR_STATE.aloe+=ALOE.catPet; EWR_STATE.catsPetted++;
          SOUND.pickup(); this._flash('+'+ALOE.catPet+' ALOE  (meow)',1000);
          petted=true;
        } else {
          // Dialogue
          var line=ED_LINES[Math.floor(Math.random()*ED_LINES.length)];
          try{var bbl=this.add.text(ep.x,ep.y-72,'"'+line+'"',{fontFamily:'Courier New,monospace',fontSize:'14px',color:'#ffffff',stroke:'#000000',strokeThickness:3,backgroundColor:'#1a0a2e',padding:{x:5,y:3}}).setDepth(26);this.time.delayedCall(1800,function(){bbl.destroy();});}catch(e){}
          petted=true;
        }
        break;
      }
    }
  }
  // Cat army follow + attack
  for(var ci=0;ci<this.cats.length;ci++){
    var ac=this.cats[ci];
    if(!ac.following) continue;
    ac.armyT+=delta;
    var txc=ep.x-es.facing*(60+ci*32);
    ac.x+=(txc-ac.x)*0.08; ac.y+=(487-ac.y)*0.1;
    if(ac.armyT>=2000){
      ac.armyT=0;
      for(var ami=0;ami<this.mochiList.length;ami++){
        var am=this.mochiList[ami]; if(am.dieT>=0) continue;
        if(Math.abs(ac.x-am.x)<48&&Math.abs(ac.y-am.y)<40){
          am.hp--; spawnExplosion(am.x,am.y-10,0xffcc00,0.8);
          if(am.hp<=0){am.dieT=0;am.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath;spawnExplosion(am.x,am.y-13,0xff4444,1.5);this._spawnMochiParts(am);}
          break;
        }
      }
    }
  }
  // Mochi update
  for(var mi2=0;mi2<this.mochiList.length;mi2++){
    var m2=this.mochiList[mi2];
    if(m2.dieT>=0){
      if(m2.type==='bomber'&&!m2._exploded){
        m2._exploded=true;
        spawnExplosion(m2.x,m2.y-15,0xff2200,2.5); SOUND.blast();
        if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<70&&Math.abs(ep.y-m2.y)<60){
          EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          es.hurtTimer=1200; SOUND.hurt(); this.cameras.main.shake(300,0.015);
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        }
      }
      m2.dieT+=delta; m2.squishT+=delta;
      for(var pp=0;pp<m2.parts.length;pp++){var pt=m2.parts[pp];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.3;pt.life-=0.025;}
      continue;
    }
    // Type-specific update
    if(m2.type==='rasta'){
      m2.bT+=delta; m2.x+=m2.dir*m2.spd*dt;
      if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
      if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<28&&Math.abs(ep.y-m2.y)<36){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012); ep.vx=-es.facing*190; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
      continue;
    }
    if(m2.type==='ghost'){
      m2.bT+=delta; m2.x+=m2.dir*m2.spd*dt;
      m2.y=(m2.baseY||320)+Math.sin(m2.bT*0.003)*22;
      if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
      if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<26&&Math.abs(ep.y-m2.y)<30){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012); ep.vx=-es.facing*190; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
      continue;
    }
    if(m2.type==='bomber'){
      m2.x+=m2.dir*(m2.spd||28)*dt; m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.004)*3;
      if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
      if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<38&&Math.abs(ep.y-m2.y)<38){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(300,0.015); ep.vx=-es.facing*190; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
      continue;
    }
    if(m2.type==='daikon'){
      m2.bT+=delta; m2.y=m2.baseY+Math.sin(m2.bT*0.003)*28;
      m2.x+=m2.dir*m2.spd*dt;
      if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
      if(es.hurtTimer<=0&&!ep.grounded&&Math.abs(ep.x-m2.x)<26&&Math.abs(ep.y-m2.y)<28){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012);
        ep.vx=-es.facing*190; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
      continue;
    }
    if(m2.type==='thrower'){
      m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.006)*2;
      m2.shotT=(m2.shotT||0)+delta;
      if(m2.shotT>=m2.shotInterval){
        m2.shotT=0; var sDir=ep.x>m2.x?1:-1; m2.dir=sDir;
        m2.projectiles.push({x:m2.x+sDir*20,y:m2.y-15,vx:sDir*220,life:1.0});
      }
      if(!m2.projectiles) m2.projectiles=[];
      for(var prj=m2.projectiles.length-1;prj>=0;prj--){
        var proj=m2.projectiles[prj]; proj.x+=proj.vx*dt; proj.life-=0.007*delta;
        if(es.hurtTimer<=0&&Math.abs(proj.x-ep.x)<18&&Math.abs(proj.y-ep.y)<18){
          EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          SOUND.hurt(); this.cameras.main.shake(200,0.01);
          es.hurtTimer=1200; ep.vx=-proj.vx*0.35; ep.vy=-140;
          m2.projectiles.splice(prj,1);
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
          continue;
        }
        if(proj.life<=0||proj.x<0||proj.x>LW) m2.projectiles.splice(prj,1);
      }
      continue;
    }
    // Standard mochi + tank
    m2.x+=m2.dir*m2.spd*dt; m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.006)*4;
    if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
    var cRange=m2.type==='tank'?44:32;
    if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<cRange&&Math.abs(ep.y-m2.y)<cRange){
      es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
      SOUND.hurt(); this.cameras.main.shake(300,0.015);
      var kb=m2.type==='tank'?320:190;
      ep.vx=-es.facing*kb; ep.vy=-210;
      if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
    }
  }
  // Pickups
  for(var ai=0;ai<this.pickups.length;ai++){
    var ap=this.pickups[ai]; if(ap.collected) continue;
    ap.bobT+=delta;
    if(Math.abs(ep.x-ap.x)+Math.abs(ep.y-ap.y)<(EWR_STATE.shop.aloeMagnet?140:44)){
      ap.collected=true;EWR_STATE.aloe+=ALOE.aloePickup;
      spawnExplosion(ap.x,ap.y,0x00e676,1); SOUND.pickup();
      this._flash('+'+ALOE.aloePickup+' ALOE',1200);
    }
  }
  if(!this.checkpt&&ep.x>2700){this.checkpt=true;this._flash('CHECKPOINT!',1600);EWR_STATE.health[0]=EWR_STATE.maxHealth[0];}
  if(ep.x>4760){this._beatLevel();return;}
  // Particles
  es.cigF++; es.smokeT+=delta;
  if(es.smokeT>950){es.smokeT=0;spawnSmoke(ep.x+es.facing*14,ep.y-25);}
  updateSmoke(); updateExplosions(); updateFire();
  // Nuclear clouds
  this._nukeT+=delta;
  if(this._nukeT>=this._nukeInterval){
    this._nukeT=0; this._nukeInterval=30000+Math.random()*20000;
    spawnNuke(); this._flash('NUCLEAR EVENT DETECTED',1400,14,'#ff4444',0,90);
  }
  updateNukes(delta); this.nukeG.clear(); drawNukes(this.nukeG);
  // News ticker scroll
  this._tickX-=1.5*(delta/16);
  this.tickerTxt.setPosition(this._tickX,526);
  if(this._tickX<-this.tickerTxt.width){
    this._tickN=(this._tickN+1)%NEWS_TICKER.length;
    this.tickerTxt.setText('⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ');
    this._tickX=960;
  }
  if(EWR_STATE.combo.streak>=10){spawnFire(ep.x+(Math.random()-0.5)*18,ep.y-16);spawnFire(ep.x+(Math.random()-0.5)*18,ep.y-8);}
  // Cats update
  for(var ci2=0;ci2<this.cats.length;ci2++){
    var cat=this.cats[ci2]; cat.tailAng+=0.04; cat.wT+=delta; cat.danceT+=delta;
    if(!cat.following&&!cat.sitting&&cat.wT>2500){cat.wT=0;cat.wDir*=-1;}
  }
  // Animation frame
  var frame=0;
  if(es.hurtTimer>900)         frame=7;
  else if(!ep.grounded)        frame=4;
  else if(es.kickTimer>400)    frame=6;
  else if(es.punchTimer>200||ep.chargeT>200) frame=5;
  else if(Math.abs(ep.vx)>20) frame=Math.floor(this.levelT/120)%4;
  // Camera
  var camX=Phaser.Math.Clamp(ep.x-480,0,LW-960);
  this.cameras.main.scrollX=camX; this.cameras.main.scrollY=0;
  // Psychedelic low-HP
  this.psychG.clear();
  if(EWR_STATE.health[0]<=1&&EWR_STATE.maxHealth[0]>0){
    var pt=this.levelT;
    this.cameras.main.setRotation(Math.sin(pt*0.003)*0.012);
    var tintIdx=Math.floor(pt/500)%6;
    var tintCols=[0xff0044,0x00ffff,0xffff00,0xff00ff,0x00ff88,0xcc44ff];
    this.psychG.fillStyle(tintCols[tintIdx],0.07+Math.sin(pt*0.007)*0.03);
    this.psychG.fillRect(0,0,960,540);
    this.psychG.fillStyle(0xff0000,0.18+Math.sin(pt*0.005)*0.06);
    this.psychG.fillRect(0,0,960,55); this.psychG.fillRect(0,485,960,55);
    this.psychG.fillRect(0,0,55,540); this.psychG.fillRect(905,0,55,540);
  } else {
    this.cameras.main.setRotation(0);
  }
  // Draw cats
  this.catG.clear();
  for(var ci3=0;ci3<this.cats.length;ci3++){
    var c=this.cats[ci3];
    if(Math.abs(c.x-ep.x)<700) DRAW_CAT.draw(this.catG,c.x,c.y,CAT_COLORS[c.ci],c.tailAng,c.following?es.facing:c.wDir,c.sitting,c.dance||c.following,c.smoker,c.danceT);
  }
  // Draw mochis
  this.mochiG.clear();
  for(var mi3=0;mi3<this.mochiList.length;mi3++){var m3=this.mochiList[mi3];if(Math.abs(m3.x-ep.x)<700)this._drawMochi(this.mochiG,m3);}
  // Draw pickups
  this.pickupG.clear();
  for(var ai2=0;ai2<this.pickups.length;ai2++){var ap2=this.pickups[ai2];if(ap2.collected)continue;if(Math.abs(ap2.x-ep.x)<700){var bob=Math.sin(ap2.bobT*0.003)*5;this._drawAloe(this.pickupG,ap2.x,ap2.y+bob);}}
  // Draw Ed
  this.edG.clear();
  DRAW_ED.draw(this.edG,ep.x,ep.y,frame,es.facing<0,es.cigF);
  if(ep.chargeT>0){var cr=Math.min(ep.chargeT/1200,1.0);this.edG.fillStyle(cr>=1?0xffffff:0xff6600,0.3+cr*0.5);this.edG.fillCircle(ep.x+es.facing*28,ep.y-27,5+cr*14);}
  if(es.punchActive){this.edG.fillStyle(0xffd60a,0.15);this.edG.fillCircle(ep.x+es.facing*56,ep.y-20,28);}
  if(es.kickActive){this.edG.fillStyle(0xff6b35,0.18);this.edG.fillCircle(ep.x+es.facing*ED_MOVE.kickRange,ep.y-10,32);}
  drawExplosions(this.edG); drawFire(this.edG);
  for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];this.edG.fillStyle(0xaaaaaa,p.life*0.3);this.edG.fillCircle(p.x,p.y,p.r);}
  // Combo text
  if(EWR_STATE.combo.streak>=3){
    var cStr=EWR_STATE.combo.streak>=10?'ON FIRE '+EWR_STATE.combo.streak+'x':EWR_STATE.combo.streak+'x COMBO';
    var cCol=EWR_STATE.combo.streak>=10?'#ff6b00':EWR_STATE.combo.streak>=6?'#ffd60a':'#ffffff';
    this.comboText.setText(cStr).setPosition(ep.x,ep.y-80).setStyle({color:cCol}).setAlpha(1);
  } else { this.comboText.setAlpha(0); }
  // Controls HUD
  if(this.levelT<30000){
    var ha=this.levelT<25000?0.88:0.88*(1-(this.levelT-25000)/5000);
    this.ctrlPanel.clear();
    this.ctrlPanel.fillStyle(parseInt(AT.uiBg.slice(1),16),ha*0.82);
    this.ctrlPanel.fillRoundedRect(608,390,344,114,6);
    this.ctrlPanel.lineStyle(1,parseInt(AT.uiGold.slice(1),16),ha*0.5);
    this.ctrlPanel.strokeRoundedRect(608,390,344,114,6);
    for(var li=0;li<this.ctrlLines.length;li++) this.ctrlLines[li].setAlpha(ha);
  } else {
    this.ctrlPanel.clear();
    for(var li2=0;li2<this.ctrlLines.length;li2++) this.ctrlLines[li2].setAlpha(0);
  }
  // HUD
  this.hudG.clear(); DRAW_HUD.draw(this.hudG);
  this.aloeText.setText(EWR_STATE.aloe+' ALOE');
};
Level11Scene.prototype._triggerDeath=function(){
  if(this._dying) return;
  this._dying=true; this._dyingT=0;
  SOUND.death(); this.cameras.main.shake(400,0.02);
};
Level11Scene.prototype._flash=function(msg,dur,sz,col,delay,fy){
  var self=this,ft=this.flashTxt;
  if(fy||sz){
    var tmp=this.add.text(480,fy||270,msg,{fontFamily:'Courier New,monospace',fontSize:(sz||42)+'px',color:col||AT.uiGold,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(20);
    this.tweens.add({targets:tmp,alpha:0,delay:(delay||0)+(dur-600),duration:600,onComplete:function(){tmp.destroy();}});
    return;
  }
  ft.setText(msg).setAlpha(1);
  this.tweens.add({targets:ft,alpha:0,delay:dur-600,duration:600});
};
Level11Scene.prototype._drawLevel=function(g,LW,H){
  g.fillStyle(parseInt(AT.grassDark.slice(1),16),1); g.fillRect(0,490,LW,4);
  g.fillStyle(parseInt(AT.grass.slice(1),16),1);     g.fillRect(0,494,LW,8);
  g.fillStyle(parseInt(AT.dirt.slice(1),16),1);      g.fillRect(0,502,LW,38);
  var bldgs=[
    {x:0,w:120,h:260,c:0x3d5a7a},{x:130,w:80,h:200,c:0x4a6b8a},{x:220,w:150,h:320,c:0x2d4a6a},
    {x:380,w:100,h:180,c:0x5a7a9a},{x:490,w:130,h:240,c:0x3d5a7a},{x:700,w:90,h:210,c:0x4a6b8a},
    {x:950,w:110,h:270,c:0x3d5a7a},{x:1200,w:80,h:190,c:0x4a6b8a},{x:1450,w:140,h:300,c:0x2d4a6a},
    {x:1800,w:90,h:220,c:0x5a7a9a},{x:2200,w:120,h:260,c:0x3d5a7a},{x:2600,w:80,h:200,c:0x4a6b8a},
    {x:3000,w:110,h:240,c:0x2d4a6a},{x:3400,w:90,h:180,c:0x5a7a9a},{x:3800,w:130,h:280,c:0x3d5a7a},
    {x:4200,w:100,h:220,c:0x4a6b8a},{x:4550,w:120,h:250,c:0x2d4a6a}
  ];
  bldgs.forEach(function(b){
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRect(b.x-1,490-b.h-1,b.w+2,b.h+2);
    g.fillStyle(b.c,1); g.fillRect(b.x,490-b.h,b.w,b.h);
    g.fillStyle(0xffd60a,0.55);
    for(var wr=0;wr<Math.floor(b.h/40);wr++)
      for(var wc=0;wc<Math.floor(b.w/22);wc++)
        if(Math.random()>0.38) g.fillRect(b.x+6+wc*20,490-b.h+12+wr*36,12,16);
  });
  for(var pi=1;pi<this.platRects.length;pi++){
    var p=this.platRects[pi];
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillRoundedRect(p.x-2,p.y-2,p.w+4,p.h+4,4);
    g.fillStyle(parseInt(AT.grass.slice(1),16),1);   g.fillRect(p.x,p.y,p.w,p.h/2+2);
    g.fillStyle(parseInt(AT.dirt.slice(1),16),1);    g.fillRect(p.x,p.y+p.h/2,p.w,p.h/2);
  }
};
Level11Scene.prototype._spawnMochiParts=function(m){
  m.parts=[];
  var cols=[0xf4a8c7,0xcc5599,0xffd60a,0xff6b35,0x00e676];
  for(var i=0;i<12;i++){var a=(i/12)*Math.PI*2;m.parts.push({x:m.x,y:m.y,vx:Math.cos(a)*(2+Math.random()*4),vy:Math.sin(a)*(2+Math.random()*4)-3,life:1,color:cols[i%5],r:3+Math.random()*5});}
};
Level11Scene.prototype._drawMochi=function(g,m){
  if(m.dieT>=0){
    // Squish phase (0-320ms)
    if(m.squishT<320){
      var t=m.squishT/320;
      var scx=t<0.5?1+t*0.55:1.55-(t-0.5)*2.6; if(scx<0) scx=0;
      var scy=t<0.5?1-t*0.35:0.825+(t-0.5)*0.1;
      var sal=t<0.5?1:Math.max(0,1-(t-0.5)*2);
      if(sal>0){
        var my2=m.y+m.bAmt;
        g.save(); g.translateCanvas(m.x,my2-13); g.scaleCanvas(scx,scy);
        g.fillStyle(parseInt(AT.outline.slice(1),16),sal); g.fillCircle(0,0,17);
        g.fillStyle(parseInt(AT.mochiFg.slice(1),16),sal); g.fillCircle(0,0,15);
        g.restore();
      }
      return;
    }
    for(var i=0;i<m.parts.length;i++){var p=m.parts[i];if(p.life>0){g.fillStyle(p.color,p.life);g.fillCircle(p.x,p.y,p.r);}}
    return;
  }
  // Ghost: translucent blue shimmer
  if(m.type==='ghost'){
    var ga=0.25+Math.sin((m.bT||0)*0.005)*0.12;
    g.fillStyle(0x0000aa,0.12); g.fillEllipse(m.x,m.y+2,28,8);
    g.fillStyle(0xaaccff,ga+0.15); g.fillCircle(m.x,m.y-13,16);
    g.fillStyle(0xeeeeff,ga); g.fillCircle(m.x,m.y-13,13);
    g.fillStyle(0x00ffff,0.85); g.fillCircle(m.x-5,m.y-17,4); g.fillCircle(m.x+5,m.y-17,4);
    g.fillStyle(0x000000,1); g.fillCircle(m.x-5,m.y-17,2); g.fillCircle(m.x+5,m.y-17,2);
    for(var gh=0;gh<m.hp;gh++){g.fillStyle(0x00ffff,0.7);g.fillCircle(m.x-3+gh*6,m.y-32,2);}
    return;
  }
  // Bomber: round red pulsing ball with LED timer
  if(m.type==='bomber'){
    var bpulse=0.88+Math.sin((m.bT||0)*0.008)*0.12;
    g.fillStyle(0x000000,0.22); g.fillEllipse(m.x,m.y+2,36*bpulse,10);
    g.fillStyle(0xff2200,0.35); g.fillCircle(m.x,m.y-13,26*bpulse);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(m.x,m.y-13,20*bpulse);
    g.fillStyle(0xdd2200,1); g.fillCircle(m.x,m.y-13,18*bpulse);
    g.fillStyle(0xff5500,0.55); g.fillCircle(m.x-6,m.y-18,5); g.fillCircle(m.x+7,m.y-12,4);
    g.fillStyle(0x1a0000,1); g.fillEllipse(m.x-5,m.y-16,5,4); g.fillEllipse(m.x+5,m.y-16,5,4);
    var ledOn=Math.sin((m.bT||0)*0.014)>0;
    g.fillStyle(ledOn?0xff0000:0x550000,1); g.fillCircle(m.x,m.y-8,4);
    g.fillStyle(0xff4444,1); g.fillRect(m.x-18,m.y-35,Math.max(0,36*(m.hp/5)),4);
    g.lineStyle(1,0xffffff,0.4); g.strokeRect(m.x-18,m.y-35,36,4);
    return;
  }
  // Rasta cat: orange body, 3-stripe rasta hat, dreads, red eyes, green HP dots
  if(m.type==='rasta'){
    g.fillStyle(0x1a0a00,1); g.fillEllipse(m.x,m.y+2,30,8);
    g.fillStyle(0xff8800,1); g.fillCircle(m.x,m.y-13,15);
    g.fillStyle(0xffcc44,0.5); g.fillCircle(m.x-5,m.y-17,5);
    g.fillStyle(0x117700,1); g.fillRoundedRect(m.x-12,m.y-28,24,9,3);
    g.fillStyle(0xffdd00,1); g.fillRect(m.x-12,m.y-25,24,3);
    g.fillStyle(0xff2200,1); g.fillRect(m.x-12,m.y-22,24,3);
    for(var dr=0;dr<5;dr++){
      var rdx=m.x-10+dr*5;
      g.fillStyle(0x553300,1); g.fillRect(rdx,m.y-27+Math.sin((m.bT||0)*0.004+dr)*2,3,14);
    }
    g.fillStyle(0xff3300,0.9); g.fillCircle(m.x-4,m.y-16,3); g.fillCircle(m.x+4,m.y-16,3);
    for(var rh=0;rh<m.hp;rh++){g.fillStyle(0x00cc00,1);g.fillCircle(m.x-5+rh*5,m.y-32,2);}
    return;
  }
  var scl=m.type==='tank'?1.5:1;
  var my=m.y+m.bAmt;
  g.fillStyle(0x000000,0.18); g.fillEllipse(m.x,m.y+2,28*scl,8);
  g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillCircle(m.x,my-13,17*scl);
  g.fillStyle(parseInt(AT.mochiFg.slice(1),16),1); g.fillCircle(m.x,my-13,15*scl);
  g.fillStyle(parseInt(AT.mochiFg2.slice(1),16),0.4); g.fillCircle(m.x-5*scl,my-17*scl,5*scl); g.fillCircle(m.x+6*scl,my-10*scl,4*scl);
  g.fillStyle(0x1a0000,1); g.fillEllipse(m.x-5*scl,my-15*scl,5*scl,4*scl); g.fillEllipse(m.x+5*scl,my-15*scl,5*scl,4*scl);
  g.lineStyle(2*scl,0x1a0000,1);
  g.lineBetween(m.x-8*scl,my-19*scl,m.x-2*scl,my-16*scl); g.lineBetween(m.x+2*scl,my-16*scl,m.x+8*scl,my-19*scl);
  g.beginPath(); g.moveTo(m.x-5*scl,my-9*scl); g.lineTo(m.x,my-11*scl); g.lineTo(m.x+5*scl,my-9*scl); g.strokePath();
  if(m.type!=='tank') { for(var h=0;h<m.hp;h++){g.fillStyle(parseInt(AT.aloe.slice(1),16),1);g.fillCircle(m.x-5+h*5,my-30,2);} }
  if(m.sunglasses){g.fillStyle(0x111111,0.95);g.fillRoundedRect(m.x-9*scl,my-17*scl,7*scl,5*scl,2);g.fillRoundedRect(m.x+2*scl,my-17*scl,7*scl,5*scl,2);}
  // Tank beret
  if(m.type==='tank'){
    g.fillStyle(0x333388,1); g.fillEllipse(m.x,my-35,32,9);
    g.fillStyle(0x2244aa,1); g.fillRoundedRect(m.x-10,my-41,20,10,3);
    g.fillStyle(0x3355cc,1); g.fillCircle(m.x+2,my-42,4);
    // HP bar
    g.fillStyle(0xff4444,1); g.fillRect(m.x-18,my-55,Math.max(0,36*(m.hp/4)),4);
    g.lineStyle(1,0xffffff,0.4); g.strokeRect(m.x-18,my-55,36,4);
  }
  // Daikon drone
  if(m.type==='daikon'){
    g.save(); g.translateCanvas(m.x,m.y);
    g.fillStyle(parseInt(AT.outline.slice(1),16),1); g.fillEllipse(0,-2,20,30);
    g.fillStyle(0xffffff,1); g.fillEllipse(0,-2,18,28);
    g.fillStyle(0xff99bb,0.5); g.fillEllipse(-3,-6,7,14);
    g.fillStyle(parseInt(AT.grassDark.slice(1),16),1);
    g.fillTriangle(-5,-14,-2,-28,2,-14); g.fillTriangle(0,-14,4,-27,7,-14);
    g.fillStyle(0x1a0000,1); g.fillEllipse(-4,-4,4,4); g.fillEllipse(4,-4,4,4);
    g.lineStyle(1,0x1a0000,1); g.lineBetween(-7,-9,-2,-7); g.lineBetween(2,-7,7,-9);
    g.restore();
    return;
  }
  // Thrower baseball cap
  if(m.type==='thrower'){
    g.fillStyle(0x1144cc,1); g.fillRect(m.x-12,my-28,24,5);
    g.fillStyle(0x2255dd,1); g.fillRoundedRect(m.x-9,my-34,18,10,3);
    g.fillStyle(0x4466ee,1); g.fillCircle(m.x+2,my-35,3);
    // Draw projectiles
    if(m.projectiles){for(var prj2=0;prj2<m.projectiles.length;prj2++){var pj=m.projectiles[prj2];g.fillStyle(parseInt(AT.mochiFg.slice(1),16),pj.life*0.9);g.fillCircle(pj.x,pj.y,7);}}
  }
};
Level11Scene.prototype._drawAloe=function(g,x,y){
  g.fillStyle(parseInt(AT.aloe.slice(1),16),0.18); g.fillCircle(x,y,22);
  g.fillStyle(parseInt(AT.aloe.slice(1),16),0.38); g.fillCircle(x,y,14);
  g.fillStyle(parseInt(AT.outline.slice(1),16),1);
  g.fillTriangle(x-2,y+8,x-8,y-8,x+4,y-12); g.fillTriangle(x+2,y+8,x+8,y-8,x+12,y-4);
  g.fillStyle(parseInt(AT.aloe.slice(1),16),1);
  g.fillTriangle(x-1,y+6,x-6,y-6,x+3,y-10); g.fillTriangle(x+1,y+6,x+7,y-7,x+11,y-3);
  g.fillStyle(parseInt(AT.aloeDk.slice(1),16),1); g.fillTriangle(x-1,y+7,x-3,y,x+3,y);
};
Level11Scene.prototype._emberBlast=function(){
  var ep=this.ep, es=this.es;
  var bx=ep.x+es.facing*80, by=ep.y-20;
  spawnExplosion(bx,by,0xff6b35,3.5); spawnExplosion(bx,by,0xffcc00,2);
  this.cameras.main.shake(150,0.012); SOUND.blast();
  this._flash('EMBER BLAST!',1000);
  try{var fl=this.add.graphics().setScrollFactor(0).setDepth(80);fl.fillStyle(0xffffff,0.55);fl.fillRect(0,0,960,540);this.time.delayedCall(70,function(){fl.destroy();});}catch(e){}
  for(var mi=0;mi<this.mochiList.length;mi++){
    var m=this.mochiList[mi]; if(m.dieT>=0) continue;
    var dist=Math.sqrt(Math.pow(bx-m.x,2)+Math.pow(by-m.y,2));
    if(dist<100){
      m.hp-=3; _addCombo(this,m.x,m.y);
      spawnExplosion(m.x,m.y-13,0xff6b35,1.5);
      if(m.hp<=0){m.dieT=0;m.squishT=0;EWR_STATE.aloe+=Math.ceil(ALOE.mochiDeath*EWR_STATE.combo.mult);this._spawnMochiParts(m);}
    }
  }
};
Level11Scene.prototype._die=function(){this._triggerDeath();};
Level11Scene.prototype._beatLevel=function(){
  if(this._beaten) return; this._beaten=true;
  if(EWR_STATE.levelsBeaten.indexOf('1-1')<0){EWR_STATE.levelsBeaten.push('1-1');EWR_STATE.aloe+=ALOE.beat11;}
  EWR_STATE.health[0]=EWR_STATE.maxHealth[0]; SMOKE_POOL.length=0; EX_POOL.length=0; FIRE_POOL.length=0;
  SOUND.victory(); this.cameras.main.shake(250,0.015);
  this._flash('LEVEL CLEAR! +'+ALOE.beat11+' ALOE',2800);
  var self=this;
  this.time.delayedCall(3000,function(){self.scene.start('WorldMap',{aloeEarned:ALOE.beat11});});
};

// ════════════════════════════════════════════════════════════════
// CHUNK 4: VPAD (MOBILE) + SCENE OVERRIDES + FACTORY + L12-L14
// ════════════════════════════════════════════════════════════════

// ── VIRTUAL GAMEPAD FOR MOBILE ───────────────────────────────────
var VPAD = {left:false,right:false,up:false,down:false,punch:false,kick:false};
function _patchKey(key, flag) {
  Object.defineProperty(key,'isDown',{
    get:function(){return VPAD[flag]||this._isDown;},
    set:function(v){this._isDown=v;},
    configurable:true, enumerable:true
  });
}
function _initVPad(scene) {
  VPAD.left=false; VPAD.right=false; VPAD.up=false; VPAD.down=false; VPAD.punch=false; VPAD.kick=false;
  _patchKey(scene.keys.left,  'left');
  _patchKey(scene.keys.right, 'right');
  _patchKey(scene.keys.altL,  'left');
  _patchKey(scene.keys.altR,  'right');
  _patchKey(scene.keys.up,    'up');
  _patchKey(scene.keys.altU,  'up');
  _patchKey(scene.keys.down,  'down');
  _patchKey(scene.keys.punch, 'punch');
  _patchKey(scene.keys.kick,  'kick');
  var vg=scene.add.graphics().setScrollFactor(0).setDepth(96);
  // D-pad circle background
  vg.fillStyle(0x000000,0.38); vg.fillCircle(127,432,112);
  vg.lineStyle(1.5,0xffffff,0.18); vg.strokeCircle(127,432,112);
  vg.lineStyle(1,0xffffff,0.1); vg.lineBetween(22,432,232,432); vg.lineBetween(127,325,127,540);
  // Direction arrows
  vg.fillStyle(0x44cc77,0.8); vg.fillTriangle(127,338,108,370,146,370);
  vg.fillStyle(0x44cc77,0.8); vg.fillTriangle(127,526,108,494,146,494);
  vg.fillStyle(0x88aaff,0.8); vg.fillTriangle(37,432,67,414,67,450);
  vg.fillStyle(0x88aaff,0.8); vg.fillTriangle(217,432,187,414,187,450);
  // Z button (punch)
  vg.fillStyle(0x000000,0.4); vg.fillCircle(800,479,60);
  vg.lineStyle(2,0xff8833,0.8); vg.strokeCircle(800,479,60);
  vg.fillStyle(0xcc4400,0.5); vg.fillCircle(800,479,57);
  // X button (kick)
  vg.fillStyle(0x000000,0.4); vg.fillCircle(912,479,40);
  vg.lineStyle(2,0xffd60a,0.8); vg.strokeCircle(912,479,40);
  vg.fillStyle(0x997700,0.52); vg.fillCircle(912,479,37);
  // Labels
  scene.add.text(800,466,'Z',{fontFamily:'Courier New,monospace',fontSize:'28px',color:'#ffaa55',fontStyle:'bold',stroke:'#000000',strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(97);
  scene.add.text(800,494,'PUNCH',{fontFamily:'Courier New,monospace',fontSize:'9px',color:'#ff9955'}).setOrigin(0.5).setScrollFactor(0).setDepth(97);
  scene.add.text(912,468,'X',{fontFamily:'Courier New,monospace',fontSize:'24px',color:'#ffdd44',fontStyle:'bold',stroke:'#000000',strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(97);
  scene.add.text(912,494,'KICK',{fontFamily:'Courier New,monospace',fontSize:'9px',color:'#ffdd44'}).setOrigin(0.5).setScrollFactor(0).setDepth(97);
  // Touch detection (circular d-pad + round action buttons)
  function _upd() {
    VPAD.left=false; VPAD.right=false; VPAD.up=false; VPAD.down=false; VPAD.punch=false; VPAD.kick=false;
    var ptrs=scene.input.manager.pointers;
    for(var i=0;i<ptrs.length;i++) {
      var p=ptrs[i]; if(!p.isDown) continue;
      var ddx=p.x-127,ddy=p.y-432;
      if(ddx*ddx+ddy*ddy<112*112) {
        if(Math.abs(ddy)>=Math.abs(ddx)){if(ddy<0)VPAD.up=true;else VPAD.down=true;}
        else{if(ddx<0)VPAD.left=true;else VPAD.right=true;}
      }
      var zdx=p.x-800,zdy=p.y-479; if(zdx*zdx+zdy*zdy<60*60) VPAD.punch=true;
      var xdx=p.x-912,xdy=p.y-479; if(xdx*xdx+xdy*xdy<42*42) VPAD.kick=true;
    }
  }
  scene.input.on('pointerdown',_upd);
  scene.input.on('pointermove',_upd);
  scene.input.on('pointerup',_upd);
}

// ── MOBILE TAP: BOOT + TITLE + LEVEL11 + WORLDMAP OVERRIDES ─────
(function(){
  var _origBoot=BootScene.prototype.create;
  BootScene.prototype.create=function(){
    _origBoot.call(this); var self=this;
    this.input.once('pointerdown',function(){SOUND.init();SMOKE_POOL.length=0;self.scene.start('Title');});
  };
  var _origTitle=TitleScene.prototype.create;
  TitleScene.prototype.create=function(){
    _origTitle.call(this); var self=this;
    this.input.once('pointerdown',function(){SMOKE_POOL.length=0;self.scene.start('WorldMap');});
  };
  var _origL11=Level11Scene.prototype.create;
  Level11Scene.prototype.create=function(){ _origL11.call(this); _initVPad(this); };
  var _origWM=WorldMapScene.prototype.create;
  WorldMapScene.prototype.create=function(){ _origWM.call(this); _initVPad(this); };
})();

// ── createLevelScene FACTORY ─────────────────────────────────────
function createLevelScene(cfg) {
  function LevelScene(){Phaser.Scene.call(this,{key:cfg.key});}
  LevelScene.prototype=Object.create(Phaser.Scene.prototype);
  LevelScene.prototype.constructor=LevelScene;

  LevelScene.prototype.create=function(){
    var W=960,H=540; var LW=cfg.LW;
    EX_POOL.length=0; SMOKE_POOL.length=0; FIRE_POOL.length=0; NUKE_POOL.length=0;
    this._dying=false; this._dyingT=0; this._beaten=false;
    this.platRects=[{x:0,y:490,w:LW,h:50}];
    for(var pi=0;pi<cfg.plats.length;pi++){var p=cfg.plats[pi];this.platRects.push({x:p[0],y:p[1],w:p[2],h:18});}
    this.levelG=this.add.graphics(); this._drawLevel(this.levelG,LW,H);
    this.cameras.main.setBounds(0,0,LW,H);
    this.ep={x:100,y:440,vx:0,vy:0,grounded:false,coyoteMs:0,jumpBufMs:0,chargeT:0,djUsed:false};
    this.es={facing:1,frame:0,cigF:0,smokeT:0,walkT:0,punchTimer:0,punchActive:false,kickTimer:0,kickActive:false,hurtTimer:0};
    this.edG=this.add.graphics().setDepth(5);
    this.cats=[]; this.catG=this.add.graphics().setDepth(3);
    for(var ci=0;ci<cfg.catX.length;ci++){this.cats.push({x:cfg.catX[ci],y:487,ci:ci%4,tailAng:Math.random()*Math.PI*2,wDir:Math.random()<0.5?1:-1,wT:Math.random()*3000,sitting:Math.random()<0.6,dance:Math.random()<0.25,smoker:Math.random()<0.28,danceT:Math.random()*1000,following:false,armyT:0,loyal:false});}
    this.mochiList=[]; this.mochiG=this.add.graphics().setDepth(4);
    for(var mi=0;mi<cfg.mochis.length;mi++){
      var mc=cfg.mochis[mi];
      var hp=mc.hp||(mc.type==='tank'?4:mc.type==='daikon'?2:mc.type==='thrower'?3:3);
      var mSpd=mc.spd||(45+Math.random()*25);
      var mY=mc.type==='daikon'||(mc.type==='ghost')?(mc.baseY||330):464;
      this.mochiList.push({x:mc.x,y:mY,hp:hp,spd:mSpd,dir:mc.dir||1,bT:0,bAmt:0,dieT:-1,squishT:0,parts:[],pMin:mc.pMin!==undefined?mc.pMin:mc.x-90,pMax:mc.pMax!==undefined?mc.pMax:mc.x+90,type:mc.type||'mochi',baseY:mc.baseY||330,sineT:Math.random()*100,projectiles:[],shotT:0,shotInterval:2200+Math.random()*1000});
    }
    this.pickups=[]; this.pickupG=this.add.graphics().setDepth(4);
    for(var ai=0;ai<cfg.pickups.length;ai++){this.pickups.push({x:cfg.pickups[ai][0],y:cfg.pickups[ai][1],collected:false,bobT:0});}
    this.hudG=this.add.graphics().setScrollFactor(0).setDepth(20);
    this.aloeText=this.add.text(40,22,'',{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setScrollFactor(0).setDepth(20);
    this.add.text(480,14,cfg.title,{fontFamily:'Georgia,serif',fontSize:'18px',color:AT.uiGold,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(20);
    this.flashTxt=this.add.text(480,270,'',{fontFamily:'Georgia,serif',fontSize:'42px',color:AT.uiGold,stroke:AT.outline,strokeThickness:5}).setOrigin(0.5).setScrollFactor(0).setDepth(20).setAlpha(0);
    this.comboText=this.add.text(0,0,'',{fontFamily:'Courier New,monospace',fontSize:'20px',color:'#ffd60a',stroke:AT.outline,strokeThickness:3}).setDepth(25).setAlpha(0);
    this.psychG=this.add.graphics().setScrollFactor(0).setDepth(50);
    this.dyingG=this.add.graphics().setScrollFactor(0).setDepth(90);
    this.dyingTxt=this.add.text(480,230,'',{fontFamily:'Georgia,serif',fontSize:'46px',color:'#ffffff',stroke:'#000000',strokeThickness:6}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
    this.dyingTxt2=this.add.text(480,295,'',{fontFamily:'Courier New,monospace',fontSize:'24px',color:'#aaaaaa'}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
    this.crtG=this.add.graphics().setScrollFactor(0).setDepth(99);
    if(EWR_STATE.shop.crtFilter){this.crtG.fillStyle(0x000000,0.14);for(var cr=0;cr<540;cr+=4)this.crtG.fillRect(0,cr,960,1);}
    this.keys={
      left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
      right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
      up:   this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
      down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
      punch:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),
      kick: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),
      altL: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
      altR: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
      altU: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
      altD: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S)
    };
    this.levelT=0; this.checkpt=false;
    this.nukeG=this.add.graphics().setScrollFactor(0).setDepth(2);
    this._nukeT=0; this._nukeInterval=30000+Math.random()*20000;
    this._tickX=960; this._tickN=Math.floor(Math.random()*NEWS_TICKER.length);
    this.tickerTxt=this.add.text(960,526,'⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ',
      {fontFamily:'Courier New,monospace',fontSize:'11px',color:'#ff4444',stroke:'#000000',strokeThickness:2})
      .setScrollFactor(0).setDepth(22);
    _initVPad(this);
    this._flash(cfg.intro,2400);
  };

  LevelScene.prototype.update=function(time,delta){
    var LW=cfg.LW;
    if(this._dying){
      this._dyingT+=delta;
      var fa=Math.min(this._dyingT/700,0.92);
      this.dyingG.clear(); this.dyingG.fillStyle(0x000000,fa); this.dyingG.fillRect(0,0,960,540);
      if(this._dyingT>800&&this.dyingTxt.alpha<1){this.dyingTxt.setText('ED NEEDS A MINUTE').setAlpha(1);this.dyingTxt2.setText('...').setAlpha(1);}
      if(this._dyingT>2600){EWR_STATE.health[0]=EWR_STATE.maxHealth[0];EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;for(var ca=0;ca<this.cats.length;ca++){this.cats[ca].following=false;this.cats[ca].loyal=false;}this.scene.restart();}
      return;
    }
    this.levelT+=delta;
    var dt=delta/1000, ep=this.ep, es=this.es;
    var pad=this.input.gamepad&&this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;
    var gpL=false,gpR=false,gpJ=false,gpKick=false,gpPunchHeld=false;
    if(pad){
      var axV=pad.axes.length>0?pad.axes[0].getValue():0;
      var ayV=pad.axes.length>1?pad.axes[1].getValue():0;
      gpL=(pad.left)||(axV<-0.3); gpR=(pad.right)||(axV>0.3);
      gpJ=(pad.up)||(pad.A&&pad.A.pressed)||(ayV<-0.5);
      gpPunchHeld=!!(pad.X&&pad.X.pressed);
      var kNow=pad.B&&pad.B.pressed; gpKick=kNow&&!this._prevKickGP; this._prevKickGP=kNow;
    }
    var goL=this.keys.left.isDown||this.keys.altL.isDown||gpL;
    var goR=this.keys.right.isDown||this.keys.altR.isDown||gpR;
    var goJ=this.keys.up.isDown||this.keys.altU.isDown||gpJ;
    var goD=this.keys.down.isDown||this.keys.altD.isDown;
    var doKick=Phaser.Input.Keyboard.JustDown(this.keys.kick)||gpKick;
    var zHeld=this.keys.punch.isDown||gpPunchHeld;
    var zWasHeld=this._prevZHeld||false;
    var zJustReleased=(!zHeld)&&zWasHeld;
    if(zHeld&&es.punchTimer<=0&&es.kickTimer<=0){var _pct=ep.chargeT;ep.chargeT+=delta;if(ep.chargeT>200&&Math.floor(ep.chargeT/300)>Math.floor(_pct/300))SOUND.charge();}
    if(zJustReleased&&es.punchTimer<=0&&es.kickTimer<=0){
      if(ep.chargeT>=1200){this._emberBlast();}
      else if(ep.chargeT>=60){es.punchTimer=340;es.punchActive=true;SOUND.punch();}
      ep.chargeT=0;
    }
    if(!zHeld) ep.chargeT=Math.max(0,ep.chargeT-delta*3);
    this._prevZHeld=zHeld;
    var tVx=0;
    if(goL){tVx=-ED_MOVE.walkSpeed;es.facing=-1;}
    if(goR){tVx= ED_MOVE.walkSpeed;es.facing= 1;}
    if(goD&&ep.grounded) tVx*=0.35;
    var airM=ep.grounded?1:ED_MOVE.airControl;
    ep.vx+=(tVx-ep.vx)*Math.min(1,12*dt*airM);
    var wasGrounded=ep.grounded;
    if(goJ) ep.jumpBufMs=ED_MOVE.jumpBufMs;
    else ep.jumpBufMs=Math.max(0,ep.jumpBufMs-delta);
    if(ep.grounded) ep.coyoteMs=ED_MOVE.coyoteMs;
    else ep.coyoteMs=Math.max(0,ep.coyoteMs-delta);
    if(ep.jumpBufMs>0&&ep.coyoteMs>0&&ep.vy>=-10){
      ep.vy=ED_MOVE.jumpVel; ep.jumpBufMs=0; ep.coyoteMs=0; ep.grounded=false;
      SOUND.jump();
      if(EWR_STATE.shop.doubleJump&&!ep.djUsed){ep.djUsed=false;}
    }
    if(!goJ&&ep.vy<0) ep.vy*=ED_MOVE.jumpCut;
    if(EWR_STATE.shop.doubleJump&&!ep.grounded&&wasGrounded===false&&ep.coyoteMs<=0&&ep.jumpBufMs>0&&ep.vy>0&&!ep.djUsed){
      ep.vy=ED_MOVE.jumpVel*0.82; ep.djUsed=true; ep.jumpBufMs=0; SOUND.jump();
      spawnExplosion(ep.x,ep.y,0x00ffff,0.8);
    }
    if(ep.grounded) ep.djUsed=false;
    ep.vy=Math.min(ep.vy+800*dt,ED_MOVE.maxFall);
    ep.x+=ep.vx*dt; ep.y+=ep.vy*dt;
    ep.grounded=false;
    var edL=ep.x-14,edR=ep.x+14,edBot=ep.y;
    if(edBot>=490&&ep.vy>=0){ep.y=490;ep.vy=0;ep.grounded=true;}
    for(var pi2=1;pi2<this.platRects.length;pi2++){
      var pl=this.platRects[pi2];
      if(ep.vy>=0&&edBot>=pl.y&&edBot<=pl.y+pl.h+6&&edL<pl.x+pl.w&&edR>pl.x){
        if(edBot-ep.vy*dt<pl.y+3){ep.y=pl.y;ep.vy=0;ep.grounded=true;}
      }
    }
    if(ep.x<14){ep.x=14;ep.vx=0;} if(ep.x>LW-14){ep.x=LW-14;ep.vx=0;}
    if(ep.y>620){this._triggerDeath();return;}
    if(es.hurtTimer>0) es.hurtTimer-=delta;
    if(es.punchTimer>0){es.punchTimer-=delta;es.punchActive=es.punchTimer>90;}
    if(doKick&&es.kickTimer<=0&&es.punchTimer<=0){es.kickTimer=600;es.kickActive=true;}
    if(es.kickTimer>0){es.kickTimer-=delta;es.kickActive=es.kickTimer>200;}
    if(EWR_STATE.combo.streak>0){EWR_STATE.combo.timer-=delta;if(EWR_STATE.combo.timer<=0){EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;}}
    var punchConsumed=false;
    if(es.punchActive){
      var hx=ep.x+es.facing*56;
      for(var mi2=0;mi2<this.mochiList.length;mi2++){
        var m=this.mochiList[mi2]; if(m.dieT>=0) continue;
        if(m.type==='daikon'&&ep.grounded) continue;
        var hRange=(m.type==='tank')?70:52, hRangeY=(m.type==='tank')?50:36;
        if(Math.abs(hx-m.x)<hRange&&Math.abs(ep.y-m.y)<hRangeY){
          m.hp--; spawnExplosion(m.x,m.y-13,0xffd60a,1); SOUND.punch();
          this.cameras.main.shake(80,0.005); _addCombo(this,m.x,m.y);
          if(m.hp<=0){m.dieT=0;m.squishT=0;EWR_STATE.aloe+=Math.ceil((m.type==='rasta'?ALOE.rastaDeath:m.type==='ghost'?ALOE.ghostDeath:m.type==='bomber'?ALOE.bomberDeath:m.type==='tank'?ALOE.tankDeath:m.type==='daikon'?ALOE.daikonDeath:m.type==='thrower'?ALOE.throwerDeath:ALOE.mochiDeath)*EWR_STATE.combo.mult);spawnExplosion(m.x,m.y-13,0xff4444,2);this._spawnMochiParts(m);if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}}
          if(EWR_STATE.shop.explosiveCig) spawnExplosion(ep.x+es.facing*56,ep.y-20,0xff6b35,1.2);
          es.punchActive=false; punchConsumed=true; break;
        }
      }
    }
    if(es.kickActive){
      var kx=ep.x+es.facing*ED_MOVE.kickRange;
      for(var ki=0;ki<this.mochiList.length;ki++){
        var km=this.mochiList[ki]; if(km.dieT>=0) continue;
        if(km.type==='daikon'&&ep.grounded) continue;
        if(Math.abs(kx-km.x)<65&&Math.abs(ep.y-km.y)<42){
          km.hp-=2; spawnExplosion(km.x,km.y-13,0xff6b35,1.5); SOUND.kick();
          this.cameras.main.shake(120,0.008); _addCombo(this,km.x,km.y);
          if(km.hp<=0){km.dieT=0;km.squishT=0;EWR_STATE.aloe+=Math.ceil((km.type==='rasta'?ALOE.rastaDeath:km.type==='ghost'?ALOE.ghostDeath:km.type==='bomber'?ALOE.bomberDeath:km.type==='tank'?ALOE.tankDeath:km.type==='daikon'?ALOE.daikonDeath:km.type==='thrower'?ALOE.throwerDeath:ALOE.mochiDeath)*EWR_STATE.combo.mult);spawnExplosion(km.x,km.y-13,0xff4444,2.5);this._spawnMochiParts(km);if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}}
          es.kickActive=false; break;
        }
      }
    }
    if(zJustReleased&&!punchConsumed&&ep.chargeT<100){
      var petted=false;
      for(var catI=0;catI<this.cats.length;catI++){
        var pc=this.cats[catI];
        if(Math.abs(ep.x-pc.x)<52&&Math.abs(ep.y-pc.y)<44){
          if(!pc.loyal&&pc.sitting){
            pc.loyal=true; pc.following=true; pc.dance=true; pc.sitting=false;
            EWR_STATE.aloe+=ALOE.catPet; EWR_STATE.catsPetted++;
            SOUND.pickup(); this._flash('+'+ALOE.catPet+' ALOE  (meow)',1000); petted=true;
          } else {
            var line=ED_LINES[Math.floor(Math.random()*ED_LINES.length)];
            try{var bbl=this.add.text(ep.x,ep.y-72,'"'+line+'"',{fontFamily:'Courier New,monospace',fontSize:'14px',color:'#ffffff',stroke:'#000000',strokeThickness:3,backgroundColor:'#1a0a2e',padding:{x:5,y:3}}).setDepth(26);this.time.delayedCall(1800,function(){bbl.destroy();});}catch(e){}
            petted=true;
          }
          break;
        }
      }
    }
    for(var ci2=0;ci2<this.cats.length;ci2++){
      var ac=this.cats[ci2]; if(!ac.following) continue;
      ac.armyT+=delta;
      var txc=ep.x-es.facing*(60+ci2*32);
      ac.x+=(txc-ac.x)*0.08; ac.y+=(487-ac.y)*0.1;
      if(ac.armyT>=2000){
        ac.armyT=0;
        for(var ami=0;ami<this.mochiList.length;ami++){
          var am=this.mochiList[ami]; if(am.dieT>=0) continue;
          if(Math.abs(ac.x-am.x)<48&&Math.abs(ac.y-am.y)<40){
            am.hp--; spawnExplosion(am.x,am.y-10,0xffcc00,0.8);
            if(am.hp<=0){am.dieT=0;am.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath;spawnExplosion(am.x,am.y-13,0xff4444,1.5);this._spawnMochiParts(am);}
            break;
          }
        }
      }
    }
    for(var mi3=0;mi3<this.mochiList.length;mi3++){
      var m2=this.mochiList[mi3];
      if(m2.dieT>=0){
        if(m2.type==='bomber'&&!m2._exploded){
          m2._exploded=true;
          spawnExplosion(m2.x,m2.y-15,0xff2200,2.5); SOUND.blast();
          if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<70&&Math.abs(ep.y-m2.y)<60){
            EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
            es.hurtTimer=1200; SOUND.hurt(); this.cameras.main.shake(300,0.015);
            if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
          }
        }
        m2.dieT+=delta; m2.squishT+=delta;
        for(var pp=0;pp<m2.parts.length;pp++){var pt=m2.parts[pp];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.3;pt.life-=0.025;}
        continue;
      }
      if(m2.type==='rasta'){
        m2.bT+=delta; m2.x+=m2.dir*m2.spd*dt;
        if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
        if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<28&&Math.abs(ep.y-m2.y)<36){
          es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          SOUND.hurt(); this.cameras.main.shake(250,0.012); ep.vx=-es.facing*190; ep.vy=-210;
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        }
        continue;
      }
      if(m2.type==='ghost'){
        m2.bT+=delta; m2.x+=m2.dir*m2.spd*dt;
        m2.y=(m2.baseY||320)+Math.sin(m2.bT*0.003)*22;
        if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
        if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<26&&Math.abs(ep.y-m2.y)<30){
          es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          SOUND.hurt(); this.cameras.main.shake(250,0.012); ep.vx=-es.facing*190; ep.vy=-210;
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        }
        continue;
      }
      if(m2.type==='bomber'){
        m2.x+=m2.dir*(m2.spd||28)*dt; m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.004)*3;
        if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
        if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<38&&Math.abs(ep.y-m2.y)<38){
          es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          SOUND.hurt(); this.cameras.main.shake(300,0.015); ep.vx=-es.facing*190; ep.vy=-210;
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        }
        continue;
      }
      if(m2.type==='daikon'){
        m2.bT+=delta; m2.y=m2.baseY+Math.sin(m2.bT*0.003)*28;
        m2.x+=m2.dir*m2.spd*dt;
        if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
        if(es.hurtTimer<=0&&!ep.grounded&&Math.abs(ep.x-m2.x)<26&&Math.abs(ep.y-m2.y)<28){
          es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
          SOUND.hurt(); this.cameras.main.shake(250,0.012);
          ep.vx=-es.facing*190; ep.vy=-210;
          if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        }
        continue;
      }
      if(m2.type==='thrower'){
        m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.006)*2;
        m2.shotT=(m2.shotT||0)+delta;
        if(m2.shotT>=m2.shotInterval){
          m2.shotT=0; var sDir=ep.x>m2.x?1:-1; m2.dir=sDir;
          m2.projectiles.push({x:m2.x+sDir*20,y:m2.y-15,vx:sDir*220,life:1.0});
        }
        for(var prj=m2.projectiles.length-1;prj>=0;prj--){
          var proj=m2.projectiles[prj]; proj.x+=proj.vx*dt; proj.life-=0.007*delta;
          if(es.hurtTimer<=0&&Math.abs(proj.x-ep.x)<18&&Math.abs(proj.y-ep.y)<18){
            EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
            SOUND.hurt(); this.cameras.main.shake(200,0.01);
            es.hurtTimer=1200; ep.vx=-proj.vx*0.35; ep.vy=-140;
            m2.projectiles.splice(prj,1);
            if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
            continue;
          }
          if(proj.life<=0||proj.x<0||proj.x>LW) m2.projectiles.splice(prj,1);
        }
        continue;
      }
      m2.x+=m2.dir*m2.spd*dt; m2.bT+=delta; m2.bAmt=Math.sin(m2.bT*0.006)*4;
      if(m2.x<m2.pMin){m2.x=m2.pMin;m2.dir=1;} if(m2.x>m2.pMax){m2.x=m2.pMax;m2.dir=-1;}
      var cRange=m2.type==='tank'?44:32;
      if(es.hurtTimer<=0&&Math.abs(ep.x-m2.x)<cRange&&Math.abs(ep.y-m2.y)<cRange){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(300,0.015);
        var kb=m2.type==='tank'?320:190; ep.vx=-es.facing*kb; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
    }
    for(var ai2=0;ai2<this.pickups.length;ai2++){
      var ap=this.pickups[ai2]; if(ap.collected) continue;
      ap.bobT+=delta;
      if(Math.abs(ep.x-ap.x)+Math.abs(ep.y-ap.y)<(EWR_STATE.shop.aloeMagnet?140:44)){
        ap.collected=true; EWR_STATE.aloe+=ALOE.aloePickup;
        spawnExplosion(ap.x,ap.y,0x00e676,1); SOUND.pickup();
        this._flash('+'+ALOE.aloePickup+' ALOE',1200);
      }
    }
    if(!this.checkpt&&ep.x>cfg.checkptX){this.checkpt=true;this._flash('CHECKPOINT!',1600);EWR_STATE.health[0]=EWR_STATE.maxHealth[0];}
    if(ep.x>cfg.beatX){this._beatLevel();return;}
    es.cigF++; es.smokeT+=delta;
    if(es.smokeT>950){es.smokeT=0;spawnSmoke(ep.x+es.facing*14,ep.y-25);}
    updateSmoke(); updateExplosions(); updateFire();
    // Nuclear clouds
    this._nukeT+=delta;
    if(this._nukeT>=this._nukeInterval){
      this._nukeT=0; this._nukeInterval=30000+Math.random()*20000;
      spawnNuke(); this._flash('NUCLEAR EVENT DETECTED',1400,14,'#ff4444',0,90);
    }
    updateNukes(delta); this.nukeG.clear(); drawNukes(this.nukeG);
    // News ticker
    this._tickX-=1.5*(delta/16);
    this.tickerTxt.setPosition(this._tickX,526);
    if(this._tickX<-this.tickerTxt.width){
      this._tickN=(this._tickN+1)%NEWS_TICKER.length;
      this.tickerTxt.setText('⚡ '+NEWS_TICKER[this._tickN]+'  ◆  ');
      this._tickX=960;
    }
    if(EWR_STATE.combo.streak>=10){spawnFire(ep.x+(Math.random()-0.5)*18,ep.y-16);spawnFire(ep.x+(Math.random()-0.5)*18,ep.y-8);}
    for(var ci3=0;ci3<this.cats.length;ci3++){
      var cat=this.cats[ci3]; cat.tailAng+=0.04; cat.wT+=delta; cat.danceT+=delta;
      if(!cat.following&&!cat.sitting&&cat.wT>2500){cat.wT=0;cat.wDir*=-1;}
    }
    var frame=0;
    if(es.hurtTimer>900) frame=7;
    else if(!ep.grounded) frame=4;
    else if(es.kickTimer>400) frame=6;
    else if(es.punchTimer>200||ep.chargeT>200) frame=5;
    else if(Math.abs(ep.vx)>20) frame=Math.floor(this.levelT/120)%4;
    var camX=Phaser.Math.Clamp(ep.x-480,0,LW-960);
    this.cameras.main.scrollX=camX; this.cameras.main.scrollY=0;
    this.psychG.clear();
    if(EWR_STATE.health[0]<=1&&EWR_STATE.maxHealth[0]>0){
      var pt=this.levelT;
      this.cameras.main.setRotation(Math.sin(pt*0.003)*0.012);
      var tintIdx=Math.floor(pt/500)%6;
      var tintCols=[0xff0044,0x00ffff,0xffff00,0xff00ff,0x00ff88,0xcc44ff];
      this.psychG.fillStyle(tintCols[tintIdx],0.07+Math.sin(pt*0.007)*0.03);
      this.psychG.fillRect(0,0,960,540);
      this.psychG.fillStyle(0xff0000,0.18+Math.sin(pt*0.005)*0.06);
      this.psychG.fillRect(0,0,960,55); this.psychG.fillRect(0,485,960,55);
      this.psychG.fillRect(0,0,55,540); this.psychG.fillRect(905,0,55,540);
    } else { this.cameras.main.setRotation(0); }
    this.catG.clear();
    for(var ci4=0;ci4<this.cats.length;ci4++){
      var c=this.cats[ci4];
      if(Math.abs(c.x-ep.x)<700) DRAW_CAT.draw(this.catG,c.x,c.y,CAT_COLORS[c.ci],c.tailAng,c.following?es.facing:c.wDir,c.sitting,c.dance||c.following,c.smoker,c.danceT);
    }
    this.mochiG.clear();
    for(var mi4=0;mi4<this.mochiList.length;mi4++){var m3=this.mochiList[mi4];if(Math.abs(m3.x-ep.x)<700)this._drawMochi(this.mochiG,m3);}
    this.pickupG.clear();
    for(var ai3=0;ai3<this.pickups.length;ai3++){var ap2=this.pickups[ai3];if(ap2.collected)continue;if(Math.abs(ap2.x-ep.x)<700){var bob=Math.sin(ap2.bobT*0.003)*5;this._drawAloe(this.pickupG,ap2.x,ap2.y+bob);}}
    this.edG.clear();
    DRAW_ED.draw(this.edG,ep.x,ep.y,frame,es.facing<0,es.cigF);
    if(ep.chargeT>0){var cr2=Math.min(ep.chargeT/1200,1.0);this.edG.fillStyle(cr2>=1?0xffffff:0xff6600,0.3+cr2*0.5);this.edG.fillCircle(ep.x+es.facing*28,ep.y-27,5+cr2*14);}
    if(es.punchActive){this.edG.fillStyle(0xffd60a,0.15);this.edG.fillCircle(ep.x+es.facing*56,ep.y-20,28);}
    if(es.kickActive){this.edG.fillStyle(0xff6b35,0.18);this.edG.fillCircle(ep.x+es.facing*ED_MOVE.kickRange,ep.y-10,32);}
    drawExplosions(this.edG); drawFire(this.edG);
    for(var sp=0;sp<SMOKE_POOL.length;sp++){var p2=SMOKE_POOL[sp];this.edG.fillStyle(0xaaaaaa,p2.life*0.3);this.edG.fillCircle(p2.x,p2.y,p2.r);}
    if(EWR_STATE.combo.streak>=3){
      var cStr=EWR_STATE.combo.streak>=10?'ON FIRE '+EWR_STATE.combo.streak+'x':EWR_STATE.combo.streak+'x COMBO';
      var cCol=EWR_STATE.combo.streak>=10?'#ff6b00':EWR_STATE.combo.streak>=6?'#ffd60a':'#ffffff';
      this.comboText.setText(cStr).setPosition(ep.x,ep.y-80).setStyle({color:cCol}).setAlpha(1);
    } else { this.comboText.setAlpha(0); }
    this.hudG.clear();
    DRAW_HUD.draw(this.hudG,this.aloeText);
  };

  LevelScene.prototype._beatLevel=function(){
    if(this._beaten) return; this._beaten=true;
    if(EWR_STATE.levelsBeaten.indexOf(cfg.beatKey)<0){EWR_STATE.levelsBeaten.push(cfg.beatKey);EWR_STATE.aloe+=cfg.aloeReward;}
    EWR_STATE.health[0]=EWR_STATE.maxHealth[0]; SMOKE_POOL.length=0; EX_POOL.length=0; FIRE_POOL.length=0;
    SOUND.victory(); this.cameras.main.shake(250,0.015);
    this._flash('LEVEL CLEAR! +'+cfg.aloeReward+' ALOE',2800);
    var self=this;
    this.time.delayedCall(3000,function(){self.scene.start(cfg.returnScene||'WorldMap',{aloeEarned:cfg.aloeReward});});
  };
  LevelScene.prototype._triggerDeath  = Level11Scene.prototype._triggerDeath;
  LevelScene.prototype._flash         = Level11Scene.prototype._flash;
  LevelScene.prototype._drawLevel     = Level11Scene.prototype._drawLevel;
  LevelScene.prototype._spawnMochiParts=Level11Scene.prototype._spawnMochiParts;
  LevelScene.prototype._drawMochi     = Level11Scene.prototype._drawMochi;
  LevelScene.prototype._drawAloe      = Level11Scene.prototype._drawAloe;
  LevelScene.prototype._emberBlast    = Level11Scene.prototype._emberBlast;
  LevelScene.prototype._die           = Level11Scene.prototype._die;
  return LevelScene;
}

// ── LEVEL 12: BUS STOP BLUES ─────────────────────────────────────
var Level12Scene=createLevelScene({
  key:'Level12', LW:5200, beatX:5185, beatKey:'1-2', checkptX:2600, aloeReward:ALOE.beat12,
  title:'1-2  BUS STOP BLUES', intro:'BUS STOP BLUES',
  plats:[
    [200,420,110],[420,370,90],[640,440,80],[900,390,110],[1080,330,90],[1270,265,110],
    [1460,360,90],[1660,420,110],[1840,300,85],[1990,375,100],[2110,440,75],
    [2240,405,100],[2420,365,85],[2580,430,70],[2720,375,100],[2900,335,80],
    [3060,400,100],[3220,455,80],[3420,415,80],[3550,355,60],[3660,295,60],[3770,240,80],
    [3930,280,60],[4050,350,80],[4160,420,60],[4260,460,100],[4380,425,110],[4530,400,80],[4690,380,110],[4860,405,90]
  ],
  catX:[230,510,770,1120,1380,1720,1920,2320,2640,2940,3200,3570,3960,4420,4680,4870],
  mochis:[
    {x:550,type:'mochi'},{x:900,type:'mochi'},{x:1150,type:'mochi'},{x:1460,type:'mochi'},
    {x:1750,type:'mochi'},{x:2040,type:'mochi'},{x:2330,type:'mochi'},{x:2640,type:'mochi'},
    {x:2930,type:'mochi'},{x:3220,type:'mochi'},{x:3610,type:'mochi'},{x:4010,type:'mochi'},
    {x:4310,type:'mochi'},{x:4520,type:'mochi'},{x:4720,type:'mochi'},{x:4940,type:'mochi'}
  ],
  pickups:[[1320,245],[2760,295],[3820,220],[4560,380]]
});

// ── LEVEL 13: DAIKON DISTRICT ────────────────────────────────────
var Level13Scene=createLevelScene({
  key:'Level13', LW:5600, beatX:5585, beatKey:'1-3', checkptX:2800, aloeReward:ALOE.beat13,
  title:'1-3  DAIKON DISTRICT', intro:'DAIKON DISTRICT',
  plats:[
    [210,415,110],[450,365,90],[670,440,85],[920,385,110],[1100,325,95],[1290,260,115],
    [1490,355,90],[1690,415,110],[1870,295,88],[2000,370,105],[2130,435,78],
    [2270,400,105],[2450,360,88],[2610,425,72],[2760,370,105],[2940,330,82],
    [3100,395,105],[3270,450,82],[3470,410,82],[3600,350,62],[3720,290,62],[3840,235,82],
    [4010,275,62],[4130,345,82],[4250,415,62],[4360,455,105],[4490,420,115],[4640,395,82],[4810,375,115],[4990,400,92]
  ],
  catX:[240,520,790,1150,1400,1750,1950,2360,2680,2990,3260,3620,4030,4460,4720,4910],
  mochis:[
    {x:560,type:'mochi'},{x:780,type:'tank'},{x:1010,type:'mochi'},{x:1200,type:'mochi'},
    {x:1500,type:'tank'},{x:1770,type:'mochi'},{x:2060,type:'mochi'},{x:2290,type:'tank'},
    {x:2560,type:'mochi'},{x:2800,type:'mochi'},{x:3060,type:'tank'},{x:3320,type:'mochi'},
    {x:3640,type:'mochi'},{x:3870,type:'tank'},{x:4090,type:'mochi'},{x:4320,type:'mochi'},
    {x:4550,type:'tank'},{x:4770,type:'mochi'},{x:5040,type:'tank'},{x:5250,type:'mochi'}
  ],
  pickups:[[1350,240],[2810,290],[3890,215],[4700,375]]
});

// ── LEVEL 14: THE SKY IS WRONG ───────────────────────────────────
var Level14Scene=createLevelScene({
  key:'Level14', LW:6200, beatX:6185, beatKey:'1-4', checkptX:3100, aloeReward:ALOE.beat14,
  title:'1-4  THE SKY IS WRONG', intro:'THE SKY IS WRONG',
  plats:[
    [220,410,115],[470,360,95],[700,435,88],[950,380,115],[1130,320,98],[1320,255,118],
    [1530,350,92],[1740,410,115],[1920,290,90],[2060,365,108],[2200,430,80],
    [2340,395,108],[2530,355,92],[2690,420,75],[2850,365,108],[3030,325,85],
    [3200,390,108],[3380,445,85],[3580,405,85],[3720,345,65],[3850,285,65],[3980,230,85],
    [4160,270,65],[4290,340,85],[4420,410,65],[4540,450,108],[4680,415,118],[4840,390,85],[5020,370,118],[5210,395,95],
    [5380,360,75],[5520,300,75],[5700,360,90],[5890,420,85]
  ],
  catX:[250,540,820,1180,1450,1810,2020,2410,2740,3060,3350,3690,4120,4590,4870,5120,5420,5720,5950],
  mochis:[
    {x:580,type:'mochi'},{x:820,type:'tank'},{x:1070,type:'mochi'},
    {x:1250,type:'daikon',baseY:310},{x:1550,type:'mochi'},{x:1800,type:'tank'},
    {x:1950,type:'thrower'},{x:2210,type:'mochi'},{x:2430,type:'daikon',baseY:295},
    {x:2650,type:'mochi'},{x:2880,type:'tank'},{x:3090,type:'mochi'},
    {x:3260,type:'thrower'},{x:3510,type:'daikon',baseY:320},{x:3740,type:'mochi'},
    {x:3980,type:'tank'},{x:4220,type:'mochi'},{x:4440,type:'daikon',baseY:305},
    {x:4660,type:'thrower'},{x:4900,type:'mochi'},{x:5130,type:'tank'},
    {x:5300,type:'daikon',baseY:290},{x:5540,type:'mochi'},{x:5760,type:'thrower'},
    {x:5960,type:'tank'},{x:6100,type:'mochi'}
  ],
  pickups:[[1380,235],[2910,280],[4010,210],[5340,270]]
});

// ════════════════════════════════════════════════════════════════
// CHUNK 5: LEVEL15 (BOSS) + LEVELVOИД (THE VOID)
// ════════════════════════════════════════════════════════════════

// ── LEVEL 15: THE DAIKON LORD ────────────────────────────────────
function Level15Scene(){Phaser.Scene.call(this,{key:'Level15'});}
Level15Scene.prototype=Object.create(Phaser.Scene.prototype);
Level15Scene.prototype.constructor=Level15Scene;
Level15Scene.prototype.create=function(){
  var W=960,H=540;
  EX_POOL.length=0; SMOKE_POOL.length=0; FIRE_POOL.length=0;
  this._dying=false; this._dyingT=0; this._beaten=false;
  var bg=this.add.graphics();
  bg.fillStyle(0x060010,1); bg.fillRect(0,0,W,H);
  bg.fillStyle(0x1e0038,0.55); bg.fillRect(0,300,W,240);
  bg.fillStyle(0x120022,0.7); bg.fillRect(0,430,W,110);
  for(var s=0;s<20;s++){var sx=s*50+5,sh=20+Math.sin(s*2.1)*45+28;bg.fillStyle(0x1a0030,1);bg.fillTriangle(sx,0,sx+14,0,sx+7,sh);}
  bg.fillStyle(0x100020,1); bg.fillRect(0,490,W,50);
  bg.fillStyle(0x7700cc,0.45); bg.fillRect(0,488,W,4);
  var pd=[[150,420,125],[355,360,105],[570,420,115],[760,348,98],[195,293,82],[538,272,73]];
  var platG=this.add.graphics();
  platG.fillStyle(0x2d0050,1); platG.lineStyle(2,0xaa00ee,0.9);
  this.platRects=[{x:0,y:490,w:W,h:50}];
  for(var pi=0;pi<pd.length;pi++){platG.fillRect(pd[pi][0],pd[pi][1],pd[pi][2],18);platG.strokeRect(pd[pi][0],pd[pi][1],pd[pi][2],18);this.platRects.push({x:pd[pi][0],y:pd[pi][1],w:pd[pi][2],h:18});}
  this.boss={x:720,y:464,hp:24,maxHp:24,phase:1,vx:-85,vy:0,grounded:true,shotT:0,shotInterval:2200,projectiles:[],spawnTimer:0,bT:0,hitFlash:0,dieT:-1,minions:[]};
  this.bossG=this.add.graphics().setDepth(4);
  this.ep={x:120,y:440,vx:0,vy:0,grounded:false,coyoteMs:0,jumpBufMs:0,chargeT:0,djUsed:false};
  this.es={facing:1,frame:0,cigF:0,smokeT:0,walkT:0,punchTimer:0,punchActive:false,kickTimer:0,kickActive:false,hurtTimer:0};
  this.edG=this.add.graphics().setDepth(5);
  this.hudG=this.add.graphics().setScrollFactor(0).setDepth(20);
  this.aloeText=this.add.text(40,22,'',{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setScrollFactor(0).setDepth(20);
  this.add.text(480,14,'1-5  THE DAIKON LORD',{fontFamily:'Georgia,serif',fontSize:'18px',color:AT.uiGold,stroke:AT.outline,strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(20);
  this.flashTxt=this.add.text(480,270,'',{fontFamily:'Georgia,serif',fontSize:'42px',color:AT.uiGold,stroke:AT.outline,strokeThickness:5}).setOrigin(0.5).setScrollFactor(0).setDepth(20).setAlpha(0);
  this.comboText=this.add.text(0,0,'',{fontFamily:'Courier New,monospace',fontSize:'20px',color:'#ffd60a',stroke:AT.outline,strokeThickness:3}).setDepth(25).setAlpha(0);
  this.psychG=this.add.graphics().setScrollFactor(0).setDepth(50);
  this.dyingG=this.add.graphics().setScrollFactor(0).setDepth(90);
  this.dyingTxt=this.add.text(480,230,'',{fontFamily:'Georgia,serif',fontSize:'46px',color:'#ffffff',stroke:'#000000',strokeThickness:6}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.dyingTxt2=this.add.text(480,295,'',{fontFamily:'Courier New,monospace',fontSize:'24px',color:'#aaaaaa'}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.crtG=this.add.graphics().setScrollFactor(0).setDepth(99);
  if(EWR_STATE.shop.crtFilter){this.crtG.fillStyle(0x000000,0.14);for(var cr=0;cr<540;cr+=4)this.crtG.fillRect(0,cr,960,1);}
  this.keys={
    left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
    right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
    up:   this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
    down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
    punch:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),
    kick: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),
    altL: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
    altR: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
    altU: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
    altD: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S)
  };
  this.levelT=0;
  _initVPad(this);
  this._flash('FACE THE DAIKON LORD!',2400);
};
Level15Scene.prototype._triggerDeath=Level11Scene.prototype._triggerDeath;
Level15Scene.prototype._flash=Level11Scene.prototype._flash;
Level15Scene.prototype._spawnMochiParts=Level11Scene.prototype._spawnMochiParts;
Level15Scene.prototype._drawMochi=Level11Scene.prototype._drawMochi;
Level15Scene.prototype._drawAloe=Level11Scene.prototype._drawAloe;
Level15Scene.prototype._die=Level11Scene.prototype._die;
Level15Scene.prototype._bossDie=function(){
  var self=this;
  SOUND.victory(); this.cameras.main.shake(700,0.03);
  for(var i=0;i<10;i++){
    var bx=this.boss.x+(Math.random()-0.5)*100, by=this.boss.y-40+(Math.random()-0.5)*80;
    spawnExplosion(bx,by,0xff6b35,3); spawnExplosion(bx,by,0xffcc00,2.5);
  }
  this._flash('DAIKON LORD DEFEATED!',3200);
  this.time.delayedCall(3500,function(){self._beatLevel();});
};
Level15Scene.prototype._beatLevel=function(){
  if(this._beaten) return; this._beaten=true;
  if(EWR_STATE.levelsBeaten.indexOf('1-5')<0){EWR_STATE.levelsBeaten.push('1-5');EWR_STATE.aloe+=ALOE.beat15;}
  EWR_STATE.health[0]=EWR_STATE.maxHealth[0]; SMOKE_POOL.length=0; EX_POOL.length=0; FIRE_POOL.length=0;
  var self=this;
  this.time.delayedCall(400,function(){self.scene.start('WorldMap',{aloeEarned:ALOE.beat15});});
};
Level15Scene.prototype._drawBoss=function(g,boss){
  if(boss.dieT>=0) return;
  var x=boss.x, y=boss.y;
  var sc=boss.phase>=3?1.85:1.55;
  var flashOn=boss.hitFlash>0&&Math.floor(boss.hitFlash/80)%2===0;
  var bodyCol=boss.phase>=3?(flashOn?0xffffff:0xff2222):(flashOn?0xffffff:0xf0f0ff);
  // Body (daikon shape)
  g.fillStyle(bodyCol,1);
  g.fillEllipse(x,y-sc*32,sc*52,sc*84);
  g.fillStyle(bodyCol,0.85); g.fillTriangle(x-sc*9,y-sc*6,x+sc*9,y-sc*6,x,y+sc*22);
  // Leaf crown
  var lc=boss.phase>=3?0x00ee44:0x44bb44;
  g.fillStyle(lc,1);
  g.fillTriangle(x,y-sc*72,x-sc*18,y-sc*58,x-sc*8,y-sc*50);
  g.fillTriangle(x,y-sc*72,x+sc*18,y-sc*58,x+sc*8,y-sc*50);
  g.fillTriangle(x-sc*10,y-sc*76,x-sc*26,y-sc*60,x-sc*16,y-sc*54);
  g.fillTriangle(x+sc*10,y-sc*76,x+sc*26,y-sc*60,x+sc*16,y-sc*54);
  // Mohawk spikes
  g.fillStyle(0x00ff55,1);
  for(var i=-2;i<=2;i++){var mx=x+i*sc*9;g.fillTriangle(mx,y-sc*70,mx-sc*5,y-sc*56,mx+sc*5,y-sc*56);}
  // Face - sunglasses
  var gy2=y-sc*38;
  g.fillStyle(0x080010,0.95); g.fillEllipse(x-sc*14,gy2,sc*20,sc*11); g.fillEllipse(x+sc*14,gy2,sc*20,sc*11);
  g.lineStyle(2,0xbbbbbb,1); g.lineBetween(x-sc*4,gy2,x+sc*4,gy2);
  g.lineStyle(1.5,0x888888,0.8); g.lineBetween(x-sc*24,gy2,x-sc*27,gy2); g.lineBetween(x+sc*24,gy2,x+sc*27,gy2);
  if(boss.phase>=3){g.lineStyle(3,0xff1111,1);g.lineBetween(x-sc*22,gy2-sc*9,x-sc*6,gy2-sc*6);g.lineBetween(x+sc*6,gy2-sc*6,x+sc*22,gy2-sc*9);}
  // HP bar
  var barW=160,barH=14,bx2=boss.x-barW/2,by2=boss.y-sc*102-8;
  g.fillStyle(0x000000,0.75); g.fillRect(bx2-3,by2-3,barW+6,barH+6);
  var barCol=boss.phase>=3?0xff2200:boss.phase>=2?0xffaa00:0x44cc44;
  g.fillStyle(barCol,1); g.fillRect(bx2,by2,Math.max(0,barW*(boss.hp/boss.maxHp)),barH);
  g.lineStyle(1.5,0xffffff,0.55); g.strokeRect(bx2,by2,barW,barH);
  // Phase labels
  g.fillStyle(boss.phase>=2?barCol:0x224422,1); g.fillRect(bx2+barW+6,by2,18,14);
  g.fillStyle(boss.phase>=3?barCol:0x224422,1); g.fillRect(bx2+barW+28,by2,18,14);
  // Projectiles
  for(var prj=0;prj<boss.projectiles.length;prj++){
    var pj=boss.projectiles[prj];
    g.fillStyle(boss.phase>=3?0xff2200:0xcc33ff,pj.life);
    g.fillCircle(pj.x,pj.y,8+boss.phase*2);
    g.fillStyle(0xffffff,pj.life*0.45); g.fillCircle(pj.x,pj.y,3);
  }
};
Level15Scene.prototype._emberBlast=function(){
  var ep=this.ep,es=this.es,boss=this.boss;
  var bx=ep.x+es.facing*80,by=ep.y-20;
  spawnExplosion(bx,by,0xff6b35,3.5); spawnExplosion(bx,by,0xffcc00,2);
  this.cameras.main.shake(150,0.012); SOUND.blast();
  this._flash('EMBER BLAST!',1000);
  try{var fl=this.add.graphics().setScrollFactor(0).setDepth(80);fl.fillStyle(0xffffff,0.55);fl.fillRect(0,0,960,540);this.time.delayedCall(70,function(){fl.destroy();});}catch(e){}
  var dist=Math.sqrt(Math.pow(bx-boss.x,2)+Math.pow(by-(boss.y-40),2));
  if(dist<110&&boss.dieT<0){
    boss.hp-=3; boss.hitFlash=500; SOUND.bossHit();
    _addCombo(this,boss.x,boss.y-50);
    this.cameras.main.shake(200,0.015);
    EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*3*EWR_STATE.combo.mult);
    if(boss.hp<=0){boss.dieT=0;this._bossDie();}
  }
  ep.chargeT=0;
};
Level15Scene.prototype.update=function(time,delta){
  if(this._dying){
    this._dyingT+=delta;
    var fa=Math.min(this._dyingT/700,0.92);
    this.dyingG.clear(); this.dyingG.fillStyle(0x000000,fa); this.dyingG.fillRect(0,0,960,540);
    if(this._dyingT>800&&this.dyingTxt.alpha<1){this.dyingTxt.setText('ED NEEDS A MINUTE').setAlpha(1);this.dyingTxt2.setText('...').setAlpha(1);}
    if(this._dyingT>2600){EWR_STATE.health[0]=EWR_STATE.maxHealth[0];EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;this.scene.restart();}
    return;
  }
  this.levelT+=delta;
  var dt=delta/1000,ep=this.ep,es=this.es,boss=this.boss;
  var pad=this.input.gamepad&&this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;
  var gpL=false,gpR=false,gpJ=false,gpKick=false,gpPunchHeld=false;
  if(pad){var axV=pad.axes.length>0?pad.axes[0].getValue():0;gpL=(pad.left)||(axV<-0.3);gpR=(pad.right)||(axV>0.3);gpJ=(pad.up)||(pad.A&&pad.A.pressed);gpPunchHeld=!!(pad.X&&pad.X.pressed);var kNow=pad.B&&pad.B.pressed;gpKick=kNow&&!this._prevKickGP;this._prevKickGP=kNow;}
  var goL=this.keys.left.isDown||this.keys.altL.isDown||gpL;
  var goR=this.keys.right.isDown||this.keys.altR.isDown||gpR;
  var goJ=this.keys.up.isDown||this.keys.altU.isDown||gpJ;
  var goD=this.keys.down.isDown||this.keys.altD.isDown;
  var doKick=Phaser.Input.Keyboard.JustDown(this.keys.kick)||gpKick;
  var zHeld=this.keys.punch.isDown||gpPunchHeld;
  var zWasHeld=this._prevZHeld||false;
  var zJustReleased=(!zHeld)&&zWasHeld;
  if(zHeld&&es.punchTimer<=0&&es.kickTimer<=0){var _pct=ep.chargeT;ep.chargeT+=delta;if(ep.chargeT>200&&Math.floor(ep.chargeT/300)>Math.floor(_pct/300))SOUND.charge();}
  if(zJustReleased&&es.punchTimer<=0&&es.kickTimer<=0){
    if(ep.chargeT>=1200){this._emberBlast();}
    else if(ep.chargeT>=60){es.punchTimer=340;es.punchActive=true;SOUND.punch();}
    ep.chargeT=0;
  }
  if(!zHeld) ep.chargeT=Math.max(0,ep.chargeT-delta*3);
  this._prevZHeld=zHeld;
  var tVx=0;
  if(goL){tVx=-ED_MOVE.walkSpeed;es.facing=-1;} if(goR){tVx=ED_MOVE.walkSpeed;es.facing=1;}
  if(goD&&ep.grounded) tVx*=0.35;
  var airM=ep.grounded?1:ED_MOVE.airControl;
  ep.vx+=(tVx-ep.vx)*Math.min(1,12*dt*airM);
  var wasGrounded=ep.grounded;
  if(goJ) ep.jumpBufMs=ED_MOVE.jumpBufMs; else ep.jumpBufMs=Math.max(0,ep.jumpBufMs-delta);
  if(ep.grounded) ep.coyoteMs=ED_MOVE.coyoteMs; else ep.coyoteMs=Math.max(0,ep.coyoteMs-delta);
  if(ep.jumpBufMs>0&&ep.coyoteMs>0&&ep.vy>=-10){ep.vy=ED_MOVE.jumpVel;ep.jumpBufMs=0;ep.coyoteMs=0;ep.grounded=false;SOUND.jump();}
  if(!goJ&&ep.vy<0) ep.vy*=ED_MOVE.jumpCut;
  if(EWR_STATE.shop.doubleJump&&!ep.grounded&&wasGrounded===false&&ep.coyoteMs<=0&&ep.jumpBufMs>0&&ep.vy>0&&!ep.djUsed){ep.vy=ED_MOVE.jumpVel*0.82;ep.djUsed=true;ep.jumpBufMs=0;SOUND.jump();spawnExplosion(ep.x,ep.y,0x00ffff,0.8);}
  if(ep.grounded) ep.djUsed=false;
  ep.vy=Math.min(ep.vy+800*dt,ED_MOVE.maxFall);
  ep.x+=ep.vx*dt; ep.y+=ep.vy*dt; ep.grounded=false;
  var edL=ep.x-14,edR=ep.x+14,edBot=ep.y;
  if(edBot>=490&&ep.vy>=0){ep.y=490;ep.vy=0;ep.grounded=true;}
  for(var pi=1;pi<this.platRects.length;pi++){var pl=this.platRects[pi];if(ep.vy>=0&&edBot>=pl.y&&edBot<=pl.y+pl.h+6&&edL<pl.x+pl.w&&edR>pl.x){if(edBot-ep.vy*dt<pl.y+3){ep.y=pl.y;ep.vy=0;ep.grounded=true;}}}
  if(ep.x<14){ep.x=14;ep.vx=0;} if(ep.x>946){ep.x=946;ep.vx=0;}
  if(ep.y>620){this._triggerDeath();return;}
  if(es.hurtTimer>0) es.hurtTimer-=delta;
  if(es.punchTimer>0){es.punchTimer-=delta;es.punchActive=es.punchTimer>90;}
  if(doKick&&es.kickTimer<=0&&es.punchTimer<=0){es.kickTimer=600;es.kickActive=true;}
  if(es.kickTimer>0){es.kickTimer-=delta;es.kickActive=es.kickTimer>200;}
  if(EWR_STATE.combo.streak>0){EWR_STATE.combo.timer-=delta;if(EWR_STATE.combo.timer<=0){EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;}}
  // Boss active
  if(boss.dieT>=0){
    boss.dieT+=delta;
    if(boss.dieT>300){spawnExplosion(boss.x+(Math.random()-0.5)*120,boss.y-40+(Math.random()-0.5)*80,0xff6b35,2.5);}
    if(boss.dieT>4200&&!this._beaten){this._beatLevel();}
  } else {
    // Phase progression
    var newPhase=boss.hp>16?1:boss.hp>8?2:3;
    if(newPhase>boss.phase){
      boss.phase=newPhase; SOUND.bossHit();
      this.cameras.main.shake(500,0.025);
      boss.shotInterval=newPhase>=3?1400:1750;
      this._flash(newPhase>=3?'ENRAGE!!!':'PHASE '+newPhase+'!',1400);
    }
    boss.bT+=delta;
    var bSpd=boss.phase>=3?175:boss.phase>=2?125:85;
    boss.x+=boss.vx*dt;
    if(boss.x<110){boss.x=110;boss.vx=bSpd;}
    if(boss.x>850){boss.x=850;boss.vx=-bSpd;}
    boss.vy=Math.min(boss.vy+600*dt,600); boss.y+=boss.vy*dt; boss.grounded=false;
    if(boss.y>=464){boss.y=464;boss.vy=0;boss.grounded=true;}
    if(boss.phase>=3&&boss.grounded&&Math.random()<0.01){boss.vy=-460;}
    // Shooting
    boss.shotT+=delta;
    if(boss.shotT>=boss.shotInterval){
      boss.shotT=0;
      var nShots=boss.phase>=3?4:boss.phase>=2?3:2;
      var dx=ep.x-boss.x,dy=(ep.y-20)-(boss.y-40);
      var dist2=Math.sqrt(dx*dx+dy*dy)||1;
      var spd=boss.phase>=3?300:220;
      for(var sh=0;sh<nShots;sh++){
        var ang=(sh-(nShots-1)/2)*0.38;
        boss.projectiles.push({x:boss.x,y:boss.y-45,vx:(dx/dist2*Math.cos(ang)-dy/dist2*Math.sin(ang))*spd,vy:(dy/dist2*Math.cos(ang)+dx/dist2*Math.sin(ang))*spd*0.7,life:1.0});
      }
      SOUND.kick();
    }
    // Phase 2+: spawn minions
    if(boss.phase>=2){
      boss.spawnTimer+=delta;
      if(boss.spawnTimer>=9000){
        boss.spawnTimer=0;
        boss.minions.push({x:boss.x-130,y:464,hp:2,spd:58,dir:-1,bT:0,bAmt:0,dieT:-1,squishT:0,parts:[],pMin:60,pMax:900,type:'mochi',projectiles:[]});
        boss.minions.push({x:boss.x+130,y:464,hp:2,spd:58,dir:1,bT:0,bAmt:0,dieT:-1,squishT:0,parts:[],pMin:60,pMax:900,type:'mochi',projectiles:[]});
        spawnExplosion(boss.x,boss.y-50,0xff00ff,2.5);
      }
    }
    // Minion update
    for(var mn=0;mn<boss.minions.length;mn++){
      var mm=boss.minions[mn]; if(mm.dieT>=0){mm.dieT+=delta;mm.squishT+=delta;for(var pp=0;pp<mm.parts.length;pp++){var pt=mm.parts[pp];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.3;pt.life-=0.025;}continue;}
      mm.x+=mm.dir*mm.spd*dt; mm.bT+=delta; mm.bAmt=Math.sin(mm.bT*0.006)*4;
      if(mm.x<mm.pMin){mm.x=mm.pMin;mm.dir=1;} if(mm.x>mm.pMax){mm.x=mm.pMax;mm.dir=-1;}
      if(es.hurtTimer<=0&&Math.abs(ep.x-mm.x)<32&&Math.abs(ep.y-mm.y)<32){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(300,0.015); ep.vx=-es.facing*200; ep.vy=-220;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
    }
    // Projectile update
    for(var prj=boss.projectiles.length-1;prj>=0;prj--){
      var pj=boss.projectiles[prj]; pj.x+=pj.vx*dt; pj.y+=pj.vy*dt; pj.life-=0.006*delta;
      if(es.hurtTimer<=0&&Math.abs(pj.x-ep.x)<22&&Math.abs(pj.y-ep.y)<22){
        EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012); es.hurtTimer=1200; ep.vx=-ep.vx*0.25; ep.vy=-170;
        boss.projectiles.splice(prj,1);
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        continue;
      }
      if(pj.life<=0||pj.x<-50||pj.x>1010||pj.y>570) boss.projectiles.splice(prj,1);
    }
    // Boss-Ed contact
    if(es.hurtTimer<=0&&Math.abs(ep.x-boss.x)<50&&Math.abs(ep.y-boss.y)<75){
      es.hurtTimer=1500; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
      SOUND.hurt(); this.cameras.main.shake(350,0.02);
      ep.vx=-es.facing*(boss.phase>=3?420:290); ep.vy=-240;
      if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
    }
    if(boss.hitFlash>0) boss.hitFlash-=delta;
    // Ed punch → boss/minion
    if(es.punchActive){
      var hx=ep.x+es.facing*56; var consumed=false;
      for(var mi=0;mi<boss.minions.length;mi++){
        var mm2=boss.minions[mi]; if(mm2.dieT>=0) continue;
        if(Math.abs(hx-mm2.x)<52&&Math.abs(ep.y-mm2.y)<36){
          mm2.hp--; spawnExplosion(mm2.x,mm2.y-13,0xffd60a,1); SOUND.punch();
          _addCombo(this,mm2.x,mm2.y);
          if(mm2.hp<=0){mm2.dieT=0;mm2.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath*2;spawnExplosion(mm2.x,mm2.y-13,0xff4444,2);this._spawnMochiParts(mm2);}
          es.punchActive=false; consumed=true; break;
        }
      }
      if(!consumed&&Math.abs(hx-boss.x)<65&&Math.abs(ep.y-boss.y)<85){
        boss.hp--; boss.hitFlash=420; SOUND.bossHit();
        _addCombo(this,boss.x,boss.y-55); this.cameras.main.shake(100,0.008);
        spawnExplosion(boss.x,boss.y-55,0xffd60a,1.8);
        EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*EWR_STATE.combo.mult);
        if(boss.hp<=0){boss.dieT=0;this._bossDie();}
        es.punchActive=false;
      }
    }
    // Ed kick → boss/minion
    if(es.kickActive){
      var kx=ep.x+es.facing*ED_MOVE.kickRange;
      var kConsumed=false;
      for(var ki=0;ki<boss.minions.length;ki++){
        var km=boss.minions[ki]; if(km.dieT>=0) continue;
        if(Math.abs(kx-km.x)<65&&Math.abs(ep.y-km.y)<42){
          km.hp-=2; spawnExplosion(km.x,km.y-13,0xff6b35,1.5); SOUND.kick();
          _addCombo(this,km.x,km.y);
          if(km.hp<=0){km.dieT=0;km.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath*2;spawnExplosion(km.x,km.y-13,0xff4444,2.5);this._spawnMochiParts(km);}
          es.kickActive=false; kConsumed=true; break;
        }
      }
      if(!kConsumed&&Math.abs(kx-boss.x)<80&&Math.abs(ep.y-boss.y)<90){
        boss.hp-=2; boss.hitFlash=480; SOUND.bossHit();
        _addCombo(this,boss.x,boss.y-55); this.cameras.main.shake(160,0.014);
        spawnExplosion(boss.x,boss.y-55,0xff6b35,2.2);
        EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*2*EWR_STATE.combo.mult);
        if(boss.hp<=0){boss.dieT=0;this._bossDie();}
        es.kickActive=false;
      }
    }
  }
  es.cigF++; es.smokeT+=delta;
  if(es.smokeT>950){es.smokeT=0;spawnSmoke(ep.x+es.facing*14,ep.y-25);}
  updateSmoke(); updateExplosions(); updateFire();
  if(boss.phase>=3){spawnFire(boss.x+(Math.random()-0.5)*50,boss.y-40);}
  this.psychG.clear();
  if(EWR_STATE.health[0]<=1){
    var pt=this.levelT;
    this.cameras.main.setRotation(Math.sin(pt*0.003)*0.012);
    this.psychG.fillStyle(0xff0044,0.1); this.psychG.fillRect(0,0,960,540);
  } else {this.cameras.main.setRotation(0);}
  var frame=0;
  if(es.hurtTimer>900)frame=7;
  else if(!ep.grounded)frame=4;
  else if(es.kickTimer>400)frame=6;
  else if(es.punchTimer>200||ep.chargeT>200)frame=5;
  else if(Math.abs(ep.vx)>20)frame=Math.floor(this.levelT/120)%4;
  this.bossG.clear();
  this._drawBoss(this.bossG,boss);
  // Draw minions
  for(var mn2=0;mn2<boss.minions.length;mn2++){if(boss.minions[mn2].dieT<0||boss.minions[mn2].dieT<400)this._drawMochi(this.bossG,boss.minions[mn2]);}
  this.edG.clear();
  DRAW_ED.draw(this.edG,ep.x,ep.y,frame,es.facing<0,es.cigF);
  if(ep.chargeT>0){var cr=Math.min(ep.chargeT/1200,1.0);this.edG.fillStyle(cr>=1?0xffffff:0xff6600,0.3+cr*0.5);this.edG.fillCircle(ep.x+es.facing*28,ep.y-27,5+cr*14);}
  if(es.punchActive){this.edG.fillStyle(0xffd60a,0.15);this.edG.fillCircle(ep.x+es.facing*56,ep.y-20,28);}
  if(es.kickActive){this.edG.fillStyle(0xff6b35,0.18);this.edG.fillCircle(ep.x+es.facing*ED_MOVE.kickRange,ep.y-10,32);}
  drawExplosions(this.edG); drawFire(this.edG);
  for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];this.edG.fillStyle(0xaaaaaa,p.life*0.3);this.edG.fillCircle(p.x,p.y,p.r);}
  if(EWR_STATE.combo.streak>=3){
    var cStr=EWR_STATE.combo.streak>=10?'ON FIRE '+EWR_STATE.combo.streak+'x':EWR_STATE.combo.streak+'x COMBO';
    var cCol=EWR_STATE.combo.streak>=10?'#ff6b00':EWR_STATE.combo.streak>=6?'#ffd60a':'#ffffff';
    this.comboText.setText(cStr).setPosition(ep.x,ep.y-80).setStyle({color:cCol}).setAlpha(1);
  } else {this.comboText.setAlpha(0);}
  this.hudG.clear(); DRAW_HUD.draw(this.hudG,this.aloeText);
};

// ── THE VOID (1-V) ───────────────────────────────────────────────
function LevelVoidScene(){Phaser.Scene.call(this,{key:'LevelVoid'});}
LevelVoidScene.prototype=Object.create(Phaser.Scene.prototype);
LevelVoidScene.prototype.constructor=LevelVoidScene;
LevelVoidScene.prototype.create=function(){
  var W=960,H=540;
  EX_POOL.length=0; SMOKE_POOL.length=0; FIRE_POOL.length=0;
  this._dying=false; this._dyingT=0; this._beaten=false;
  this._koanT=0; this._koanIdx=0;
  // Black void
  var bg=this.add.graphics();
  bg.fillStyle(0x000000,1); bg.fillRect(0,0,W,H);
  // Star field
  for(var st=0;st<200;st++){var sx=Math.random()*W,sy=Math.random()*H;bg.fillStyle(0xffffff,0.2+Math.random()*0.6);bg.fillCircle(sx,sy,Math.random()<0.1?2:0.8);}
  // Wireframe platforms
  var vPD=[[60,430,180],[290,350,140],[490,420,150],[690,330,120],[820,430,100],[100,270,110],[450,200,90],[720,250,85]];
  this.platRects=[{x:0,y:490,w:W,h:50}];
  var platG=this.add.graphics();
  platG.fillStyle(0x000000,1);
  platG.lineStyle(1.5,0x6600ff,0.85);
  var gridSz=18;
  for(var pv=0;pv<vPD.length;pv++){
    var p=vPD[pv];
    platG.strokeRect(p[0],p[1],p[2],gridSz);
    for(var gx=p[0];gx<p[0]+p[2];gx+=gridSz){platG.lineBetween(gx,p[1],gx,p[1]+gridSz);}
    this.platRects.push({x:p[0],y:p[1],w:p[2],h:gridSz});
  }
  // Floor (wireframe)
  platG.strokeRect(0,490,W,50);
  for(var fx=0;fx<W;fx+=gridSz){platG.lineBetween(fx,490,fx,540);}
  // Void Boss: The Mochi God
  this.god={x:480,y:180,hp:30,maxHp:30,phase:1,vx:0,vy:0,grounded:false,shotT:0,shotInterval:2800,projectiles:[],bT:0,hitFlash:0,dieT:-1,teleT:0,clones:[]};
  this.godG=this.add.graphics().setDepth(4);
  this.ep={x:110,y:440,vx:0,vy:0,grounded:false,coyoteMs:0,jumpBufMs:0,chargeT:0,djUsed:false};
  this.es={facing:1,frame:0,cigF:0,smokeT:0,walkT:0,punchTimer:0,punchActive:false,kickTimer:0,kickActive:false,hurtTimer:0};
  this.edG=this.add.graphics().setDepth(5);
  this.hudG=this.add.graphics().setScrollFactor(0).setDepth(20);
  this.aloeText=this.add.text(40,22,'',{fontFamily:'Courier New,monospace',fontSize:'22px',color:AT.aloe,stroke:AT.outline,strokeThickness:3}).setScrollFactor(0).setDepth(20);
  this.add.text(480,14,'1-V  THE VOID',{fontFamily:'Georgia,serif',fontSize:'18px',color:'#cc44ff',stroke:'#000000',strokeThickness:3}).setOrigin(0.5).setScrollFactor(0).setDepth(20);
  this.flashTxt=this.add.text(480,270,'',{fontFamily:'Georgia,serif',fontSize:'42px',color:'#cc44ff',stroke:'#000000',strokeThickness:5}).setOrigin(0.5).setScrollFactor(0).setDepth(20).setAlpha(0);
  this.koanTxt=this.add.text(480,140,'',{fontFamily:'Courier New,monospace',fontSize:'16px',color:'#8844ff',stroke:'#000000',strokeThickness:3,align:'center'}).setOrigin(0.5).setScrollFactor(0).setDepth(22).setAlpha(0);
  this.comboText=this.add.text(0,0,'',{fontFamily:'Courier New,monospace',fontSize:'20px',color:'#ffd60a',stroke:AT.outline,strokeThickness:3}).setDepth(25).setAlpha(0);
  this.psychG=this.add.graphics().setScrollFactor(0).setDepth(50);
  this.dyingG=this.add.graphics().setScrollFactor(0).setDepth(90);
  this.dyingTxt=this.add.text(480,230,'',{fontFamily:'Georgia,serif',fontSize:'46px',color:'#ffffff',stroke:'#000000',strokeThickness:6}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.dyingTxt2=this.add.text(480,295,'',{fontFamily:'Courier New,monospace',fontSize:'24px',color:'#aaaaaa'}).setOrigin(0.5).setScrollFactor(0).setDepth(91).setAlpha(0);
  this.crtG=this.add.graphics().setScrollFactor(0).setDepth(99);
  if(EWR_STATE.shop.crtFilter){this.crtG.fillStyle(0x000000,0.14);for(var cr=0;cr<540;cr+=4)this.crtG.fillRect(0,cr,960,1);}
  this.keys={
    left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
    right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
    up:   this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
    down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
    punch:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),
    kick: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),
    altL: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
    altR: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
    altU: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
    altD: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S)
  };
  this.levelT=0;
  _initVPad(this);
  this._flash('THE VOID AWAITS',2400);
};
LevelVoidScene.prototype._triggerDeath=Level11Scene.prototype._triggerDeath;
LevelVoidScene.prototype._flash=Level11Scene.prototype._flash;
LevelVoidScene.prototype._spawnMochiParts=Level11Scene.prototype._spawnMochiParts;
LevelVoidScene.prototype._drawMochi=Level11Scene.prototype._drawMochi;
LevelVoidScene.prototype._drawAloe=Level11Scene.prototype._drawAloe;
LevelVoidScene.prototype._die=Level11Scene.prototype._die;
LevelVoidScene.prototype._godDie=function(){
  var self=this;
  SOUND.victory(); this.cameras.main.shake(800,0.035);
  for(var i=0;i<14;i++){
    spawnExplosion(this.god.x+(Math.random()-0.5)*150,this.god.y+(Math.random()-0.5)*100,0xcc44ff,3.5);
    spawnExplosion(this.god.x+(Math.random()-0.5)*150,this.god.y+(Math.random()-0.5)*100,0x00ffff,3);
  }
  this._flash('THE MOCHI GOD FALLS.\nall is aloe.',3500);
  this.time.delayedCall(4200,function(){self._beatVoid();});
};
LevelVoidScene.prototype._beatVoid=function(){
  if(this._beaten) return; this._beaten=true;
  EWR_STATE.secretBeaten=EWR_STATE.secretBeaten||{};
  EWR_STATE.secretBeaten['1-V']=true;
  EWR_STATE.aloe+=ALOE.voidBeat;
  EWR_STATE.health[0]=EWR_STATE.maxHealth[0]; SMOKE_POOL.length=0; EX_POOL.length=0; FIRE_POOL.length=0;
  var self=this;
  this.time.delayedCall(600,function(){self.scene.start('WorldMap',{aloeEarned:ALOE.voidBeat});});
};
LevelVoidScene.prototype._drawGod=function(g,god){
  if(god.dieT>=0) return;
  var x=god.x,y=god.y;
  var sc=god.phase>=3?1.9:god.phase>=2?1.6:1.35;
  var flashOn=god.hitFlash>0&&Math.floor(god.hitFlash/80)%2===0;
  var t=this.levelT;
  // Cosmic glow rings
  var ringCols=[0xcc00ff,0x0088ff,0xff00aa];
  for(var ri=0;ri<3;ri++){
    var rp=god.phase>=3?ri*0.9:ri*1.2;
    g.lineStyle(1.5,ringCols[ri],0.25+Math.sin(t*0.002+rp)*0.18);
    g.strokeCircle(x,y,sc*40+ri*sc*18+Math.sin(t*0.003+ri)*8);
  }
  // Body: giant mochi with cosmic energy
  var bodyC=flashOn?0xffffff:god.phase>=3?0xff44ff:0xf4a8c7;
  g.fillStyle(bodyC,1); g.fillEllipse(x,y,sc*70,sc*60);
  g.fillStyle(flashOn?0xffffff:0xcc5599,0.9); g.strokeEllipse&&g.fillEllipse(x,y,sc*72,sc*62);
  g.lineStyle(2.5,god.phase>=3?0xff00ff:0xcc5599,0.85); g.strokeEllipse(x,y,sc*72,sc*62);
  // Eyes (HUGE and cosmic)
  var eyeC=god.phase>=3?0xff0000:0x2200aa;
  g.fillStyle(0x000000,1); g.fillEllipse(x-sc*16,y-sc*6,sc*18,sc*16); g.fillEllipse(x+sc*16,y-sc*6,sc*18,sc*16);
  g.fillStyle(eyeC,1); g.fillEllipse(x-sc*16,y-sc*6,sc*12,sc*10); g.fillEllipse(x+sc*16,y-sc*6,sc*12,sc*10);
  g.fillStyle(0xffffff,1); g.fillCircle(x-sc*14,y-sc*8,sc*3); g.fillCircle(x+sc*18,y-sc*8,sc*3);
  // Crown of thorns / cosmic crown
  g.fillStyle(god.phase>=3?0xff0000:0xffdd00,0.85);
  for(var ci=0;ci<8;ci++){var ca=ci/8*Math.PI*2;g.fillTriangle(x+Math.cos(ca)*sc*38,y-sc*30+Math.sin(ca)*sc*10,x+Math.cos(ca+0.12)*sc*32,y-sc*30+Math.sin(ca+0.12)*sc*10,x+Math.cos(ca+0.06)*sc*46,y-sc*38+Math.sin(ca+0.06)*sc*8);}
  // HP bar
  var barW=180,barH=14,bx=god.x-barW/2,by2=god.y-sc*52-12;
  g.fillStyle(0x000000,0.8); g.fillRect(bx-3,by2-3,barW+6,barH+6);
  var bc=god.phase>=3?0xff00ff:god.phase>=2?0xaa00ff:0x6600ff;
  g.fillStyle(bc,1); g.fillRect(bx,by2,Math.max(0,barW*(god.hp/god.maxHp)),barH);
  g.lineStyle(1.5,0xffffff,0.5); g.strokeRect(bx,by2,barW,barH);
  // Projectiles
  for(var prj=0;prj<god.projectiles.length;prj++){
    var pj=god.projectiles[prj];
    g.fillStyle(0xcc00ff,pj.life*0.9); g.fillCircle(pj.x,pj.y,9+god.phase*2);
    g.fillStyle(0x8800ff,pj.life*0.5); g.fillCircle(pj.x,pj.y,5);
  }
  // Clones (phase 2+)
  for(var cl=0;cl<god.clones.length;cl++){
    var clone=god.clones[cl]; if(clone.dieT>=0) continue;
    g.fillStyle(0xaa66cc,0.6); g.fillEllipse(clone.x,clone.y,45,38);
    g.lineStyle(1,0xcc44ff,0.5); g.strokeEllipse(clone.x,clone.y,47,40);
  }
};
LevelVoidScene.prototype._emberBlast=function(){
  var ep=this.ep,es=this.es,god=this.god;
  var bx=ep.x+es.facing*80,by=ep.y-20;
  spawnExplosion(bx,by,0xcc44ff,3.5); spawnExplosion(bx,by,0x00ffff,2);
  this.cameras.main.shake(150,0.012); SOUND.blast();
  this._flash('EMBER BLAST!',1000);
  try{var fl=this.add.graphics().setScrollFactor(0).setDepth(80);fl.fillStyle(0xffffff,0.5);fl.fillRect(0,0,960,540);this.time.delayedCall(70,function(){fl.destroy();});}catch(e){}
  var dist=Math.sqrt(Math.pow(bx-god.x,2)+Math.pow(by-god.y,2));
  if(dist<120&&god.dieT<0){
    god.hp-=3; god.hitFlash=500; SOUND.bossHit();
    _addCombo(this,god.x,god.y-55); this.cameras.main.shake(200,0.015);
    EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*3*EWR_STATE.combo.mult);
    if(god.hp<=0){god.dieT=0;this._godDie();}
  }
  ep.chargeT=0;
};
LevelVoidScene.prototype.update=function(time,delta){
  if(this._dying){
    this._dyingT+=delta;
    var fa=Math.min(this._dyingT/700,0.92);
    this.dyingG.clear(); this.dyingG.fillStyle(0x000000,fa); this.dyingG.fillRect(0,0,960,540);
    if(this._dyingT>800&&this.dyingTxt.alpha<1){this.dyingTxt.setText('ED NEEDS A MINUTE').setAlpha(1);this.dyingTxt2.setText('even in the void').setAlpha(1);}
    if(this._dyingT>2600){EWR_STATE.health[0]=EWR_STATE.maxHealth[0];EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;this.scene.restart();}
    return;
  }
  this.levelT+=delta;
  var dt=delta/1000,ep=this.ep,es=this.es,god=this.god;
  // Koan text
  this._koanT+=delta;
  if(this._koanT>6000){
    this._koanT=0;
    this._koanIdx=(this._koanIdx+1)%VOID_KOANS.length;
    this.koanTxt.setText(VOID_KOANS[this._koanIdx]).setAlpha(1);
    this.tweens.add({targets:this.koanTxt,alpha:0,duration:4500,delay:1200,ease:'Linear'});
  }
  var pad=this.input.gamepad&&this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;
  var gpL=false,gpR=false,gpJ=false,gpKick=false,gpPunchHeld=false;
  if(pad){var axV=pad.axes.length>0?pad.axes[0].getValue():0;gpL=(pad.left)||(axV<-0.3);gpR=(pad.right)||(axV>0.3);gpJ=(pad.up)||(pad.A&&pad.A.pressed);gpPunchHeld=!!(pad.X&&pad.X.pressed);var kNow=pad.B&&pad.B.pressed;gpKick=kNow&&!this._prevKickGP;this._prevKickGP=kNow;}
  var goL=this.keys.left.isDown||this.keys.altL.isDown||gpL;
  var goR=this.keys.right.isDown||this.keys.altR.isDown||gpR;
  var goJ=this.keys.up.isDown||this.keys.altU.isDown||gpJ;
  var doKick=Phaser.Input.Keyboard.JustDown(this.keys.kick)||gpKick;
  var zHeld=this.keys.punch.isDown||gpPunchHeld;
  var zWasHeld=this._prevZHeld||false;
  var zJustReleased=(!zHeld)&&zWasHeld;
  if(zHeld&&es.punchTimer<=0&&es.kickTimer<=0){var _pct=ep.chargeT;ep.chargeT+=delta;if(ep.chargeT>200&&Math.floor(ep.chargeT/300)>Math.floor(_pct/300))SOUND.charge();}
  if(zJustReleased&&es.punchTimer<=0&&es.kickTimer<=0){
    if(ep.chargeT>=1200){this._emberBlast();}
    else if(ep.chargeT>=60){es.punchTimer=340;es.punchActive=true;SOUND.punch();}
    ep.chargeT=0;
  }
  if(!zHeld) ep.chargeT=Math.max(0,ep.chargeT-delta*3);
  this._prevZHeld=zHeld;
  var tVx=0;
  if(goL){tVx=-ED_MOVE.walkSpeed;es.facing=-1;} if(goR){tVx=ED_MOVE.walkSpeed;es.facing=1;}
  var airM=ep.grounded?1:ED_MOVE.airControl;
  ep.vx+=(tVx-ep.vx)*Math.min(1,12*dt*airM);
  var wasGrounded=ep.grounded;
  if(goJ) ep.jumpBufMs=ED_MOVE.jumpBufMs; else ep.jumpBufMs=Math.max(0,ep.jumpBufMs-delta);
  if(ep.grounded) ep.coyoteMs=ED_MOVE.coyoteMs; else ep.coyoteMs=Math.max(0,ep.coyoteMs-delta);
  // Reduced gravity in void (floaty jumps)
  var voidGrav=god.phase>=3?650:550;
  if(ep.jumpBufMs>0&&ep.coyoteMs>0&&ep.vy>=-10){ep.vy=ED_MOVE.jumpVel*1.15;ep.jumpBufMs=0;ep.coyoteMs=0;ep.grounded=false;SOUND.jump();}
  if(!goJ&&ep.vy<0) ep.vy*=ED_MOVE.jumpCut;
  // Double jump always works in The Void
  if(!ep.grounded&&wasGrounded===false&&ep.coyoteMs<=0&&ep.jumpBufMs>0&&ep.vy>0&&!ep.djUsed){ep.vy=ED_MOVE.jumpVel*0.9;ep.djUsed=true;ep.jumpBufMs=0;SOUND.jump();spawnExplosion(ep.x,ep.y,0xcc44ff,0.8);}
  if(ep.grounded) ep.djUsed=false;
  ep.vy=Math.min(ep.vy+voidGrav*dt,ED_MOVE.maxFall);
  ep.x+=ep.vx*dt; ep.y+=ep.vy*dt; ep.grounded=false;
  var edL=ep.x-14,edR=ep.x+14,edBot=ep.y;
  if(edBot>=490&&ep.vy>=0){ep.y=490;ep.vy=0;ep.grounded=true;}
  for(var pi=1;pi<this.platRects.length;pi++){var pl=this.platRects[pi];if(ep.vy>=0&&edBot>=pl.y&&edBot<=pl.y+pl.h+6&&edL<pl.x+pl.w&&edR>pl.x){if(edBot-ep.vy*dt<pl.y+3){ep.y=pl.y;ep.vy=0;ep.grounded=true;}}}
  if(ep.x<14){ep.x=14;ep.vx=0;} if(ep.x>946){ep.x=946;ep.vx=0;}
  if(ep.y>580){this._triggerDeath();return;}
  if(es.hurtTimer>0) es.hurtTimer-=delta;
  if(es.punchTimer>0){es.punchTimer-=delta;es.punchActive=es.punchTimer>90;}
  if(doKick&&es.kickTimer<=0&&es.punchTimer<=0){es.kickTimer=600;es.kickActive=true;}
  if(es.kickTimer>0){es.kickTimer-=delta;es.kickActive=es.kickTimer>200;}
  if(EWR_STATE.combo.streak>0){EWR_STATE.combo.timer-=delta;if(EWR_STATE.combo.timer<=0){EWR_STATE.combo.streak=0;EWR_STATE.combo.mult=1;}}
  // God active
  if(god.dieT>=0){
    god.dieT+=delta;
    if(god.dieT>400){spawnExplosion(god.x+(Math.random()-0.5)*160,god.y+(Math.random()-0.5)*120,0xcc44ff,3);}
    if(god.dieT>5000&&!this._beaten){this._beatVoid();}
  } else {
    var newPhase=god.hp>20?1:god.hp>10?2:3;
    if(newPhase>god.phase){
      god.phase=newPhase; SOUND.bossHit();
      this.cameras.main.shake(600,0.028);
      god.shotInterval=newPhase>=3?1200:1800;
      this._flash(newPhase>=3?'THE GOD AWAKENS':'PHASE '+newPhase+': MANIFESTATION',1500);
    }
    // God float
    god.bT+=delta;
    god.x+=Math.sin(god.bT*0.0008)*1.5;
    god.y+=Math.cos(god.bT*0.0006)*1.2;
    god.x=Phaser.Math.Clamp(god.x,100,860);
    god.y=Phaser.Math.Clamp(god.y,60,380);
    // Teleport (phase 2+)
    god.teleT+=delta;
    if(god.phase>=2&&god.teleT>=5500){
      god.teleT=0;
      god.x=100+Math.random()*760; god.y=80+Math.random()*280;
      spawnExplosion(god.x,god.y,0xcc44ff,2);
      this.cameras.main.shake(200,0.015);
    }
    // Shooting
    god.shotT+=delta;
    if(god.shotT>=god.shotInterval){
      god.shotT=0;
      var nS=god.phase>=3?5:god.phase>=2?3:2;
      var gdx=ep.x-god.x,gdy=ep.y-god.y;
      var gdist=Math.sqrt(gdx*gdx+gdy*gdy)||1;
      var gSpd=god.phase>=3?250:180;
      for(var gs=0;gs<nS;gs++){
        var gang=(gs-(nS-1)/2)*0.32;
        god.projectiles.push({
          x:god.x,y:god.y,
          vx:(gdx/gdist*Math.cos(gang)-gdy/gdist*Math.sin(gang))*gSpd,
          vy:(gdy/gdist*Math.cos(gang)+gdx/gdist*Math.sin(gang))*gSpd*0.8,
          life:1.0
        });
      }
      SOUND.kick();
    }
    // Phase 2+: spawn clones
    if(god.phase>=2&&god.clones.length<4&&Math.random()<0.001){
      god.clones.push({x:100+Math.random()*760,y:150+Math.random()*280,hp:1,spd:45,dir:Math.random()<0.5?1:-1,bT:0,bAmt:0,dieT:-1,squishT:0,parts:[],pMin:60,pMax:900,type:'mochi',projectiles:[]});
    }
    for(var cl=0;cl<god.clones.length;cl++){
      var clone=god.clones[cl]; if(clone.dieT>=0){clone.dieT+=delta;clone.squishT+=delta;for(var pp=0;pp<clone.parts.length;pp++){var pt=clone.parts[pp];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.15;pt.life-=0.02;}continue;}
      clone.x+=clone.dir*clone.spd*dt; clone.bT+=delta;
      if(clone.x<clone.pMin){clone.x=clone.pMin;clone.dir=1;} if(clone.x>clone.pMax){clone.x=clone.pMax;clone.dir=-1;}
      if(es.hurtTimer<=0&&Math.abs(ep.x-clone.x)<30&&Math.abs(ep.y-clone.y)<30){
        es.hurtTimer=1200; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012); ep.vx=-es.facing*200; ep.vy=-220;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
    }
    // Projectile update
    for(var prj=god.projectiles.length-1;prj>=0;prj--){
      var pj=god.projectiles[prj]; pj.x+=pj.vx*dt; pj.y+=pj.vy*dt; pj.life-=0.005*delta;
      if(es.hurtTimer<=0&&Math.abs(pj.x-ep.x)<22&&Math.abs(pj.y-ep.y)<22){
        EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        SOUND.hurt(); this.cameras.main.shake(250,0.012); es.hurtTimer=1200; ep.vx=-ep.vx*0.2; ep.vy=-180;
        god.projectiles.splice(prj,1);
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
        continue;
      }
      if(pj.life<=0||pj.x<-60||pj.x>1020||pj.y<-60||pj.y>600) god.projectiles.splice(prj,1);
    }
    // God-Ed contact
    if(es.hurtTimer<=0&&Math.abs(ep.x-god.x)<55&&Math.abs(ep.y-god.y)<55){
      es.hurtTimer=1500; EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
      SOUND.hurt(); this.cameras.main.shake(400,0.022);
      ep.vx=-es.facing*(god.phase>=3?480:320); ep.vy=-280;
      if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
    }
    if(god.hitFlash>0) god.hitFlash-=delta;
    // Ed punch → god/clone
    if(es.punchActive){
      var hx=ep.x+es.facing*56; var consumed=false;
      for(var ci2=0;ci2<god.clones.length;ci2++){
        var cl2=god.clones[ci2]; if(cl2.dieT>=0) continue;
        if(Math.abs(hx-cl2.x)<50&&Math.abs(ep.y-cl2.y)<38){
          cl2.hp--; spawnExplosion(cl2.x,cl2.y,0xffd60a,1); SOUND.punch();
          _addCombo(this,cl2.x,cl2.y);
          if(cl2.hp<=0){cl2.dieT=0;cl2.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath;spawnExplosion(cl2.x,cl2.y,0xff4444,2);this._spawnMochiParts(cl2);}
          es.punchActive=false; consumed=true; break;
        }
      }
      if(!consumed&&Math.abs(hx-god.x)<70&&Math.abs(ep.y-god.y)<75){
        god.hp--; god.hitFlash=420; SOUND.bossHit();
        _addCombo(this,god.x,god.y-50); this.cameras.main.shake(110,0.009);
        spawnExplosion(god.x,god.y,0xffd60a,2);
        EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*EWR_STATE.combo.mult);
        if(god.hp<=0){god.dieT=0;this._godDie();}
        es.punchActive=false;
      }
    }
    if(es.kickActive){
      var kx=ep.x+es.facing*ED_MOVE.kickRange;
      var kC=false;
      for(var ci3=0;ci3<god.clones.length;ci3++){
        var cl3=god.clones[ci3]; if(cl3.dieT>=0) continue;
        if(Math.abs(kx-cl3.x)<65&&Math.abs(ep.y-cl3.y)<42){
          cl3.hp-=2; spawnExplosion(cl3.x,cl3.y,0xff6b35,1.5); SOUND.kick();
          _addCombo(this,cl3.x,cl3.y);
          if(cl3.hp<=0){cl3.dieT=0;cl3.squishT=0;EWR_STATE.aloe+=ALOE.mochiDeath;spawnExplosion(cl3.x,cl3.y,0xff4444,2.5);this._spawnMochiParts(cl3);}
          es.kickActive=false; kC=true; break;
        }
      }
      if(!kC&&Math.abs(kx-god.x)<85&&Math.abs(ep.y-god.y)<80){
        god.hp-=2; god.hitFlash=480; SOUND.bossHit();
        _addCombo(this,god.x,god.y-50); this.cameras.main.shake(170,0.015);
        spawnExplosion(god.x,god.y,0xff6b35,2.5);
        EWR_STATE.aloe+=Math.ceil(ALOE.bossHit*2*EWR_STATE.combo.mult);
        if(god.hp<=0){god.dieT=0;this._godDie();}
        es.kickActive=false;
      }
    }
  }
  es.cigF++; es.smokeT+=delta;
  if(es.smokeT>950){es.smokeT=0;spawnSmoke(ep.x+es.facing*14,ep.y-25);}
  updateSmoke(); updateExplosions(); updateFire();
  if(god.phase>=3){spawnFire(god.x+(Math.random()-0.5)*80,god.y+(Math.random()-0.5)*60);}
  // Psychedelic void atmosphere (always some effect)
  var pvt=this.levelT;
  this.psychG.clear();
  var vCols=[0x4400ff,0xcc00ff,0x0044ff,0xff0088,0x00ffcc];
  var vi=Math.floor(pvt/1800)%vCols.length;
  this.psychG.fillStyle(vCols[vi],0.04+Math.sin(pvt*0.002)*0.02);
  this.psychG.fillRect(0,0,960,540);
  if(EWR_STATE.health[0]<=1){
    this.cameras.main.setRotation(Math.sin(pvt*0.003)*0.015);
    this.psychG.fillStyle(0xff0044,0.12); this.psychG.fillRect(0,0,960,540);
  } else {this.cameras.main.setRotation(0);}
  var frame=0;
  if(es.hurtTimer>900)frame=7;
  else if(!ep.grounded)frame=4;
  else if(es.kickTimer>400)frame=6;
  else if(es.punchTimer>200||ep.chargeT>200)frame=5;
  else if(Math.abs(ep.vx)>20)frame=Math.floor(this.levelT/120)%4;
  this.godG.clear();
  this._drawGod(this.godG,god);
  this.edG.clear();
  DRAW_ED.draw(this.edG,ep.x,ep.y,frame,es.facing<0,es.cigF);
  if(ep.chargeT>0){var cr=Math.min(ep.chargeT/1200,1.0);this.edG.fillStyle(cr>=1?0xffffff:0xff6600,0.3+cr*0.5);this.edG.fillCircle(ep.x+es.facing*28,ep.y-27,5+cr*14);}
  if(es.punchActive){this.edG.fillStyle(0xffd60a,0.15);this.edG.fillCircle(ep.x+es.facing*56,ep.y-20,28);}
  if(es.kickActive){this.edG.fillStyle(0xff6b35,0.18);this.edG.fillCircle(ep.x+es.facing*ED_MOVE.kickRange,ep.y-10,32);}
  drawExplosions(this.edG); drawFire(this.edG);
  for(var sp=0;sp<SMOKE_POOL.length;sp++){var p=SMOKE_POOL[sp];this.edG.fillStyle(0xaaaaaa,p.life*0.3);this.edG.fillCircle(p.x,p.y,p.r);}
  if(EWR_STATE.combo.streak>=3){
    var cStr=EWR_STATE.combo.streak>=10?'ON FIRE '+EWR_STATE.combo.streak+'x':EWR_STATE.combo.streak+'x COMBO';
    var cCol=EWR_STATE.combo.streak>=10?'#ff6b00':EWR_STATE.combo.streak>=6?'#ffd60a':'#ffffff';
    this.comboText.setText(cStr).setPosition(ep.x,ep.y-80).setStyle({color:cCol}).setAlpha(1);
  } else {this.comboText.setAlpha(0);}
  this.hudG.clear(); DRAW_HUD.draw(this.hudG,this.aloeText);
};

// ════════════════════════════════════════════════════════════════
// CHUNK 6: PHASER GAME CONFIG
// ════════════════════════════════════════════════════════════════

// ══════════════════════════════════════════════════════
// WORLD 2: THE NEON DISTRICT — MAP DATA + SCENE
// ══════════════════════════════════════════════════════
var W2_ROWS = [
  'NNNNNNNN',
  'NX  6  N',
  'N  PPP N',
  'N  P   N',
  'N  7   N',
  'N  P C N',
  'N  8P9 N',
  'NNNNNNNN'
];
var W2_TILES = {
  ' ':{type:'empty',   passable:true},
  'N':{type:'neon_wall',passable:false},
  'P':{type:'neon_path',passable:true},
  'X':{type:'exit',    passable:true, id:'exit-W1', label:'Back to West Bottoms'},
  '6':{type:'level',   passable:true, id:'2-1', label:'Signal Static'},
  '7':{type:'level',   passable:true, id:'2-2', label:'Chrome Alley'},
  '8':{type:'level',   passable:true, id:'2-3', label:'The Neon King'},
  '9':{type:'level',   passable:true, id:'2-4', label:'The Cat Cig Parade'},
  'C':{type:'catspot', passable:true}
};

function WorldMap2Scene(){ Phaser.Scene.call(this,{key:'WorldMap2'}); }
WorldMap2Scene.prototype = Object.create(Phaser.Scene.prototype);
WorldMap2Scene.prototype.constructor = WorldMap2Scene;

WorldMap2Scene.prototype.create = function(){
  var W=960,H=540,self=this;
  this.tW=80; this.tH=60; this.offX=80; this.offY=60;
  this.edTile={x:2,y:1};
  if(EWR_STATE.playerPosW2){this.edTile.x=EWR_STATE.playerPosW2.x;this.edTile.y=EWR_STATE.playerPosW2.y;}
  this.shopOpen=false; this.shopSel=0;
  this.inputCooldown=0;

  // Neon city background
  var bg=this.add.graphics().setDepth(0);
  bg.fillStyle(0x050010,1); bg.fillRect(0,0,W,H);
  // Grid lines
  bg.lineStyle(1,0x001133,0.5);
  for(var gx=0;gx<W;gx+=40){bg.beginPath();bg.moveTo(gx,0);bg.lineTo(gx,H);bg.strokePath();}
  for(var gy=0;gy<H;gy+=40){bg.beginPath();bg.moveTo(0,gy);bg.lineTo(W,gy);bg.strokePath();}
  // Neon buildings silhouette
  var bldColors=[0x00ffcc,0xff00ff,0x00aaff,0xffaa00];
  var bldData=[[20,200,60,340],[110,280,50,260],[200,230,70,310],[310,260,45,280],
               [600,190,65,350],[700,250,55,290],[790,220,70,320],[870,270,50,270]];
  for(var bi=0;bi<bldData.length;bi++){
    var bd=bldData[bi];
    bg.fillStyle(0x08001a,1); bg.fillRect(bd[0],bd[1],bd[2],bd[3]);
    bg.lineStyle(1,bldColors[bi%4],0.6); bg.strokeRect(bd[0],bd[1],bd[2],bd[3]);
    // Windows
    bg.fillStyle(bldColors[bi%4],0.4);
    for(var wr=bd[1]+8;wr<bd[1]+bd[3]-10;wr+=16){
      for(var wc=bd[0]+6;wc<bd[0]+bd[2]-6;wc+=12){
        if(Math.random()<0.6) bg.fillRect(wc,wr,6,8);
      }
    }
  }
  // Stars
  bg.fillStyle(0xffffff,0.8);
  for(var si=0;si<60;si++) bg.fillRect(Math.random()*W,Math.random()*180,1,1);

  this.mapG = this.add.graphics().setDepth(2);
  this._drawMapW2();

  // Ed sprite (reuse from WorldMap logic)
  this.edG = this.add.graphics().setDepth(10);
  this._drawEdW2();

  // Node label
  this.nodeTxt = this.add.text(W/2,H-22,'',{fontFamily:'Courier New,monospace',fontSize:'13px',color:'#00ffcc',stroke:'#000022',strokeThickness:3}).setOrigin(0.5,1).setDepth(20).setAlpha(0);

  // HUD
  this.hudTxt = this.add.text(10,8,'',{fontFamily:'Courier New,monospace',fontSize:'13px',color:'#00ffcc',stroke:'#000022',strokeThickness:3}).setDepth(20);
  this._updateHudW2();

  // Shop panel (hidden)
  this.shopPanel = this.add.graphics().setDepth(25).setAlpha(0);
  this.shopTxt   = this.add.text(W/2,H/2,'',{fontFamily:'Courier New,monospace',fontSize:'14px',color:'#00ffcc',stroke:'#000022',strokeThickness:3,align:'center'}).setOrigin(0.5).setDepth(26).setAlpha(0);

  // Title
  this.add.text(W/2,14,'THE NEON DISTRICT',{fontFamily:'Courier New,monospace',fontSize:'16px',color:'#ff00ff',stroke:'#000022',strokeThickness:4}).setOrigin(0.5,0).setDepth(20);

  // Cats
  this.mapCats = [];
  this._spawnCatsW2();
  this.catG = this.add.graphics().setDepth(8);

  // Input
  this.cursors = this.input.keyboard.createCursorKeys();
  this.keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);
  this.keyX2= this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X);
  this.keyEnter = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);
  _initVPad(this);
};

WorldMap2Scene.prototype._updateHudW2 = function(){
  this.hudTxt.setText('ALOE: '+EWR_STATE.aloe+'  HP: '+EWR_STATE.health[0]+'/'+EWR_STATE.maxHealth[0]);
};

WorldMap2Scene.prototype._drawEdW2 = function(){
  var g=this.edG; g.clear();
  var p=this._t2pW2(this.edTile.x,this.edTile.y);
  var ex=p.x, ey=p.y-10;
  g.fillStyle(0x00ffcc,1); g.fillCircle(ex,ey-8,9);
  g.fillStyle(0x050010,1); g.fillCircle(ex-3,ey-10,2); g.fillCircle(ex+3,ey-10,2);
  g.fillStyle(0x00ffcc,0.9); g.fillRect(ex-7,ey,14,16);
};

WorldMap2Scene.prototype._t2pW2 = function(tx,ty){
  return {x:this.offX+tx*this.tW+this.tW/2, y:this.offY+ty*this.tH+this.tH+60};
};

WorldMap2Scene.prototype._getTileW2 = function(tx,ty){
  if(ty<0||ty>=W2_ROWS.length) return null;
  var row=W2_ROWS[ty]; if(tx<0||tx>=row.length) return null;
  var ch=row[tx]; return W2_TILES[ch]||null;
};

WorldMap2Scene.prototype._drawMapW2 = function(){
  var g=this.mapG, self=this;
  g.clear();
  for(var row=0;row<W2_ROWS.length;row++){
    for(var col=0;col<W2_ROWS[row].length;col++){
      var ch=W2_ROWS[row][col], tile=W2_TILES[ch]; if(!tile) continue;
      var px=self.offX+col*self.tW, py=self.offY+row*self.tH+60;
      switch(tile.type){
        case 'neon_wall':
          g.fillStyle(0x0a0020,1); g.fillRect(px,py,self.tW,self.tH);
          g.lineStyle(1,0x440088,0.8); g.strokeRect(px,py,self.tW,self.tH); break;
        case 'neon_path':
          g.fillStyle(0x050015,1); g.fillRect(px,py,self.tW,self.tH);
          g.lineStyle(1,0x00ffcc,0.25); g.strokeRect(px,py,self.tW,self.tH); break;
        case 'empty':
          g.fillStyle(0x070018,1); g.fillRect(px,py,self.tW,self.tH); break;
        case 'exit':
          g.fillStyle(0x070018,1); g.fillRect(px,py,self.tW,self.tH);
          g.fillStyle(0xff00ff,0.18); g.fillCircle(px+self.tW/2,py+self.tH/2,22);
          g.fillStyle(0xff00ff,1); g.fillCircle(px+self.tW/2,py+self.tH/2,12);
          g.fillStyle(0x050010,1); g.fillCircle(px+self.tW/2,py+self.tH/2,8);
          g.fillStyle(0x00ffcc,1); g.fillCircle(px+self.tW/2,py+self.tH/2,5); break;
        case 'level':
          g.fillStyle(0x070018,1); g.fillRect(px,py,self.tW,self.tH);
          var beaten2=EWR_STATE.levelsBeaten.indexOf(tile.id)>=0;
          g.fillStyle(beaten2?0x444444:0x00ffcc,0.22); g.fillCircle(px+self.tW/2,py+self.tH/2,22);
          g.fillStyle(beaten2?0x666666:0x00ffcc,1);    g.fillCircle(px+self.tW/2,py+self.tH/2,12);
          g.fillStyle(0x050010,1); g.fillCircle(px+self.tW/2,py+self.tH/2,8);
          g.fillStyle(beaten2?0x666666:0x00ffcc,1);    g.fillCircle(px+self.tW/2,py+self.tH/2,5); break;
        case 'catspot':
        default:
          g.fillStyle(0x070018,1); g.fillRect(px,py,self.tW,self.tH); break;
      }
    }
  }
};

WorldMap2Scene.prototype._spawnCatsW2 = function(){
  for(var ri=0;ri<W2_ROWS.length;ri++){
    for(var ci=0;ci<W2_ROWS[ri].length;ci++){
      if(W2_ROWS[ri][ci]==='C'){
        var p=this._t2pW2(ci,ri);
        this.mapCats.push({x:p.x,y:p.y-10,ci:0,tailAng:0,facing:1,wT:0,sitting:true,petted:false});
      }
    }
  }
};

WorldMap2Scene.prototype._tryEnterW2 = function(){
  var tile=this._getTileW2(this.edTile.x,this.edTile.y);
  if(!tile) return;
  if(tile.type==='exit'){
    EWR_STATE.playerPosW2={x:this.edTile.x,y:this.edTile.y};
    SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;
    this.scene.start('WorldMap'); return;
  }
  if(tile.type==='level'){
    var gateMsg2=null;
    if(tile.id==='2-2'&&EWR_STATE.levelsBeaten.indexOf('2-1')<0) gateMsg2='Beat Signal Static first!';
    if(tile.id==='2-3'&&EWR_STATE.levelsBeaten.indexOf('2-2')<0) gateMsg2='Beat Chrome Alley first!';
    if(tile.id==='2-4'&&EWR_STATE.levelsBeaten.indexOf('2-3')<0) gateMsg2='Beat The Neon King first!';
    if(gateMsg2){
      var self=this;
      this.nodeTxt.setText(gateMsg2).setAlpha(1);
      this.time.delayedCall(2200,function(){self.nodeTxt.setAlpha(0);});
      return;
    }
    var destMap={'2-1':'Level21','2-2':'Level22','2-3':'Level23','2-4':'Level24'};
    var dest2=destMap[tile.id];
    if(dest2){EWR_STATE.playerPosW2={x:this.edTile.x,y:this.edTile.y};SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;this.scene.start(dest2);}
  }
};

WorldMap2Scene.prototype._openShopW2 = function(){
  var W=960,H=540;
  this.shopOpen=true; this.shopSel=0;
  this.shopPanel.setAlpha(1);
  this.shopPanel.clear();
  this.shopPanel.fillStyle(0x050010,0.95); this.shopPanel.fillRoundedRect(W/2-200,H/2-130,400,260,12);
  this.shopPanel.lineStyle(2,0x00ffcc,1); this.shopPanel.strokeRoundedRect(W/2-200,H/2-130,400,260,12);
  this._renderShopW2();
};

WorldMap2Scene.prototype._renderShopW2 = function(){
  var items=[
    {key:'lifeSteal',  label:'Life Steal',   cost:350, desc:'Kills heal 0.33 HP'},
    {key:'aloeMagnet', label:'Aloe Magnet',  cost:200, desc:'Pickup range 44\u219244px\u219244140px'}
  ];
  var lines=['[ NEON DISTRICT SHOP ]',''];
  for(var i=0;i<items.length;i++){
    var it=items[i];
    var owned=EWR_STATE.shop[it.key];
    var prefix=this.shopSel===i?'> ':'  ';
    lines.push(prefix+(owned?'[OWNED] ':'')+it.label+' — '+it.cost+' aloe');
    lines.push('    '+it.desc);
    lines.push('');
  }
  lines.push('  [ESC / X to close]');
  this.shopTxt.setText(lines.join('\n')).setAlpha(1);
};

WorldMap2Scene.prototype._buyShopW2 = function(){
  var items=[
    {key:'lifeSteal',  cost:350},
    {key:'aloeMagnet', cost:200}
  ];
  var it=items[this.shopSel];
  if(!it) return;
  if(EWR_STATE.shop[it.key]){return;}
  if(EWR_STATE.aloe<it.cost){
    this.nodeTxt.setText('Not enough aloe!').setAlpha(1);
    var self=this; this.time.delayedCall(1500,function(){self.nodeTxt.setAlpha(0);});
    return;
  }
  EWR_STATE.aloe-=it.cost;
  EWR_STATE.shop[it.key]=true;
  this._renderShopW2();
  this._updateHudW2();
};

WorldMap2Scene.prototype.update = function(time,delta){
  if(this.inputCooldown>0){this.inputCooldown-=delta; return;}
  var cur=this.cursors;
  var upP=Phaser.Input.Keyboard.JustDown(cur.up);
  var downP=Phaser.Input.Keyboard.JustDown(cur.down);
  var leftP=Phaser.Input.Keyboard.JustDown(cur.left);
  var rightP=Phaser.Input.Keyboard.JustDown(cur.right);
  var zJD=Phaser.Input.Keyboard.JustDown(this.keyZ);
  var xJD=Phaser.Input.Keyboard.JustDown(this.keyX2);
  var entJD=Phaser.Input.Keyboard.JustDown(this.keyEnter);

  if(this.shopOpen){
    var items2=[{key:'lifeSteal'},{key:'aloeMagnet'}];
    if(upP){this.shopSel=Math.max(0,this.shopSel-1);this._renderShopW2();}
    if(downP){this.shopSel=Math.min(items2.length-1,this.shopSel+1);this._renderShopW2();}
    if(zJD||entJD){this._buyShopW2();}
    if(xJD){this.shopOpen=false;this.shopPanel.setAlpha(0);this.shopTxt.setAlpha(0);}
    return;
  }

  var moved=false;
  var nx=this.edTile.x, ny=this.edTile.y;
  if(upP)    ny--;
  if(downP)  ny++;
  if(leftP)  nx--;
  if(rightP) nx++;
  if(nx!==this.edTile.x||ny!==this.edTile.y){
    var nt=this._getTileW2(nx,ny);
    if(nt&&nt.passable){
      this.edTile.x=nx; this.edTile.y=ny; moved=true;
      this.inputCooldown=140;
      // Show label
      if(nt.label){this.nodeTxt.setText(nt.label).setAlpha(1);this.time.delayedCall(1800,function(){});}
      else{this.nodeTxt.setAlpha(0);}
    }
  }
  if((zJD||entJD)&&!moved){
    this._tryEnterW2();
  }
  if(xJD&&!moved){
    // Check shop — shop is near exit tile
    var shopTile=this._getTileW2(this.edTile.x,this.edTile.y);
    if(shopTile&&shopTile.type==='neon_path'){this._openShopW2();}
  }
  // Cat petting
  for(var ci=0;ci<this.mapCats.length;ci++){
    var cat=this.mapCats[ci]; cat.tailAng+=0.04;
    var ep2=this._t2pW2(this.edTile.x,this.edTile.y);
    if(zJD&&Math.abs(ep2.x-cat.x)<50&&!cat.petted){
      cat.petted=true; EWR_STATE.aloe+=ALOE.catPet; EWR_STATE.catsPetted++;
      this.nodeTxt.setText('+'+ALOE.catPet+' ALOE  (neon meow!)').setAlpha(1);
      this._updateHudW2();
    }
  }
  if(moved){this._drawEdW2(); this._drawMapW2();}
  // Draw cats
  var cg=this.catG; cg.clear();
  for(var ci2=0;ci2<this.mapCats.length;ci2++){
    var ct=this.mapCats[ci2];
    cg.fillStyle(0x00ffcc,1); cg.fillCircle(ct.x,ct.y-8,7);
    cg.fillStyle(0x050010,1); cg.fillCircle(ct.x-2,ct.y-10,1); cg.fillCircle(ct.x+2,ct.y-10,1);
    cg.fillStyle(0xff00ff,1); cg.fillRect(ct.x-5,ct.y,10,10);
    cg.lineStyle(1,0x00ffcc,0.8); cg.beginPath();
    cg.moveTo(ct.x,ct.y+10);
    cg.lineTo(ct.x+Math.sin(ct.tailAng)*12,ct.y+20); cg.strokePath();
  }
};


// ══════════════════════════════════════════════════════
// LEVEL 2-1: SIGNAL STATIC (factory)
// ══════════════════════════════════════════════════════
var Level21Scene = createLevelScene({
  key:'Level21', LW:5200, beatX:5185, beatKey:'2-1', checkptX:2600,
  aloeReward:ALOE.beat21, returnScene:'WorldMap2',
  title:'2-1  SIGNAL STATIC', intro:'SIGNAL STATIC',
  plats:[
    [130,400,100,18],[340,360,80,18],[560,420,70,18],[780,380,90,18],[1000,340,80,18],
    [1180,420,100,18],[1360,370,80,18],[1520,440,70,18],[1680,390,90,18],
    [1860,350,80,18],[2020,420,90,18],[2160,370,70,18],[2340,410,100,18],
    [2520,340,80,18],[2680,400,90,18],[2840,450,70,18],[3000,370,80,18],
    [3160,430,90,18],[3320,380,70,18],[3480,340,90,18],[3640,420,80,18],
    [3800,370,100,18],[3980,440,70,18],[4140,390,80,18],[4300,360,100,18],
    [4460,420,90,18],[4620,380,80,18],[4800,350,100,18]
  ],
  catX:[400,800,1200,1600,2000,2400,2800,3200,3600,4000,4400,4800],
  mochis:[
    {x:350,  type:'ghost',baseY:310, dir:1,spd:55,hp:2,pMin:200, pMax:600},
    {x:680,  type:'ghost',baseY:340, dir:-1,spd:55,hp:2,pMin:500, pMax:900},
    {x:1050, type:'ghost',baseY:300, dir:1,spd:55,hp:2,pMin:850, pMax:1250},
    {x:1400, type:'ghost',baseY:330, dir:-1,spd:55,hp:2,pMin:1200,pMax:1600},
    {x:1750, type:'ghost',baseY:310, dir:1,spd:55,hp:2,pMin:1550,pMax:1950},
    {x:2100, type:'ghost',baseY:340, dir:-1,spd:55,hp:2,pMin:1900,pMax:2300},
    {x:2450, type:'ghost',baseY:315, dir:1,spd:60,hp:2,pMin:2250,pMax:2650},
    {x:2800, type:'ghost',baseY:325, dir:-1,spd:60,hp:2,pMin:2600,pMax:3000},
    {x:3150, type:'ghost',baseY:300, dir:1,spd:60,hp:2,pMin:2950,pMax:3350},
    {x:3500, type:'ghost',baseY:335, dir:-1,spd:65,hp:2,pMin:3300,pMax:3700},
    {x:3850, type:'ghost',baseY:310, dir:1,spd:65,hp:2,pMin:3650,pMax:4050},
    {x:4200, type:'ghost',baseY:320, dir:-1,spd:65,hp:2,pMin:4000,pMax:4500},
    {x:4600, type:'ghost',baseY:300, dir:1,spd:70,hp:2,pMin:4400,pMax:4900},
    {x:4950, type:'ghost',baseY:330, dir:-1,spd:70,hp:2,pMin:4700,pMax:5100}
  ],
  pickups:[[1200,280],[2600,300],[3800,270],[4600,300]]
});

// ══════════════════════════════════════════════════════
// LEVEL 2-2: CHROME ALLEY (factory)
// ══════════════════════════════════════════════════════
var Level22Scene = createLevelScene({
  key:'Level22', LW:5600, beatX:5585, beatKey:'2-2', checkptX:2800,
  aloeReward:ALOE.beat22, returnScene:'WorldMap2',
  title:'2-2  CHROME ALLEY', intro:'CHROME ALLEY',
  plats:[
    [120,410,110,18],[330,370,80,18],[550,430,70,18],[760,380,100,18],[970,340,80,18],
    [1150,420,90,18],[1320,460,60,18],[1480,390,80,18],[1640,350,100,18],
    [1820,430,80,18],[1990,370,90,18],[2160,440,70,18],[2330,400,100,18],
    [2510,360,80,18],[2670,430,90,18],[2830,380,70,18],[2990,340,80,18],
    [3160,420,100,18],[3320,460,70,18],[3480,370,90,18],[3640,410,80,18],
    [3800,350,100,18],[3960,430,80,18],[4120,380,90,18],[4280,440,70,18],
    [4440,360,100,18],[4600,420,80,18],[4760,380,90,18],[4920,340,70,18],
    [5080,410,100,18],[5200,380,80,18],[5380,350,90,18]
  ],
  catX:[500,1000,1500,2000,2500,3000,3500,4000,4500,5000],
  mochis:[
    {x:350,  type:'ghost',  baseY:320, dir:1, spd:55,hp:2,pMin:200, pMax:650},
    {x:700,  type:'bomber',            dir:-1,spd:28,hp:5,pMin:500, pMax:950},
    {x:1100, type:'ghost',  baseY:310, dir:1, spd:55,hp:2,pMin:850, pMax:1300},
    {x:1500, type:'bomber',            dir:-1,spd:28,hp:5,pMin:1300,pMax:1700},
    {x:1850, type:'ghost',  baseY:330, dir:1, spd:60,hp:2,pMin:1650,pMax:2100},
    {x:2200, type:'bomber',            dir:-1,spd:30,hp:5,pMin:2000,pMax:2500},
    {x:2600, type:'ghost',  baseY:315, dir:1, spd:60,hp:2,pMin:2400,pMax:2900},
    {x:3000, type:'bomber',            dir:-1,spd:30,hp:5,pMin:2800,pMax:3200},
    {x:3350, type:'ghost',  baseY:305, dir:1, spd:65,hp:2,pMin:3150,pMax:3600},
    {x:3700, type:'ghost',  baseY:325, dir:-1,spd:60,hp:2,pMin:3500,pMax:3950},
    {x:4050, type:'bomber',            dir:1, spd:32,hp:5,pMin:3900,pMax:4400},
    {x:4450, type:'ghost',  baseY:310, dir:-1,spd:65,hp:2,pMin:4200,pMax:4700},
    {x:4800, type:'bomber',            dir:1, spd:32,hp:5,pMin:4600,pMax:5100},
    {x:5200, type:'ghost',  baseY:320, dir:-1,spd:70,hp:2,pMin:5000,pMax:5500},
    {x:5500, type:'bomber',            dir:1, spd:28,hp:5,pMin:5300,pMax:5580}
  ],
  pickups:[[1300,280],[2800,290],[4000,270],[5200,280]]
});


// ══════════════════════════════════════════════════════
// LEVEL 2-3: THE NEON KING (custom boss scene)
// ══════════════════════════════════════════════════════
function Level23Scene(){ Phaser.Scene.call(this,{key:'Level23'}); }
Level23Scene.prototype = Object.create(Phaser.Scene.prototype);
Level23Scene.prototype.constructor = Level23Scene;

Level23Scene.prototype.create = function(){
  var W=960, H=540, self=this;
  this._dying=false; this._dyingT=0; this._beaten=false;
  EX_POOL.length=0; SMOKE_POOL.length=0; FIRE_POOL.length=0;

  // Arena platforms
  this.platRects = [
    {x:0,   y:490, w:960, h:50},   // floor
    {x:100, y:370, w:160, h:18},   // left platform
    {x:400, y:310, w:160, h:18},   // center platform
    {x:700, y:370, w:160, h:18}    // right platform
  ];

  // Ed player
  this.ep = {x:120, y:460, vx:0, vy:0, grounded:false, djUsed:false,
             w:14, h:32, chargeT:0};
  this.es = {facing:1, hurtTimer:0, punchTimer:0, punchActive:false,
             kickTimer:0, kickActive:false, smokeT:0, cigF:0};

  // Boss object
  this.boss = {
    x:720, y:462, hp:28, maxHp:28, phase:1,
    vx:-120, vy:0, grounded:true,
    shotT:0, shotInterval:2400,
    projectiles:[],
    minions:[],
    spawnTimer:0,
    bT:0, hitFlash:0, dieT:-1,
    rotAngle:0,
    _jumpT:0
  };

  // Background: dark neon arena
  var bg = this.add.graphics().setDepth(0);
  bg.fillStyle(0x020008,1); bg.fillRect(0,0,W,H);
  bg.lineStyle(1,0x002244,0.4);
  for(var gx=0;gx<W;gx+=48){bg.beginPath();bg.moveTo(gx,0);bg.lineTo(gx,H);bg.strokePath();}
  for(var gy=0;gy<H;gy+=48){bg.beginPath();bg.moveTo(0,gy);bg.lineTo(W,gy);bg.strokePath();}
  // Neon floor line
  bg.lineStyle(3,0x00ffcc,0.8); bg.beginPath(); bg.moveTo(0,490); bg.lineTo(W,490); bg.strokePath();
  bg.lineStyle(1,0xff00ff,0.4); bg.beginPath(); bg.moveTo(0,492); bg.lineTo(W,492); bg.strokePath();

  // Platform graphics
  this.platG = this.add.graphics().setDepth(1);
  this._drawPlats23();

  // Game graphics layers
  this.mainG  = this.add.graphics().setDepth(5);
  this.bossG  = this.add.graphics().setDepth(6);
  this.projG  = this.add.graphics().setDepth(7);
  this.particleG = this.add.graphics().setDepth(8);
  this.hudG   = this.add.graphics().setDepth(20);

  // HUD texts
  this.bossHpTxt = this.add.text(W/2, 14, '', {
    fontFamily:'Courier New,monospace', fontSize:'13px',
    color:'#00ffcc', stroke:'#000022', strokeThickness:3
  }).setOrigin(0.5,0).setDepth(21);

  this.flashTxt = this.add.text(W/2, H/2-60, '', {
    fontFamily:'Courier New,monospace', fontSize:'22px',
    color:'#ff00ff', stroke:'#000022', strokeThickness:4
  }).setOrigin(0.5).setDepth(22).setAlpha(0);

  this.phaseTxt = this.add.text(W/2, H/2, '', {
    fontFamily:'Courier New,monospace', fontSize:'28px',
    color:'#00ffcc', stroke:'#000022', strokeThickness:5
  }).setOrigin(0.5).setDepth(22).setAlpha(0);

  // Intro text
  this.add.text(W/2, 60, 'THE NEON KING', {
    fontFamily:'Courier New,monospace', fontSize:'32px',
    color:'#ff00ff', stroke:'#000022', strokeThickness:6
  }).setOrigin(0.5).setDepth(21);
  SOUND.charge&&SOUND.charge();

  // Input
  this.cursors = this.input.keyboard.createCursorKeys();
  this.keyZ    = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);
  this.keyX2   = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X);
  _initVPad(this);

  this.levelT = 0;
  this.aloeEarned = 0;
  this.comboMult = 1;
};

Level23Scene.prototype._drawPlats23 = function(){
  var g=this.platG; g.clear();
  for(var i=0;i<this.platRects.length;i++){
    var p=this.platRects[i];
    if(i===0){
      g.fillStyle(0x0a001a,1); g.fillRect(p.x,p.y,p.w,p.h);
      g.lineStyle(2,0x00ffcc,0.8); g.strokeRect(p.x,p.y,p.w,p.h);
    } else {
      g.fillStyle(0x110022,1); g.fillRect(p.x,p.y,p.w,p.h);
      g.lineStyle(2,0xff00ff,0.9); g.strokeRect(p.x,p.y,p.w,p.h);
      g.fillStyle(0x00ffcc,0.5); g.fillRect(p.x,p.y,p.w,3);
    }
  }
};

Level23Scene.prototype._drawBoss23 = function(g, boss){
  if(boss.dieT>=0) return;
  var bx=boss.x, by=boss.y;
  var ph=boss.phase;
  var sc = ph===3?1.9:(ph===2?1.65:1.4);
  var flash=boss.hitFlash>0;
  var p3=ph===3;
  // Shadow
  g.fillStyle(0x000000,0.3); g.fillEllipse(bx,by+4,56*sc,14);
  // Body (metallic dark gray)
  g.fillStyle(flash?0xffffff:0x404048,1);
  g.fillRoundedRect(bx-18*sc,by-48*sc,36*sc,36*sc,5);
  // Outline neon
  g.lineStyle(2,p3?0xff0066:0x00ffcc,1);
  g.strokeRoundedRect(bx-18*sc,by-48*sc,36*sc,36*sc,5);
  // Arms
  g.fillStyle(0x303038,1);
  g.fillRect(bx-30*sc,by-42*sc,12*sc,22*sc); // left arm
  g.fillRect(bx+18*sc, by-42*sc,12*sc,22*sc); // right arm
  g.fillStyle(p3?0xff0066:0x00ffcc,1);
  g.fillCircle(bx-24*sc,by-20*sc,4*sc); // left fist
  g.fillCircle(bx+24*sc,by-20*sc,4*sc); // right fist
  // Legs
  g.fillStyle(0x303038,1);
  g.fillRect(bx-14*sc,by-12*sc,10*sc,18*sc);
  g.fillRect(bx+4*sc,  by-12*sc,10*sc,18*sc);
  // Crown antennae (5 spikes)
  var tipColor=p3?0xff0000:0x00ffcc;
  for(var sp=-2;sp<=2;sp++){
    var sx=bx+sp*8*sc, sy=by-48*sc;
    var sh=12+Math.abs(sp)*4; // taller in center
    g.fillStyle(0x505058,1); g.fillRect(sx-2,sy-sh*sc,4,sh*sc);
    g.fillStyle(tipColor,1); g.fillCircle(sx,sy-sh*sc,3);
  }
  // Eyes
  g.fillStyle(p3?0xff0000:0x00ffff,1);
  g.fillCircle(bx-7*sc,by-36*sc,5*sc);
  g.fillCircle(bx+7*sc, by-36*sc,5*sc);
  g.fillStyle(0x000000,1);
  g.fillCircle(bx-7*sc,by-36*sc,2*sc);
  g.fillCircle(bx+7*sc, by-36*sc,2*sc);
  // HP bar
  var barW=100, barH=8;
  var hpFrac=Math.max(0,boss.hp/boss.maxHp);
  var hpColor = p3?0xff0066:(ph===2?0xffaa00:0x00ffcc);
  g.fillStyle(0x111111,1); g.fillRect(bx-barW/2,by-70*sc,barW,barH);
  g.fillStyle(hpColor,1); g.fillRect(bx-barW/2,by-70*sc,barW*hpFrac,barH);
  g.lineStyle(1,0xffffff,0.4); g.strokeRect(bx-barW/2,by-70*sc,barW,barH);
};

Level23Scene.prototype._drawEd23 = function(g, ep, es, levelT){
  var ex=ep.x, ey=ep.y;
  g.fillStyle(0x000000,0.25); g.fillEllipse(ex,ey+2,24,8);
  // Body
  g.fillStyle(0x2d1b4e,1);
  g.fillRect(ex-6,ey-24,12,20);
  // Head
  g.fillStyle(0xffe0a0,1); g.fillCircle(ex,ey-30,10);
  g.fillStyle(0x111111,1); g.fillCircle(ex+(es.facing*3),ey-31,3);
  // Arms
  g.fillStyle(0x2d1b4e,1); g.fillRect(ex-12,ey-22,6,12); g.fillRect(ex+6,ey-22,6,12);
  // Legs
  g.fillStyle(0x1a0a2e,1);
  g.fillRect(ex-6,ey-4,5,10); g.fillRect(ex+1,ey-4,5,10);
};

Level23Scene.prototype._physEd23 = function(ep, plats, dt, delta){
  var GRAV=1200;
  ep.vy+=GRAV*dt;
  if(ep.vy>700) ep.vy=700;
  ep.x+=ep.vx*dt; ep.y+=ep.vy*dt;
  ep.vx*=Math.pow(0.0001,dt);
  ep.grounded=false;
  for(var i=0;i<plats.length;i++){
    var p=plats[i];
    if(ep.x+ep.w/2>p.x&&ep.x-ep.w/2<p.x+p.w&&ep.y>p.y-2&&ep.y-(ep.vy*dt)<=p.y+2&&ep.vy>=0){
      ep.y=p.y; ep.vy=0; ep.grounded=true; ep.djUsed=false; break;
    }
  }
  if(ep.x<14) ep.x=14;
  if(ep.x>946) ep.x=946;
};

Level23Scene.prototype._physBoss23 = function(boss, delta, dt){
  var GRAV=900, FLOOR=490;
  boss.vy+=GRAV*dt;
  if(boss.vy>600) boss.vy=600;
  boss.x+=boss.vx*dt;
  boss.y+=boss.vy*dt;
  boss.grounded=false;
  if(boss.y>=FLOOR){boss.y=FLOOR;boss.vy=0;boss.grounded=true;}
  if(boss.x<60){boss.x=60;boss.vx=Math.abs(boss.vx);}
  if(boss.x>900){boss.x=900;boss.vx=-Math.abs(boss.vx);}
};

Level23Scene.prototype._triggerDeath = function(){
  this._dying=true;
  SOUND.hurt&&SOUND.hurt();
  this.cameras.main.shake(400,0.025);
  var self=this;
  this.time.delayedCall(1800,function(){
    EWR_STATE.health[0]=1;
    self.scene.start('WorldMap2');
  });
};

Level23Scene.prototype._beatBoss23 = function(){
  if(this._beaten) return;
  this._beaten=true;
  EWR_STATE.levelsBeaten.indexOf('2-3')<0&&EWR_STATE.levelsBeaten.push('2-3');
  EWR_STATE.aloe+=ALOE.beat23;
  EWR_STATE.fightWins=(EWR_STATE.fightWins||0)+1;
  this.phaseTxt.setText('THE NEON KING\nDEFEATED!').setAlpha(1);
  this.cameras.main.shake(500,0.03);
  var self=this;
  this.time.delayedCall(3200,function(){
    SMOKE_POOL.length=0;EX_POOL.length=0;FIRE_POOL.length=0;
    self.scene.start('WorldMap2',{aloeEarned:ALOE.beat23});
  });
};

Level23Scene.prototype.update = function(time, delta){
  if(this._beaten) return;
  if(this._dying){this._dyingT+=delta; return;}
  var self=this;
  var dt=Math.min(delta/1000,0.05);
  this.levelT+=delta;

  var ep=this.ep, es=this.es, boss=this.boss;
  var cur=this.cursors;

  // --- Input ---
  var left  = cur.left.isDown;
  var right = cur.right.isDown;
  var up    = Phaser.Input.Keyboard.JustDown(cur.up);
  var zDown = this.keyZ.isDown;
  var zJD   = Phaser.Input.Keyboard.JustDown(this.keyZ);
  var xJD   = Phaser.Input.Keyboard.JustDown(this.keyX2);
  var doKick= xJD;

  // Horizontal move
  if(left) {ep.vx-=1600*dt; es.facing=-1;}
  if(right){ep.vx+=1600*dt; es.facing=1;}
  if(!left&&!right) ep.vx*=Math.pow(0.001,dt);
  if(ep.vx>220) ep.vx=220; if(ep.vx<-220) ep.vx=-220;

  // Jump
  if(up){
    if(ep.grounded){ep.vy=-520;ep.grounded=false;}
    else if(!ep.djUsed&&EWR_STATE.shop.doubleJump){ep.vy=-480;ep.djUsed=true;}
  }
  if(!cur.up.isDown&&ep.vy<-200) ep.vy*=0.6;

  // Timers
  if(es.hurtTimer>0) es.hurtTimer-=delta;
  if(es.punchTimer>0){es.punchTimer-=delta;es.punchActive=es.punchTimer>90;}
  if(doKick&&es.kickTimer<=0&&es.punchTimer<=0){es.kickTimer=600;es.kickActive=true;}
  if(es.kickTimer>0){es.kickTimer-=delta;es.kickActive=es.kickTimer>200;}

  // Punch / charge
  if(zJD&&es.punchTimer<=0&&es.kickTimer<=0) ep.chargeT=0;
  if(zDown) ep.chargeT+=delta;
  if(!zDown&&ep.chargeT>0){
    if(ep.chargeT>=1200){
      // Ember blast
      var er=80;
      if(Math.abs(ep.x-boss.x)<er+40&&Math.abs(ep.y-boss.y)<er+40&&boss.dieT<0&&boss.hitFlash<=0){
        boss.hp-=3; boss.hitFlash=200;
        spawnExplosion(boss.x,boss.y-20,0xff6b35,2.0);
        this.cameras.main.shake(200,0.018);
        this.aloeEarned+=ALOE.bossHit;
        if(boss.hp<=0){this._killBoss23();return;}
      }
      spawnExplosion(ep.x+es.facing*40,ep.y-20,0xff6b35,1.8);
      SOUND.blast&&SOUND.blast();
    } else if(ep.chargeT>50){
      es.punchTimer=340; es.punchActive=true;
    }
    ep.chargeT=0;
  }

  // Physics
  this._physEd23(ep,this.platRects,dt,delta);
  if(ep.y>620){this._triggerDeath();return;}

  // Punch hits boss
  if(es.punchActive&&boss.dieT<0&&boss.hitFlash<=0){
    var hx=ep.x+es.facing*56;
    if(Math.abs(hx-boss.x)<72&&Math.abs(ep.y-boss.y)<52){
      boss.hp--; boss.hitFlash=200;
      spawnExplosion(boss.x,boss.y-20,0xffd60a,1.2); SOUND.punch&&SOUND.punch();
      this.cameras.main.shake(80,0.006);
      this.aloeEarned+=ALOE.bossHit;
      es.punchActive=false;
      if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}
      if(boss.hp<=0){this._killBoss23();return;}
    }
  }
  // Kick hits boss
  if(es.kickActive&&boss.dieT<0&&boss.hitFlash<=0){
    var kx=ep.x+es.facing*ED_MOVE.kickRange;
    if(Math.abs(kx-boss.x)<72&&Math.abs(ep.y-boss.y)<52){
      boss.hp-=2; boss.hitFlash=220;
      spawnExplosion(boss.x,boss.y-20,0xff6b35,1.5); SOUND.kick&&SOUND.kick();
      this.cameras.main.shake(120,0.009);
      this.aloeEarned+=ALOE.bossHit*2;
      es.kickActive=false;
      if(EWR_STATE.shop.lifeSteal){EWR_STATE.healFraction=(EWR_STATE.healFraction||0)+0.33;if(EWR_STATE.healFraction>=1.0){EWR_STATE.healFraction-=1.0;EWR_STATE.health[0]=Math.min(EWR_STATE.health[0]+1,EWR_STATE.maxHealth[0]);spawnExplosion(ep.x,ep.y-20,0xff0088,0.5);}}
      if(boss.hp<=0){this._killBoss23();return;}
    }
  }

  // Phase transitions
  if(boss.dieT<0){
    if(boss.phase===1&&boss.hp<=18){
      boss.phase=2; boss.vx=es.facing>0?-160:160;
      boss.shotInterval=1800; boss.spawnTimer=0;
      this.phaseTxt.setText('PHASE 2').setAlpha(1);
      this.time.delayedCall(1200,function(){self.phaseTxt.setAlpha(0);});
      this.cameras.main.shake(300,0.022);
      spawnExplosion(boss.x,boss.y-30,0xff00ff,3.0);
    }
    if(boss.phase===2&&boss.hp<=9){
      boss.phase=3; boss.vx=es.facing>0?-200:200;
      boss.shotInterval=1200; boss.spawnTimer=0;
      this.phaseTxt.setText('PHASE 3\nBULLET HELL').setAlpha(1);
      this.time.delayedCall(1500,function(){self.phaseTxt.setAlpha(0);});
      this.cameras.main.shake(500,0.03);
      spawnExplosion(boss.x,boss.y-30,0xff0000,4.0);
    }
  }

  // Boss update
  if(boss.dieT<0){
    boss.bT+=delta;
    if(boss.hitFlash>0) boss.hitFlash-=delta;
    boss.rotAngle+=delta*0.0018; // slow rotation for bullet hell

    // Phase 3: random jumps
    if(boss.phase===3){
      boss._jumpT=(boss._jumpT||0)+delta;
      if(boss._jumpT>3000&&boss.grounded){boss._jumpT=0;boss.vy=-440;}
    }

    // Boss physics
    this._physBoss23(boss,delta,dt);

    // Boss facing Ed
    boss.vx=boss.phase===3?200:boss.phase===2?160:120;
    if(boss.x>ep.x) boss.vx=-boss.vx;

    // Boss shoot
    boss.shotT+=delta;
    if(boss.shotT>=boss.shotInterval){
      boss.shotT=0;
      var dx=ep.x-boss.x, dy=(ep.y-30)-(boss.y-30);
      var dist=Math.sqrt(dx*dx+dy*dy)||1;
      if(boss.phase===1){
        // Single aimed shot
        boss.projectiles.push({x:boss.x,y:boss.y-30,vx:(dx/dist)*240,vy:(dy/dist)*240,life:2.0});
        SOUND.blast&&SOUND.blast();
      } else if(boss.phase===2){
        // 3-way fan
        var ang=Math.atan2(dy,dx);
        for(var f=-1;f<=1;f++){
          var fa=ang+f*0.35;
          boss.projectiles.push({x:boss.x,y:boss.y-30,vx:Math.cos(fa)*260,vy:Math.sin(fa)*260,life:2.0});
        }
        SOUND.blast&&SOUND.blast();
      } else {
        // Phase 3: rotating 8-way bullet hell
        for(var ai=0;ai<8;ai++){
          var a=boss.rotAngle+(ai/8)*Math.PI*2;
          boss.projectiles.push({x:boss.x,y:boss.y-30,vx:Math.cos(a)*280,vy:Math.sin(a)*280,life:2.5});
        }
        SOUND.blast&&SOUND.blast();
      }
    }

    // Minion spawning (phase 2+)
    if(boss.phase>=2){
      var mSpawnInterval=boss.phase===3?6000:8000;
      boss.spawnTimer=(boss.spawnTimer||0)+delta;
      if(boss.spawnTimer>=mSpawnInterval){
        boss.spawnTimer=0;
        var spawnSide=boss.x>480?1:-1;
        boss.minions.push({x:spawnSide<0?900:60,y:450,type:'ghost',baseY:320,
          dir:spawnSide,spd:55,hp:2,pMin:30,pMax:930,
          dieT:-1,squishT:0,bT:0,bAmt:0,parts:[]});
      }
    }

    // Boss contact damage
    if(es.hurtTimer<=0&&Math.abs(ep.x-boss.x)<42&&Math.abs(ep.y-boss.y)<52){
      EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
      es.hurtTimer=1200; SOUND.hurt&&SOUND.hurt(); this.cameras.main.shake(250,0.014);
      ep.vx=-es.facing*260; ep.vy=-240;
      if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
    }

    // Projectile hits Ed
    for(var pi=boss.projectiles.length-1;pi>=0;pi--){
      var prj=boss.projectiles[pi];
      prj.x+=prj.vx*dt; prj.y+=prj.vy*dt; prj.life-=delta*0.001;
      if(prj.life<=0||prj.x<0||prj.x>960||prj.y<0||prj.y>600){boss.projectiles.splice(pi,1);continue;}
      if(es.hurtTimer<=0&&Math.abs(prj.x-ep.x)<16&&Math.abs(prj.y-ep.y)<16){
        EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        es.hurtTimer=1200; SOUND.hurt&&SOUND.hurt(); this.cameras.main.shake(200,0.012);
        ep.vx=-prj.vx*0.3; ep.vy=-160;
        boss.projectiles.splice(pi,1);
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
    }

    // Minion update
    for(var mni=boss.minions.length-1;mni>=0;mni--){
      var mn=boss.minions[mni];
      if(mn.dieT>=0){mn.dieT+=delta; if(mn.dieT>600) boss.minions.splice(mni,1); continue;}
      mn.bT+=delta; mn.x+=mn.dir*mn.spd*dt;
      mn.y=(mn.baseY||320)+Math.sin(mn.bT*0.003)*22;
      if(mn.x<mn.pMin){mn.x=mn.pMin;mn.dir=1;} if(mn.x>mn.pMax){mn.x=mn.pMax;mn.dir=-1;}
      // Punch/kick hits minion
      if(es.punchActive&&mn.dieT<0){
        var hxm=ep.x+es.facing*56;
        if(Math.abs(hxm-mn.x)<52&&Math.abs(ep.y-mn.y)<36){
          mn.hp--; spawnExplosion(mn.x,mn.y,0xffd60a,0.8);
          if(mn.hp<=0){mn.dieT=0;mn.squishT=0;EWR_STATE.aloe+=ALOE.ghostDeath;}
        }
      }
      if(es.kickActive&&mn.dieT<0){
        var kxm=ep.x+es.facing*ED_MOVE.kickRange;
        if(Math.abs(kxm-mn.x)<65&&Math.abs(ep.y-mn.y)<36){
          mn.hp-=2; spawnExplosion(mn.x,mn.y,0xff6b35,1.0);
          if(mn.hp<=0){mn.dieT=0;mn.squishT=0;EWR_STATE.aloe+=ALOE.ghostDeath;}
        }
      }
      // Minion contact damage
      if(es.hurtTimer<=0&&mn.dieT<0&&Math.abs(ep.x-mn.x)<26&&Math.abs(ep.y-mn.y)<30){
        EWR_STATE.health[0]--; EWR_STATE.combo.streak=0; EWR_STATE.combo.mult=1;
        es.hurtTimer=1200; SOUND.hurt&&SOUND.hurt();
        ep.vx=-es.facing*190; ep.vy=-210;
        if(EWR_STATE.health[0]<=0){this._triggerDeath();return;}
      }
    }
  } else {
    boss.dieT+=delta;
  }

  // Particles
  es.smokeT+=delta;
  if(es.smokeT>950){es.smokeT=0;spawnSmoke(ep.x+es.facing*14,ep.y-25);}
  updateSmoke(); updateExplosions(); updateFire();

  // ── Draw ──
  var mg=this.mainG; mg.clear();
  // Ed
  this._drawEd23(mg,ep,es,this.levelT);
  // Ed punch arc
  if(es.punchActive){
    mg.fillStyle(0xffd60a,0.5);
    mg.fillCircle(ep.x+es.facing*46,ep.y-20,16);
  }

  var bg2=this.bossG; bg2.clear();
  // Boss
  this._drawBoss23(bg2,boss);
  // Minions
  for(var di=0;di<boss.minions.length;di++){
    if(boss.minions[di].dieT<0) Level11Scene.prototype._drawMochi.call(this,bg2,boss.minions[di]);
  }

  var pg=this.projG; pg.clear();
  // Projectiles
  for(var qi=0;qi<boss.projectiles.length;qi++){
    var qp=boss.projectiles[qi];
    pg.fillStyle(boss.phase===3?0xff0066:0x00ffcc,0.9);
    pg.fillCircle(qp.x,qp.y,6);
    pg.fillStyle(boss.phase===3?0xff6666:0x88ffee,0.4);
    pg.fillCircle(qp.x,qp.y,10);
  }

  // Particle graphics
  var pg2=this.particleG; pg2.clear();
  drawExplosions(pg2); drawFire(pg2);
  for(var sp2=0;sp2<SMOKE_POOL.length;sp2++){var sp2p=SMOKE_POOL[sp2];pg2.fillStyle(0xaaaaaa,sp2p.life*0.3);pg2.fillCircle(sp2p.x,sp2p.y,sp2p.r);}

  // HUD
  var hg=this.hudG; hg.clear();
  // Health bar
  var hpFrac2=EWR_STATE.health[0]/EWR_STATE.maxHealth[0];
  hg.fillStyle(0x333333,1); hg.fillRect(10,8,120,10);
  hg.fillStyle(0x00ff88,1); hg.fillRect(10,8,120*hpFrac2,10);
  hg.lineStyle(1,0xffffff,0.4); hg.strokeRect(10,8,120,10);
  this.bossHpTxt.setText('HP:'+EWR_STATE.health[0]+'  ALOE:'+EWR_STATE.aloe+'  NEON KING HP:'+Math.max(0,boss.hp));
};

Level23Scene.prototype._killBoss23 = function(){
  this.boss.dieT=0;
  this.cameras.main.shake(600,0.035);
  spawnExplosion(this.boss.x,this.boss.y-30,0xff00ff,5.0);
  spawnExplosion(this.boss.x+30,this.boss.y-10,0x00ffcc,3.0);
  spawnExplosion(this.boss.x-30,this.boss.y-10,0xff0066,3.0);
  SOUND.blast&&SOUND.blast();
  EWR_STATE.aloe+=this.aloeEarned;
  this.time.delayedCall(2000, this._beatBoss23.bind(this));
};

// Share draw methods from Level11Scene prototype
Level23Scene.prototype._spawnMochiParts = Level11Scene.prototype._spawnMochiParts;


var Level24Scene = createLevelScene({
  key:'Level24', LW:6400, beatX:6385, beatKey:'2-4', checkptX:3200,
  aloeReward:ALOE.beat24, returnScene:'WorldMap2',
  title:'2-4  THE CAT CIG PARADE', intro:'THE PARADE HAS BEGUN',
  plats:[
    [120,400,110,18],[300,360,80,18],[500,430,70,18],[700,380,100,18],[900,340,80,18],
    [1080,420,90,18],[1260,460,60,18],[1440,390,80,18],[1620,350,100,18],
    [1800,430,80,18],[1980,370,90,18],[2160,440,70,18],[2340,400,100,18],
    [2520,360,80,18],[2680,430,90,18],[2840,380,70,18],[3000,340,80,18],
    [3160,420,100,18],[3320,460,70,18],[3480,370,90,18],[3640,410,80,18],
    [3800,350,100,18],[3960,430,80,18],[4120,380,90,18],[4280,440,70,18],
    [4440,360,100,18],[4600,420,80,18],[4760,380,90,18],[4920,340,70,18],
    [5080,410,100,18],[5240,380,80,18],[5440,350,90,18],[5600,410,80,18],
    [5800,370,100,18],[6000,400,90,18]
  ],
  catX:[180,360,560,740,950,1130,1320,1520,1700,1880,2060,2240,2440,2610,2760,
        2920,3090,3260,3440,3620,3780,3960,4160,4360,4560,4760,4960,5160],
  mochis:[
    {x:350,type:'rasta',spd:55,hp:3,pMin:200,pMax:600},
    {x:700,type:'ghost',baseY:310,spd:62,hp:2,pMin:500,pMax:900},
    {x:1000,type:'bomber',spd:28,hp:5,pMin:850,pMax:1250},
    {x:1400,type:'rasta',spd:55,hp:3,pMin:1200,pMax:1700},
    {x:1800,type:'ghost',baseY:320,spd:60,hp:2,pMin:1600,pMax:2100},
    {x:2200,type:'bomber',spd:26,hp:5,pMin:2000,pMax:2500},
    {x:2600,type:'rasta',spd:58,hp:3,pMin:2400,pMax:2900},
    {x:3000,type:'ghost',baseY:300,spd:65,hp:2,pMin:2800,pMax:3300},
    {x:3400,type:'bomber',spd:30,hp:5,pMin:3100,pMax:3600},
    {x:3800,type:'rasta',spd:55,hp:3,pMin:3600,pMax:4100},
    {x:4200,type:'ghost',baseY:315,spd:60,hp:2,pMin:4000,pMax:4500},
    {x:4600,type:'bomber',spd:28,hp:5,pMin:4300,pMax:4800},
    {x:5000,type:'rasta',spd:58,hp:3,pMin:4800,pMax:5300},
    {x:5300,type:'ghost',baseY:305,spd:62,hp:2,pMin:5100,pMax:5600},
    {x:5600,type:'bomber',spd:26,hp:5,pMin:5400,pMax:5900},
    {x:5800,type:'rasta',spd:55,hp:3,pMin:5600,pMax:6100},
    {x:6000,type:'ghost',baseY:310,spd:60,hp:2,pMin:5800,pMax:6300},
    {x:6150,type:'bomber',spd:28,hp:5,pMin:5950,pMax:6380}
  ],
  pickups:[
    [600,280],[1200,290],[1800,270],[2400,280],
    [3000,270],[3600,285],[4200,275],[4800,280],
    [5400,265],[6000,275]
  ]
});

var config = {
  type: Phaser.CANVAS,
  width: 960,
  height: 540,
  backgroundColor: '#0a0014',
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  input: {
    gamepad: true,
    activePointers: 4
  },
  scene: [
    BootScene,
    TitleScene,
    WorldMapScene,
    Level11Scene,
    Level12Scene,
    Level13Scene,
    Level14Scene,
    Level15Scene,
    LevelVoidScene,
    WorldMap2Scene,
    Level21Scene,
    Level22Scene,
    Level23Scene,
    Level24Scene
  ]
};
new Phaser.Game(config);
</script>
</body>
</html>
